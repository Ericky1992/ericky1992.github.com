<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>菜鸟学习HOOK | Ericky1992</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="The darkness is no darkness with thee.">
  
  
    <meta name="description" content="前言自己从高中那时对黑客比较感兴趣，那时候去过很多论坛学所谓的“黑客技术”。同时也经常在一些QQ群，论坛里混，但见效甚微。因为我很喜欢玩游戏，上大学后，同学们都发疯似的玩一款游戏—三国杀，现在玩的人已经很少了，被某公司抄袭后垄断了。由于当时学业繁重，然后自己又爱面子，所以在想如何学业不落下的同时游戏等级也能比别人高，上网找到了一款三国杀的刷分软件。兴高采烈得打开准备刷分，用了一天之后就不能用了，3">
  
  <meta name="description" content="前言自己从高中那时对黑客比较感兴趣，那时候去过很多论坛学所谓的“黑客技术”。同时也经常在一些QQ群，论坛里混，但见效甚微。因为我很喜欢玩游戏，上大学后，同学们都发疯似的玩一款游戏—三国杀，现在玩的人已经很少了，被某公司抄袭后垄断了。由于当时学业繁重，然后自己又爱面子，所以在想如何学业不落下的同时游戏等级也能比别人高，上网找到了一款三国杀的刷分软件。兴高采烈得打开准备刷分，用了一天之后就不能用了，3">
<meta name="keywords" content="win32 Windows 破解 安全 vc++">
<meta property="og:type" content="article">
<meta property="og:title" content="菜鸟学习HOOK">
<meta property="og:url" content="http://yoursite.com/2014/10/27/菜鸟学习HOOK/index.html">
<meta property="og:site_name" content="Ericky1992">
<meta property="og:description" content="前言自己从高中那时对黑客比较感兴趣，那时候去过很多论坛学所谓的“黑客技术”。同时也经常在一些QQ群，论坛里混，但见效甚微。因为我很喜欢玩游戏，上大学后，同学们都发疯似的玩一款游戏—三国杀，现在玩的人已经很少了，被某公司抄袭后垄断了。由于当时学业繁重，然后自己又爱面子，所以在想如何学业不落下的同时游戏等级也能比别人高，上网找到了一款三国杀的刷分软件。兴高采烈得打开准备刷分，用了一天之后就不能用了，3">
<meta property="og:image" content="http://img.blog.csdn.net/20150211100607991?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast">
<meta property="og:image" content="http://img.blog.csdn.net/20150211100637754?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast">
<meta property="og:image" content="http://img.blog.csdn.net/20150211100725599?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast">
<meta property="og:image" content="http://img.blog.csdn.net/20150211100813681?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast">
<meta property="og:updated_time" content="2017-08-28T12:54:42.869Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="菜鸟学习HOOK">
<meta name="twitter:description" content="前言自己从高中那时对黑客比较感兴趣，那时候去过很多论坛学所谓的“黑客技术”。同时也经常在一些QQ群，论坛里混，但见效甚微。因为我很喜欢玩游戏，上大学后，同学们都发疯似的玩一款游戏—三国杀，现在玩的人已经很少了，被某公司抄袭后垄断了。由于当时学业繁重，然后自己又爱面子，所以在想如何学业不落下的同时游戏等级也能比别人高，上网找到了一款三国杀的刷分软件。兴高采烈得打开准备刷分，用了一天之后就不能用了，3">
<meta name="twitter:image" content="http://img.blog.csdn.net/20150211100607991?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast">
  
  
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">Ericky1992</a></h1>
    <p><a href="/">pursue ceaselessly</a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/">About</a></li>
      
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content"><article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/10/27/菜鸟学习HOOK/">
  <time datetime="2014-10-27T10:30:00.000Z">
    2014-10-27
  </time>
</a>
    
    
  
    <h1 class="title">菜鸟学习HOOK</h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>自己从高中那时对黑客比较感兴趣，那时候去过很多论坛学所谓的“黑客技术”。同时也经常在一些QQ群，论坛里混，但见效甚微。<br>因为我很喜欢玩游戏，上大学后，同学们都发疯似的玩一款游戏—三国杀，现在玩的人已经很少了，被某公司抄袭后垄断了。由于当时学业繁重，然后自己又爱面子，所以在想如何学业不落下的同时游戏等级也能比别人高，上网找到了一款三国杀的刷分软件。兴高采烈得打开准备刷分，用了一天之后就不能用了，30元一个月的收费标准，穷学生哪能舍得啊？于是想找人破解，但转念一想，谁会帮你破解呢？还是自己来吧~自己动手，丰衣足食。上网+图书馆疯狂找资料，花了一个周末，把这个软件KO了，当时是高兴死了。那种成就感和兴奋感恐怕也只有亲身试过的人才知道。很快就刷到了150级了，比整天玩游戏的同学等级还要高，在满足了我虚荣心的同时也带我走向了逆向之门，或许这就是一种缘分吧。<br>好了，背景就不多说了。今天和大家一起学习一下C++中的HOOK API技术。相信大家都知道这是逆向PJ中的一个特别重要也是实用的技术。(<em>^__^</em>) </p>
<h2 id="一、-Hook介绍"><a href="#一、-Hook介绍" class="headerlink" title="一、  Hook介绍"></a>一、  Hook介绍</h2><p>钩子(Hook)，是Windows消息处理机制的一个平台,应用程序可以在上面设置子程以监视指定窗口的某种消息，而且所监视的窗口可以是其他进程所创建的。当消息到达后，在目标窗口处理函数之前处理它。钩子机制允许应用程序截获处理window消息或特定事件。<br> 我们知道Windows系统API函数都是被封装到DLL中，在某个应用程序要调用一个API函数的时候，如果这个函数所在的DLL没有被加载到本进程中则加载它，然后保存当前环境（各个寄存器和函数调用完后的返回地址等）。接着程序会跳转到这个API函数的入口地址去执行此处的指令。由此看来，我们想在调用真正的API之前先调用我们的函数，那么可以修改这个API函数的入口处的代码，使他先跳转到我们的函数地址，然后在我们的函数最后再调用原来的API函数。<br>简单来说HOOK API 可以理解成对程序将要执行系统函数的一个拦截， 拦截后执行自己写的代码以达到完成某种特定的目的，再恢复程序继续执行，很多PJ中的Patch 机器码，盗号木马等都是用这个方法。</p>
<h2 id="二、-Hook-API实战"><a href="#二、-Hook-API实战" class="headerlink" title="二、  Hook API实战"></a>二、  Hook API实战</h2><p>OK，既然我们需要实现一个这样的一个HOOK。当然需要两样东西，一是目标程序，一是我们的代码。</p>
<ol>
<li>程序：<br>新建一个dll工程文件目录如图：<br>附件 93152<br>我们自己新建一个Add.def文件，然后添加到工程中即可，如图我是添加到Source Files里。<br>跟exe有个main或者WinMain入口函数一样，DLL也有它自己的一个入口函数，就是DllMain。<br>我们打开dllmain.cpp  代码如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// dllmain.cpp : Defines the entry point for the DLL application.  </div><div class="line">#include &quot;stdafx.h&quot;  </div><div class="line">  </div><div class="line">int WINAPI add(int a, int b)  </div><div class="line">&#123;  </div><div class="line">  return a + b;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">BOOL APIENTRY DllMain(HANDLE hModule,  </div><div class="line">  DWORD  ul_reason_for_call,  </div><div class="line">  LPVOID lpReserved  </div><div class="line">  )  </div><div class="line">&#123;  </div><div class="line">  return TRUE;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>DEF文件是模块定义文件，模块定义 (.def) 文件为链接器提供有关被链接程序的导出、属性及其他方面的信息。生成 DLL 时，.def 文件最有用。由于存在可代替模块定义语句使用的链接器选项，通常不需要 .def 文件。也可以将 <strong>declspec(dllexport) 用作指定导出函数的手段。在链接器阶段可以使用 /DEF（指定模块定义文件）链接器选项调用 .def 文件。如果生成的 .exe 文件没有导出，使用 .def 文件将使输出文件较大并降低加载速度。<br>  在VC++中，生成DLL可以不使用.def文件。只需要在VC++的函数定义前要加</strong>declspec(dllexport)修饰就可以了。但是使用<strong>declspec(dllexport)和使用.def文件是有区别的。如果DLL是提供给VC++用户使用的，你只需要把编译DLL时产生的.lib提供给用户，它可以很轻松地调用你的DLL。但是如果你的DLL是供其他程序如VB、delphi,以及.NET用户使用的，那么会产生一个小麻烦。因为VC++对于</strong>declspec(dllexport)声明的函数会进行名称转换，如下面的函数：<br><strong>declspec(dllexport) int </strong>stdcallIsWinNT()<br>会转换为IsWinNT@0，这样你在VB中必须这样声明：<br>Declare Function IsWinNT Lib “my.dll” Alias “IsWinNT@0” () As Long<br>@的后面的数由于参数类型不同而可能不同。这显然不太方便。所以如果要想避免这种转换，就要使用.def文件方式。<br>EXPORTS后面的数可以不给，系统会自动分配一个数。对于VB、PB、Delphi用户，通常使用按名称进行调用的方式，这个数关系不大，但是对于使用.lib链接的VC程序来说，不是按名称进行调用，而是按照这个数进行调用的，所以最好给出。<br>  .def 文件中的第一条 LIBRARY 语句不是必须的，但LIBRARY 语句后面的 DLL 的名称必须正确，即与生成的动态链接库的名称必须匹配。此语句将 .def 文件标识为属于 DLL。链接器将此名称放到 DLL 的导入库中。<br>EXPORTS 语句列出名称，可能的话还会列出 DLL 导出函数的序号值。通过在函数名的后面加上 @ 符和一个数字，给函数分配序号值。当指定序号值时，序号值的范围必须是从 1 到 N，其中 N 是 DLL 导出函数的个数。<br>LIBRARY BTREE<br>EXPORTS<br>Insert @1<br>Delete @2<br>Member @3<br>Min @4<br>如果使用 MFC DLL 向导创建 MFC DLL，则向导将为您创建主干 .def 文件并将其自动添加到项目中。添加要导出到此文件的函数名。对于非 MFC DLL，必须亲自创建 .def 文件并将其添加到项目中。<br>如果导出 C++ 文件中的函数，必须将修饰名放到 .def 文件中，或者通过使用外部“C”定义具有标准 C 链接的导出函数。如果需要将修饰名放到 .def 文件中，则可以通过使用 DUMPBIN 工具或 /MAP 链接器选项来获取修饰名。请注意，编译器产生的修饰名是编译器特定的。如果将 Visual C++ 编译器产生的修饰名放到 .def 文件中，则链接到 DLL 的应用程序必须也是用相同版本的 Visual C++ 生成的，这样调用应用程序中的修饰名才能与 DLL 的 .def 文件中的导出名相匹配。<br>因此def文件代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">LIBRARY  Add  </div><div class="line">DESCRIPTION &quot;ADD LA&quot;  </div><div class="line">EXPORTS  </div><div class="line">add  @1;</div></pre></td></tr></table></figure></p>
<p>在如图位置可以检验是否导入了：<br><img src="http://img.blog.csdn.net/20150211100607991?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>由此，一个简单的dll我们就完成了。<br>下面用MFC写一个程序来调用我们的dll。<br>还是新建一个工程,目录如下<br><img src="http://img.blog.csdn.net/20150211100637754?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>MFC的.Cpp中主要代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">void CMFCApplication5Dlg::OnBnClickedButton1()  </div><div class="line">&#123;  </div><div class="line">  // TODO: Add your control notification handler code here  </div><div class="line">  </div><div class="line">    HINSTANCE hAddDll = NULL;  </div><div class="line">    typedef int (WINAPI*AddProc)(int a, int b);//函数原型定义    </div><div class="line">    AddProc add;  </div><div class="line">    if (hAddDll == NULL)  </div><div class="line">    &#123;  </div><div class="line">      hAddDll = ::LoadLibrary(_T(&quot;Win32DLL.dll&quot;));//加载dll    </div><div class="line">    &#125;  </div><div class="line">    add = (AddProc)::GetProcAddress(hAddDll, &quot;add&quot;);//获取函数add地址    </div><div class="line">  </div><div class="line">    int a = 123;  </div><div class="line">    int b = 456;  </div><div class="line">    int c = add(a, b);   </div><div class="line">    CString tem;  </div><div class="line">    tem.Format(_T(&quot;%d+%d=%d&quot;), a, b, c);  </div><div class="line">    AfxMessageBox(tem);  </div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>效果如图：出现这个说明你成功了:<br><img src="http://img.blog.csdn.net/20150211100725599?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>一个调用dll中加法函数的MFC程序我们就完成了，下面就需要自己写一个dll，让程序执行我们的代码。<br>新建一个MFC的 dll工程，工程名为Hook，然后我们在Hook.cpp文件里面编写的代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div></pre></td><td class="code"><pre><div class="line">// Hook.cpp : Defines the initialization routines for the DLL.  </div><div class="line">#include &quot;stdafx.h&quot;  </div><div class="line">#include &quot;Hook.h&quot;  </div><div class="line">  </div><div class="line">#ifdef _DEBUG  </div><div class="line">#define new DEBUG_NEW  </div><div class="line">#endif  </div><div class="line">//变量定义    </div><div class="line">  </div><div class="line">#pragma data_seg(&quot;SHARED&quot;) //不同Instance共享的该变量     </div><div class="line">static HHOOK  hhk = NULL; //鼠标钩子句柄    </div><div class="line">static HINSTANCE hinst = NULL; //本dll的实例句柄 (hook.dll)    </div><div class="line">#pragma data_seg()    </div><div class="line">#pragma comment(linker, &quot;/section:SHARED,rws&quot;)    </div><div class="line">//以上的变量为共享    </div><div class="line">  </div><div class="line">CString temp; //用于显示错误的临时变量    </div><div class="line">bool bHook = false; //是否Hook了函数    </div><div class="line">bool m_bInjected = false; //是否对API进行了Hook    </div><div class="line">BYTE OldCode[5]; //原程序API入口代码    </div><div class="line">BYTE NewCode[5]; //新跳转的API代码 (jmp xxxx)    </div><div class="line">typedef int (WINAPI*AddProc)(int a, int b);//add.dll中的add函数定义    </div><div class="line">AddProc add; //add.dll中的add函数    </div><div class="line">HANDLE hProcess = NULL; //所处进程的句柄    </div><div class="line">FARPROC pfadd;  //指向add函数的远指针    </div><div class="line">DWORD dwPid;  //所处进程ID    </div><div class="line">//end of 变量定义    </div><div class="line">// CHookApp  </div><div class="line">  </div><div class="line">BEGIN_MESSAGE_MAP(CHookApp, CWinApp)  </div><div class="line">END_MESSAGE_MAP()  </div><div class="line">  </div><div class="line">//鼠标钩子过程，什么事情也不做，目的是注入dll到程序中    </div><div class="line">LRESULT CALLBACK MouseProc(int nCode, WPARAM wParam, LPARAM lParam)  </div><div class="line">&#123;  </div><div class="line">  return CallNextHookEx(hhk, nCode, wParam, lParam);  </div><div class="line">&#125;  </div><div class="line">//开启钩子的函数    </div><div class="line">void HookOn()  </div><div class="line">&#123;  </div><div class="line">  ASSERT(hProcess != NULL);  </div><div class="line">  </div><div class="line">  DWORD dwTemp = 0;  </div><div class="line">  DWORD dwOldProtect;  </div><div class="line">  </div><div class="line">  //将内存保护模式改为可写,老模式保存入dwOldProtect    </div><div class="line">  VirtualProtectEx(hProcess, pfadd, 5, PAGE_READWRITE, &amp;dwOldProtect);  </div><div class="line">  //将所属进程中add()的前5个字节改为Jmp Myadd     </div><div class="line">  WriteProcessMemory(hProcess, pfadd, NewCode, 5, 0);  </div><div class="line">  //将内存保护模式改回为dwOldProtect    </div><div class="line">  VirtualProtectEx(hProcess, pfadd, 5, dwOldProtect, &amp;dwTemp);  </div><div class="line">  </div><div class="line">  bHook = true;  </div><div class="line">&#125;  </div><div class="line">//关闭钩子的函数    </div><div class="line">void HookOff()//将所属进程中add()的入口代码恢复    </div><div class="line">&#123;  </div><div class="line">  ASSERT(hProcess != NULL);  </div><div class="line">  </div><div class="line">  DWORD dwTemp = 0;  </div><div class="line">  DWORD dwOldProtect;  </div><div class="line">  </div><div class="line">  VirtualProtectEx(hProcess, pfadd, 5, PAGE_READWRITE, &amp;dwOldProtect);  </div><div class="line">  WriteProcessMemory(hProcess, pfadd, OldCode, 5, 0);  </div><div class="line">  VirtualProtectEx(hProcess, pfadd, 5, dwOldProtect, &amp;dwTemp);  </div><div class="line">  bHook = false;  </div><div class="line">&#125;  </div><div class="line">//然后，写我们自己的Myadd()函数    </div><div class="line">int WINAPI Myadd(int a, int b)  </div><div class="line">&#123;  </div><div class="line">  //截获了对add()的调用，我们给a,b都加上一定的数  </div><div class="line">  a = a + 987;  </div><div class="line">  b = b + 654;  </div><div class="line">  </div><div class="line">  HookOff();//关掉Myadd()钩子防止死循环    </div><div class="line">  </div><div class="line">  int ret;  </div><div class="line">  ret = add(a, b);  </div><div class="line">  </div><div class="line">  HookOn();//开启Myadd()钩子    </div><div class="line">  </div><div class="line">  return ret;  </div><div class="line">&#125;  </div><div class="line">//好，最重要的HOOK函数：   </div><div class="line">void Inject()  </div><div class="line">&#123;  </div><div class="line">  </div><div class="line">  if (m_bInjected == false)  </div><div class="line">  &#123; //保证只调用1次    </div><div class="line">    m_bInjected = true;  </div><div class="line">  </div><div class="line">    //获取add.dll中的add()函数    </div><div class="line">    HMODULE hmod = ::LoadLibrary(_T(&quot;Win32DLL.dll&quot;));  </div><div class="line">    add = (AddProc)::GetProcAddress(hmod, &quot;add&quot;);  </div><div class="line">    pfadd = (FARPROC)add;  </div><div class="line">  </div><div class="line">    if (pfadd == NULL)  </div><div class="line">    &#123;  </div><div class="line">      AfxMessageBox(L&quot;cannot locate add()&quot;);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    // 将add()中的入口代码保存入OldCode[]    </div><div class="line">    _asm  </div><div class="line">    &#123;  </div><div class="line">      lea edi, OldCode  </div><div class="line">        mov esi, pfadd  </div><div class="line">        cld  </div><div class="line">        movsd  </div><div class="line">        movsb  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    NewCode[0] = 0xe9;//实际上0xe9就相当于jmp指令    </div><div class="line">    //获取Myadd()的相对地址    </div><div class="line">    _asm  </div><div class="line">    &#123;  </div><div class="line">      lea eax, Myadd  </div><div class="line">        mov ebx, pfadd  </div><div class="line">        sub eax, ebx  </div><div class="line">        sub eax, 5  </div><div class="line">        mov dword ptr[NewCode + 1], eax  </div><div class="line">    &#125;  </div><div class="line">    //填充完毕，现在NewCode[]里的指令相当于Jmp Myadd    </div><div class="line">    HookOn(); //可以开启钩子了    </div><div class="line">  &#125;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">  </div><div class="line">CHookApp::CHookApp()  </div><div class="line">&#123;  </div><div class="line">    </div><div class="line">&#125;  </div><div class="line">CHookApp theapp;  </div><div class="line">  </div><div class="line">  </div><div class="line">//鼠标钩子安装函数:    </div><div class="line">BOOL InstallHook()  </div><div class="line">&#123;  </div><div class="line">  </div><div class="line">  hhk = ::SetWindowsHookEx(WH_MOUSE, MouseProc, hinst, 0);  </div><div class="line">  </div><div class="line">  return true;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">//卸载鼠标钩子函数    </div><div class="line">void UninstallHook()  </div><div class="line">&#123;  </div><div class="line">  ::UnhookWindowsHookEx(hhk);  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">  </div><div class="line">  </div><div class="line">//在dll实例化中获得一些参数    </div><div class="line">BOOL CHookApp::InitInstance()  </div><div class="line">&#123;  </div><div class="line">  CWinApp::InitInstance();  </div><div class="line">  </div><div class="line">  //获得dll 实例，进程句柄    </div><div class="line">  hinst = ::AfxGetInstanceHandle();  </div><div class="line">  DWORD dwPid = ::GetCurrentProcessId();  </div><div class="line">  hProcess = OpenProcess(PROCESS_ALL_ACCESS, 0, dwPid);  </div><div class="line">  //调用注射函数    </div><div class="line">  Inject();  </div><div class="line">  return TRUE;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着需要配置一下DEF文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">; Hook.def : Declares the module parameters for the DLL.  </div><div class="line">LIBRARY &quot;HOOK&quot;  </div><div class="line">EXPORTS  </div><div class="line">InstallHook    </div><div class="line">UninstallHook</div></pre></td></tr></table></figure></p>
<p>最后HOOK成功的效果如图所示：<br><img src="http://img.blog.csdn.net/20150211100813681?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>值得一提的是很多人都是改API开头的5个字节，但是现在很多杀毒软件用这样的方法检查API是否被HOOK，或其他病毒木马在你之后又改了前5个字节，这样就会互相覆盖，最后一个HOOK API的操作才是有效的。挂钩的方法很多，这里只是最基础的一种。希望大家多多补充。多多指正。<br>了解好以下的问题能够更好的提升自己的HOOK水平:<br>1.CPU指令长度问题，在32位系统里，一条JMP/CALL指令的长度是5个字节，因此你只有替换API里超过5个字节长度的机器码（或者替换几条指令长度加起来是5字节的指令），否则会影响被更改的小于5个字节的机器码后面的数条指令，甚至程序流程会被打乱，产生不可预料的后果；<br>2.参数问题，为了访问原API的参数，你要通过EBP或ESP来引用参数，因此你要非常清楚你的HOOK代码里此时的EBP/ESP的值是多少；<br>3.时机的问题，有些HOOK必须在API的开头，有些必须在API的尾部，比如HOOK CreateFilaA()，如果你在API尾部HOOK API，那么此时你就不能写文件，甚至不能访问文件；HOOK RECV()，如果你在API头HOOK，此时还没有收到数据，你就去查看RECV()的接收缓冲区，里面当然没有你想要的数据，必须等RECV()正常执行后，在RECV()的尾部HOOK，此时去查看RECV()的缓冲区，里面才有想要的数据；<br>4.上下文的问题，有些HOOK代码不能执行某些操作，否则会破坏原API的上下文，原API就失效了；<br>5.同步问题，在HOOK代码里尽量不使用全局变量，而使用局部变量，这样也是模块化程序的需要；<br>6.最后要注意的是，被替换的CPU指令的原有功能一定要在HOOK代码的某个地方模拟实现。</p>
<p>若有疏漏之处，欢迎各位大侠指正！<br> 2014.10.27 6：30 pm </p>

    
  </div>
  <footer>
    
      
  <div class="categories">
    <a class="categories-link" href="/categories/Windows/">Windows</a>
  </div>

      
  <div class="tags">
    <a class="tags-link" href="/tags/win32-Windows-破解-安全-vc/">win32 Windows 破解 安全 vc++</a>
  </div>

    
    <div class="clearfix"></div>
  </footer>
</article>

</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2017 <a href="/">The darkness is no darkness with thee.</a>
  
</div>
<div class="theme-copyright">

</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>

</body>
</html>