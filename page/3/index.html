<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>Ericky1992</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="The darkness is no darkness with thee.">
  
  
  <meta name="description" content="忘記妳是最痛苦的解藥">
<meta property="og:type" content="website">
<meta property="og:title" content="Ericky1992">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Ericky1992">
<meta property="og:description" content="忘記妳是最痛苦的解藥">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ericky1992">
<meta name="twitter:description" content="忘記妳是最痛苦的解藥">
  
  
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">Ericky1992</a></h1>
    <p><a href="/">pursue ceaselessly</a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/">About</a></li>
      
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content">




  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/12/09/Dexguard分析&钛备份破解/">
  <time datetime="2014-12-09T10:11:00.000Z">
    2014-12-09
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/12/09/Dexguard分析&钛备份破解/">Dexguard分析&amp;钛备份破解</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>钛备份，貌似是备份方向很火的一个软件（可能类似于win下的super recovery）。Claud说是加的Dexguard壳，由于本人是初学者，也没见过什么世面，更不懂得Dexguard是个什么东西了，就一股子蛮劲，结果不小心把钛备份干掉了，看来功夫不负有心人啊。以下写出心得和大家分享，互相学习进步。<br>菜鸟第一次分析，请大牛勿喷，会打击小菜的积极性的！</p>
<h2 id="一、APKtools反编译"><a href="#一、APKtools反编译" class="headerlink" title="一、APKtools反编译"></a>一、APKtools反编译</h2><p>可能是Dexguard壳子利用了apktools的bug吧，反正我是没有反编译成功。AndroidManifest.xml里所有不在<intent-filter>与</intent-filter>的元素key值都没有反编译出来。<br>如图所示：<br><img src="http://img.blog.csdn.net/20150323181153803?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>修复后如下：<br><img src="http://img.blog.csdn.net/20150323181200704?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>但是还是无法打包。用apktools还是打包失败：<br><img src="http://img.blog.csdn.net/20150323181255376?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>既然无法打包，很多方法就行不通了，log的方法也失效了，不过不要紧，反编译失败导致无法正常打包，那就用点原始的方法吧。不管那么多，先分析分析这个程序再说，程序分析透了，至少也算是对自身的一种提高，说干就干。（这个问题现在还没有解决，希望会的大牛告知一下，在下感激不尽。）</p>
<h2 id="二、逆向分析"><a href="#二、逆向分析" class="headerlink" title="二、逆向分析"></a>二、逆向分析</h2><p>虽然说打包是没搞定，但主要是因为xml文件apktools分析出错的原因，还好不影响我们亲爱的smali文件的反编译。JEB载入，（这里要感谢SCZ大神的无私奉献，虽然说好像保存功能用不了，但是已经非常感谢了）随便翻了一下，看见一个这个：<br><img src="http://img.blog.csdn.net/20150323181317450?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>我本来准备吐槽作者了，但是往后一翻，我觉得这个也不必怎么大惊小怪。因为对于第一次分析APK,发现如下的东西，我开始有点不淡定了。类名和函数的名称被加密成这样：<br><img src="http://img.blog.csdn.net/20150323181337683?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20150323181415817?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>不过不管它多么花，也要干掉它！<br>那就要开始定位关键地方，进行破解了。<br>2.1.关键定位<br>我目前知道的一共有2种方法可以成功定位到关键地方。<br>第一种方法：搜Strings.<br><img src="http://img.blog.csdn.net/20150323181541025?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>这是一种方法，当然可能搜到的不止一处，这就需要自己去甄别了。<br>第二种方法：这种方法在我之前的一篇学习笔记里也有讲到，里面的第四种方法，所谓的“遗留下的宝藏”。用到了DDMS 如图：<br><img src="http://img.blog.csdn.net/20150323181641467?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>OK，真幸运，直接定位到了fs中。Nice。<br>2.2log分析<br>既然发现了验证的类，那就不能放过。发现大部分字符串都被加密过了，我们就从log开始着手吧。找了几个log如下：<br><img src="http://img.blog.csdn.net/20150323181722948?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>发现了解密函数，把它Rename：<br><img src="http://img.blog.csdn.net/20150323181708106?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>解密函数如下：<br><img src="http://img.blog.csdn.net/20150323181756800?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>找到了解密函数，这就好办了，先把strings解密了再说，我写了一个Python脚本来解密encryptStrings。python脚本如下：<br>代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">#Author Ericky  </div><div class="line">import sys  </div><div class="line">import os  </div><div class="line">import time  </div><div class="line">from jeb.api import IScript  </div><div class="line">from jeb.api import EngineOption  </div><div class="line">from jeb.api.ui import View  </div><div class="line">from jeb.api.dex import Dex  </div><div class="line">from jeb.api.ast import Class, Field, Method, Call, Constant, StaticField, NewArray  </div><div class="line">encbytes = [69, 21, -111, -111, 14, -30, 5, -3, -10, -6, 9, -6, 6, 9, 60, -36,   </div><div class="line">                -45, -4, -1, -4, 4, -5, 83, -68, 1, -3, -6, 2, 68, -71, -4, -4, 6, 42, 25, 14, -30,   </div><div class="line">                5, -3, -10, -6, 9, -6, 6, 9, 60, -55, -12, -12, 2, 4, 2, -20, 10, -6, 6, 70, -71, -13,   </div><div class="line">                2, 1, 76, -68, 1, -3, -6, 2, 68, -71, -4, -4, 6, 68, -15, -1, -1, 14, -30, 5, -3, -10,   </div><div class="line">                -6, 9, -6, 6, 9, 60, -51, -20, -15, 2, 0, 0, -6, 13, 68, -74, -11, 82, -79, -2, -6,   </div><div class="line">                83, -87, 20, -12, 2, 4, 67, -66, -14, -12, 11, -3, -4, 12, 54, 14, -30, 5, -3, -10,   </div><div class="line">                -6, 9, -6, 6, 9, 60, -51, -20, -15, 2, 0, 0, -6, 13, 68, -88, 13, -4, -1, 75, -84, -2,   </div><div class="line">                10, -4, -1, 75, -83, 12, -9, 11, -9, -6, 77, -87, 20, -12, 2, 4, 67, -71, -10, -4, 81,   </div><div class="line">                14, -30, 5, -3, -10, -6, 9, -6, 6, 9, 60, -51, -20, -15, 2, 0, 0, -6, 13, 68, -74, -11,   </div><div class="line">                82, -84, -2, 10, -4, -1, 75, -87, 16, -14, -8, 88, -71, -13, 12, -15, 10, 57, 14, -30,   </div><div class="line">                5, -3, -10, -6, 9, -6, 6, 9, 60, -52, -15, -22, 12, -6, 6, 70, -68, 1, -3, -6, 2, 68,   </div><div class="line">                -71, -4, -4, 6, 42, 25, 14, -30, 5, -3, -10, -6, 9, -6, 6, 9, 60, -36, -31, -3, -6,   </div><div class="line">                2, 68, -87, 20, -12, 2, 4, 36, 30, -30, 28, 14, -30, 5, -3, -10, -6, 9, -6, 6, 9, 60,   </div><div class="line">                -51, -20, -15, 2, 0, 0, -6, 13, 68, -88, 13, -4, -1, 75, -67, -4, 68, -83, 12, -2, -13,   </div><div class="line">                12, -15, 10, 2, 0, 67, -67, -4, 1, 1, -21, 1, 13, 68, -80, -8, 16, -14, 81, -18, 1,   </div><div class="line">                -5, 0, 17, -80, 8, 69, -74, -12, 0, 82, -87, 20, -12, 2, 4, -6, -12, -6, 88, -69, -18,   </div><div class="line">                2, 16, -20, 10, -7, 0, 77, -74, -11, 82, -70, -8, 10, -16, -4, 13, 0, 53, 14, -30, 5,   </div><div class="line">                -3, -10, -6, 9, -6, 6, 9, 60, -47, -34, 78, -68, 1, -3, -6, 2, 68, -71, -4, -4, 6, 42,   </div><div class="line">                25, 14, -30, 5, -3, -10, -6, 9, -6, 6, 9, 60, -37, -34, -8, 6, -16, 10, -6, 6, 70, -79,   </div><div class="line">                -2, 0, 64, -74, 20, -12, 2, 4, 67, -68, 1, -3, -6, 2, 68, -71, -4, -4, 6, 42, 25]  </div><div class="line">  </div><div class="line">  </div><div class="line">class Mydecypt(IScript):  </div><div class="line">  </div><div class="line">  def run(self, jeb):  </div><div class="line">    self.jeb = jeb  </div><div class="line">    self.dex = self.jeb.getDex()  </div><div class="line">    self.cstbuilder = Constant.Builder(jeb)  </div><div class="line">  </div><div class="line">    self.csig = &apos;fs&apos;  </div><div class="line">    self.encbytes = encbytes  </div><div class="line">    self.mname_decrypt = None  </div><div class="line">  </div><div class="line">    r = jeb.decompileClass(self.csig)  </div><div class="line">    decrypted_string = self.decrypt(66, 26, 0) #Here enter your encrypt strings  </div><div class="line">    print &apos;  Decrypted string: %s&apos; % repr(decrypted_string)  </div><div class="line">  def decrypt(self, length, curChar, pos):  </div><div class="line">    length = 93 - length  </div><div class="line">    pos = pos * 2 + 91  </div><div class="line">    curChar = 378 - curChar  </div><div class="line">    r = &apos;&apos;  </div><div class="line">    for i in range(length):  </div><div class="line">      curChar +=1  </div><div class="line">      r += chr(pos &amp; 0xFF)  </div><div class="line">      if i &gt;= len(self.encbytes):  </div><div class="line">        break  </div><div class="line">      curEncodedChar = self.encbytes[curChar]  </div><div class="line">      pos = pos - curEncodedChar -1  </div><div class="line">    return r</div></pre></td></tr></table></figure></p>
<p>把字符串解密了，那就事半功倍了。具体的分析就比较简单了。分析解密后如下:<br>代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">private static final BigInteger 大整数;  </div><div class="line">    private static final byte[] 加密字符串;  </div><div class="line">    public static boolean 普通版开关;  </div><div class="line">    public static boolean 专业版开关;  </div><div class="line">    public static hG HG类;  </div><div class="line">    private static final String 字符串常量;  </div><div class="line">    private static int 常数;  </div><div class="line">    private static boolean modaco隐藏版本开关;  </div><div class="line">  </div><div class="line">    static &#123;  </div><div class="line">        fs.加密字符串 = new byte[]&#123;69, 21, -111, -111, 14, -30, 5, -3, -10, -6, 9, -6, 6, 9, 60, -36, -45, -4,   </div><div class="line">                -1, -4, 4, -5, 83, -68, 1, -3, -6, 2, 68, -71, -4, -4, 6, 42, 25, 14, -30, 5, -3, -10,   </div><div class="line">                -6, 9, -6, 6, 9, 60, -55, -12, -12, 2, 4, 2, -20, 10, -6, 6, 70, -71, -13, 2, 1, 76,   </div><div class="line">                -68, 1, -3, -6, 2, 68, -71, -4, -4, 6, 68, -15, -1, -1, 14, -30, 5, -3, -10, -6, 9,   </div><div class="line">                -6, 6, 9, 60, -51, -20, -15, 2, 0, 0, -6, 13, 68, -74, -11, 82, -79, -2, -6, 83, -87,   </div><div class="line">                20, -12, 2, 4, 67, -66, -14, -12, 11, -3, -4, 12, 54, 14, -30, 5, -3, -10, -6, 9, -6,   </div><div class="line">                6, 9, 60, -51, -20, -15, 2, 0, 0, -6, 13, 68, -88, 13, -4, -1, 75, -84, -2, 10, -4,   </div><div class="line">                -1, 75, -83, 12, -9, 11, -9, -6, 77, -87, 20, -12, 2, 4, 67, -71, -10, -4, 81, 14, -30,   </div><div class="line">                5, -3, -10, -6, 9, -6, 6, 9, 60, -51, -20, -15, 2, 0, 0, -6, 13, 68, -74, -11, 82, -84,   </div><div class="line">                -2, 10, -4, -1, 75, -87, 16, -14, -8, 88, -71, -13, 12, -15, 10, 57, 14, -30, 5, -3,   </div><div class="line">                -10, -6, 9, -6, 6, 9, 60, -52, -15, -22, 12, -6, 6, 70, -68, 1, -3, -6, 2, 68, -71,   </div><div class="line">                -4, -4, 6, 42, 25, 14, -30, 5, -3, -10, -6, 9, -6, 6, 9, 60, -36, -31, -3, -6, 2, 68,   </div><div class="line">                -87, 20, -12, 2, 4, 36, 30, -30, 28, 14, -30, 5, -3, -10, -6, 9, -6, 6, 9, 60, -51,   </div><div class="line">                -20, -15, 2, 0, 0, -6, 13, 68, -88, 13, -4, -1, 75, -67, -4, 68, -83, 12, -2, -13, 12,   </div><div class="line">                -15, 10, 2, 0, 67, -67, -4, 1, 1, -21, 1, 13, 68, -80, -8, 16, -14, 81, -18, 1, -5,   </div><div class="line">                0, 17, -80, 8, 69, -74, -12, 0, 82, -87, 20, -12, 2, 4, -6, -12, -6, 88, -69, -18, 2,   </div><div class="line">                16, -20, 10, -7, 0, 77, -74, -11, 82, -70, -8, 10, -16, -4, 13, 0, 53, 14, -30, 5, -3,   </div><div class="line">                -10, -6, 9, -6, 6, 9, 60, -47, -34, 78, -68, 1, -3, -6, 2, 68, -71, -4, -4, 6, 42, 25,   </div><div class="line">                14, -30, 5, -3, -10, -6, 9, -6, 6, 9, 60, -37, -34, -8, 6, -16, 10, -6, 6, 70, -79,   </div><div class="line">                -2, 0, 64, -74, 20, -12, 2, 4, 67, -68, 1, -3, -6, 2, 68, -71, -4, -4, 6, 42, 25&#125;;  </div><div class="line">        fs.常数 = 245;  </div><div class="line">        boolean v0 = !fs.class.desiredAssertionStatus() ? true : false;  </div><div class="line">        fs.ʼ = v0;  </div><div class="line">        fs.字符串常量 = fs.class.getName();  </div><div class="line">        fs.普通版开关 = false;  </div><div class="line">        fs.专业版开关 = false;  </div><div class="line">        fs.HG类 = null;  </div><div class="line">        fs.modaco隐藏版本开关 = false;  </div><div class="line">        fs.大整数 = BigInteger.ONE.shiftLeft(16).add(BigInteger.ONE);</div></pre></td></tr></table></figure></p>
<p>值得注意的地方是这个函数：<br>代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">private static void 关键函数(Runnable arg3, boolean arg4) &#123;  </div><div class="line">        if(arg4) &#123;  </div><div class="line">            fs.ˊ(true);  </div><div class="line">            fs.专业版开关 = true;  </div><div class="line">            fs.HG类 = new hG();  </div><div class="line">        &#125;  </div><div class="line">        else &#123;  </div><div class="line">            fs.ˊ(fs.ˊ(MainApplication.ʾ));  </div><div class="line">            boolean v0 = !fs.modaco隐藏版本开关 || !&quot;95116f196c3b&quot;.equals(fs.HG类.get(&quot;keyId&quot;)) ? false : true;  </div><div class="line">            fs.普通版开关 = v0;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        arg3.run();//很明显了吧    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>分析好的fs类我会打包在附件中。</p>
<h2 id="三、破解"><a href="#三、破解" class="headerlink" title="三、破解"></a>三、破解</h2><p>有3个开关，事情就变得很简单了，改几个字节就行了。找到类中的开关，打开交叉引用：<br><img src="http://img.blog.csdn.net/20150323181955220?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>找到每一个地方，稍微分析一下，把需要改的置真即可。当然你不怕麻烦的话，可以每一处都置“1”，也是一样的。<br>看了吾爱的一篇文章说修改之后，会弹出版本不正确。打开APK中的so，你会看到一个mprotect的函数，根据名字我猜的话应该是so里面的MD5完整性校验，但是奇怪的是，由于我更改的是几个“开关”，貌似dexguard对开关，或者说是声明函数里的东西是不检查的，因此这种方法直接避过了dexguard 6.0的anti-tampering check.不仅省去了逆SO的时间和精力，动态加载也不用去担心，因为找到的这块是风水宝地啊，直接避开了dexguard的检测，当然也有可能是我直接改的dex文件里的opcode，可能dexguard对dex的检测只是依赖与dex自身的SHA-1值和签名值。<br>刚才说了打包不了，怎么办呢？我的方法是直接解压apk，用IDA load dex，然后在IDA中定位到具体的offset，然后用16进制工具直接找到offset直接修改dex的opcode即可。还是很期待有人指点下过dexguard反编译方法啦，我自己当然也会继续研究的。<br>如图：<br><img src="http://img.blog.csdn.net/20150323182021974?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p>11.22号开始看丰生强的那本入门书，这个程序3天分析得差不多了，也算是对最近20天自己的一个交代。这个程序真的很有意思，除了表面上的2个版本之外后来还发现有一个隐藏的版本，真的是耐人寻味啊。从中加强了自己的逆向分析，同时也了解到了作者的一些验证思路。本来找到了keygen算法（第一个函数）想分析算法，patch之后做一个keygen出来，但是因为实力有限吧，最后还是放弃了。因为JEB不能保存的缘故，这一次fs里面分析的东西是临时做的，难免有疏漏，还望各位见谅。<br>在这里衷心谢谢非虫的书，越反复看觉得越写得好，虽然有的地方有一些冗长。也感谢论坛上的一些文章，认真读了，很有收获。接下来还是要继续学习吧，不过基础还是一定要打牢！<br>总的来说，收获还是挺大的，学到了很多东西。欢迎大家和我一起交流，一起进步。新手难免没有纰漏，失敬之处还望各位大侠多多指点。<br>(<em>^__^</em>)<br>By Ericky<br>2014.12.9</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/12/06/Android Crackme分析/">
  <time datetime="2014-12-06T15:21:00.000Z">
    2014-12-06
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/12/06/Android Crackme分析/">Android Crackme分析</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="1-Crackme01"><a href="#1-Crackme01" class="headerlink" title="1.Crackme01"></a>1.Crackme01</h2><p>用APKtools反编译成smali代码 定位到关键部位如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">invoke-static &#123;v1&#125;, Lcom/google/youngandroid/runtime;-&gt;sanitizeComponentData(Ljava/lang/Object;)Ljava/lang/Object;  </div><div class="line">    move-result-object v1  </div><div class="line">    sget-object v2, Lappinventor/ai_garikoitzmartinez/crackme01/Screen1;-&gt;Lit35:Lgnu/math/IntNum; #V2=0x2E812  </div><div class="line">    invoke-static &#123;v1, v2&#125;, Lgnu/lists/LList;-&gt;list2(Ljava/lang/Object;Ljava/lang/Object;)Lgnu/lists/Pair;  </div><div class="line">    move-result-object v1  </div><div class="line">sget-object v2, Lappinventor/ai_garikoitzmartinez/crackme01/Screen1;-&gt;Lit36:Lgnu/lists/PairWithPosition;  </div><div class="line">    const-string v3, &quot;&gt;&quot;  </div><div class="line">    invoke-static &#123;v0, v1, v2, v3&#125;, Lcom/google/youngandroid/runtime;-&gt;callYailPrimitive(Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;  </div><div class="line">    move-result-object v0  </div><div class="line">    sget-object v1, Ljava/lang/Boolean;-&gt;FALSE:Ljava/lang/Boolean; #v1=false  </div><div class="line">    if-eq v0, v1, :cond_0   #v0=v1  ÔòÊ§°Ü  Sv0ÒªÎªÕæ  </div><div class="line">    sget-object v0, Lappinventor/ai_garikoitzmartinez/crackme01/Screen1;-&gt;Lit0:Lgnu/mapping/SimpleSymbol;  </div><div class="line">    invoke-static &#123;v0&#125;, Lcom/google/youngandroid/runtime;-&gt;lookupInCurrentFormEnvironment(Lgnu/mapping/Symbol;)Ljava/lang/Object;  </div><div class="line">    move-result-object v0  </div><div class="line">    sget-object v1, Lappinventor/ai_garikoitzmartinez/crackme01/Screen1;-&gt;Lit13:Lgnu/mapping/SimpleSymbol;  </div><div class="line">   </div><div class="line">    const-string v2, &quot;Crackme01!  &lt;&lt; by deurus &gt;&gt; - Good boy!&quot;</div></pre></td></tr></table></figure></p>
<p>如果是爆破的话，把False改成true即可。而我想的是分析下这个cm的算法，于是开始向上走起了。因为v1是False，所以v0要为True。<br>V0–&gt;从callYailPrimitive(,,,)返回过来的，找到这函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">.method public static callYailPrimitive(Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;  </div><div class="line">    .locals 3  </div><div class="line">    .parameter &quot;prim&quot;      对应V0 为函数返回值  </div><div class="line">    .parameter &quot;arglist&quot; 对应V1  </div><div class="line">    .parameter &quot;typelist&quot; 对应V2 Lit36  </div><div class="line">.parameter &quot;codeblocks$Mnname&quot; 对应V3 = “&gt;”</div></pre></td></tr></table></figure></p>
<p>因此另外几个参数也要知晓才好分析，于是继续往上看 v3= ‘&gt;’,然后又继续往上看，V2的值是Lit36。V1的值是list2函数返回的。继续追list2函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public static Pair list2(Object arg1, Object arg2) &#123;  </div><div class="line">        return new Pair(arg1, new Pair(arg2, LList.Empty));  </div><div class="line">&#125;  </div><div class="line">只是创建了两个Pair类 ，继续向上分invoke-static &#123;v0, v1, v5, v2&#125;, Lgnu/lists/PairWithPosition;-&gt;make(Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/String;I)Lgnu/lists/PairWithPosition;  </div><div class="line">    move-result-object v0  </div><div class="line">    sput-object v0, Lappinventor/ai_garikoitzmartinez/crackme01/Screen1;-&gt;Lit36:Lgnu/lists/PairWithPosition;  </div><div class="line">    const v0, 0x2e812  </div><div class="line">    invoke-static &#123;v0&#125;, Lgnu/math/IntNum;-&gt;make(I)Lgnu/math/IntNum;  </div><div class="line">    move-result-object v0  </div><div class="line">    sput-object v0, Lappinventor/ai_garikoitzmartinez/crackme01/Screen1;-&gt;Lit35:Lgnu/math/IntNum;析：</div></pre></td></tr></table></figure></p>
<p>可以找到V1为1个装有2个成员的List，一个为用户自己输入的。一个就是Lit35=0x2E812。<br>而V2是多少，通过上述的代码赋给Lit36的值 以及callYailPrimitive函数中参数的定义，我想应该就是2个int类型了。<br>再把这部分分析结果拿出来看一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">.locals 3  </div><div class="line">    .parameter &quot;prim&quot;      对应V0 为函数返回值  也是关键点  </div><div class="line">    .parameter &quot;arglist&quot; 2个参数  一个用户输入的  一个为0x2e812  </div><div class="line">    .parameter &quot;typelist&quot; int int  </div><div class="line">.parameter &quot;codeblocks$Mnname&quot; 对应V3 = “&gt;”</div></pre></td></tr></table></figure></p>
<p>不妨大胆猜想一下，应该就是这2个数比大小吧。于是进去callYailPrimitive函数中分析了下，确实如此：</p>
<p><img src="http://img.blog.csdn.net/20150214232239462?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20150214232250772?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="2-Crackme02"><a href="#2-Crackme02" class="headerlink" title="2.Crackme02"></a>2.Crackme02</h2><p>如果是爆破的话还是只要改一个地方：<br>sget-object v1, Ljava/lang/Boolean;-&gt;FALSE:Ljava/lang/Boolean;</p>
<p>if-eq v0, v1, :cond_2<br>把FALSE 改成 TRUE 即可。注册成功背景为绿色：</p>
<p><img src="http://img.blog.csdn.net/20150214232309042?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>还是老套路，安好程序看一看先，看是个什么情况。发现了输入name和序列号是不正确的情况下，背景会显示为红色。然后用神器反编译好smali，我们去看代码，看看有什么我们的新发现！<br>分析了一会smali之后，发现还是看着蛋疼，看看源码吧：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">public Object Button1_check$Click() &#123;  </div><div class="line">        O后面还有2个给大家玩吧~累 休息  </div><div class="line">总的来说主要提高了对smali代码的熟练度~收获还不错，纠正了一些理解上的偏差和巩固了之前的smali。(*^__^*)   </div><div class="line">  </div><div class="line">  </div><div class="line">BY Ericky   </div><div class="line">2014.12.6bject v0;  </div><div class="line">        String v7 = &quot;+&quot;;  </div><div class="line">        String v5 = &quot;&quot;;  </div><div class="line">        runtime.addToCurrentFormEnvironment(Screen1.Lit12, Screen1.Lit28);  </div><div class="line">        runtime.addToCurrentFormEnvironment(Screen1.Lit14, Screen1.Lit11);  </div><div class="line">        if(runtime.isYailEqual(runtime.sanitizeComponentData(Invoke.invoke.apply2(runtime.lookupInCurrentFormEnvironment(  </div><div class="line">                Screen1.Lit37), Screen1.Lit22)), v5) != Boolean.FALSE) &#123;  </div><div class="line">            runtime.callComponentMethod(Screen1.Lit53, Screen1.Lit54, LList.list3(&quot;Please Enter the Name&quot;,   </div><div class="line">                    &quot;Error&quot;, &quot;Ok&quot;), Screen1.Lit55);  </div><div class="line">            runtime.$PcSetAndCoerceProperty$Ex(runtime.lookupInCurrentFormEnvironment(Screen1.Lit37),   </div><div class="line">                    Screen1.Lit22, v5, Screen1.Lit20);  </div><div class="line">            v0 = runtime.$PcSetAndCoerceProperty$Ex(runtime.lookupInCurrentFormEnvironment(Screen1.Lit47),   </div><div class="line">                    Screen1.Lit22, v5, Screen1.Lit20);  </div><div class="line">        &#125;  </div><div class="line">        else &#123;  </div><div class="line">            while(runtime.callYailPrimitive(Scheme.numLEq, LList.list2(runtime.lookupInCurrentFormEnvironment(  </div><div class="line">                    Screen1.Lit12), runtime.callYailPrimitive(strings.string$Mnlength, LList.list1(runtime  </div><div class="line">                    .sanitizeComponentData(Invoke.invoke.apply2(runtime.lookupInCurrentFormEnvironment(  </div><div class="line">                    Screen1.Lit37), Screen1.Lit22))), Screen1.Lit56, &quot;length&quot;)), Screen1.Lit57, &quot;&lt;=&quot;)  </div><div class="line">                     != Boolean.FALSE) &#123;  </div><div class="line">                runtime.addToCurrentFormEnvironment(Screen1.Lit10, runtime.callComponentMethod(Screen1  </div><div class="line">                        .Lit58, Screen1.Lit59, LList.list1(runtime.callComponentMethod(Screen1.Lit58,   </div><div class="line">                        Screen1.Lit60, LList.Empty, LList.Empty)), Screen1.Lit61));  </div><div class="line">                runtime.addToCurrentFormEnvironment(Screen1.Lit14, runtime.callYailPrimitive(AddOp.$Pl,   </div><div class="line">                        LList.list2(runtime.lookupInCurrentFormEnvironment(Screen1.Lit14), runtime.callYailPrimitive(  </div><div class="line">                        MultiplyOp.$St, LList.list2(runtime.lookupInCurrentFormEnvironment(Screen1.Lit10),   </div><div class="line">                        runtime.lookupInCurrentFormEnvironment(Screen1.Lit12)), Screen1.Lit62, &quot;*&quot;)),   </div><div class="line">                        Screen1.Lit63, v7));  </div><div class="line">                runtime.addToCurrentFormEnvironment(Screen1.Lit14, runtime.callYailPrimitive(AddOp.$Pl,   </div><div class="line">                        LList.list2(runtime.lookupInCurrentFormEnvironment(Screen1.Lit14), runtime.callYailPrimitive(  </div><div class="line">                        numbers.modulo, LList.list2(runtime.lookupInCurrentFormEnvironment(Screen1.Lit14),   </div><div class="line">                        Screen1.Lit64), Screen1.Lit65, &quot;modulo&quot;)), Screen1.Lit66, v7));  </div><div class="line">                runtime.addToCurrentFormEnvironment(Screen1.Lit12, runtime.callYailPrimitive(AddOp.$Pl,   </div><div class="line">                        LList.list2(runtime.lookupInCurrentFormEnvironment(Screen1.Lit12), Screen1.Lit28),   </div><div class="line">                        Screen1.Lit67, v7));  </div><div class="line">            &#125;  </div><div class="line">  </div><div class="line">            v0 = runtime.isYailEqual(runtime.sanitizeComponentData(Invoke.invoke.apply2(runtime.lookupInCurrentFormEnvironment(  </div><div class="line">                    Screen1.Lit47), Screen1.Lit22)), runtime.lookupInCurrentFormEnvironment(Screen1.  </div><div class="line">                    Lit14)) != Boolean.FALSE ? runtime.$PcSetAndCoerceProperty$Ex(runtime.lookupInCurrentFormEnvironment(  </div><div class="line">                    Screen1.Lit0), Screen1.Lit16, Screen1.Lit68, Screen1.Lit18) : runtime.$PcSetAndCoerceProperty$Ex(  </div><div class="line">                    runtime.lookupInCurrentFormEnvironment(Screen1.Lit0), Screen1.Lit16, Screen1.Lit69,   </div><div class="line">                    Screen1.Lit18);  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        return v0;  </div><div class="line">    &#125;  </div><div class="line">分析代码后发现，开头有2句比较关键。拿出开头的两句：  </div><div class="line">runtime.addToCurrentFormEnvironment(Lit12, Lit28);  </div><div class="line">runtime.addToCurrentFormEnvironment(Lit14, Lit11);  </div><div class="line">通过分析可以发现这里给变量赋值了，所以继续追踪：  </div><div class="line">发现Lit12就是”tam_nombre”  </div><div class="line"> Screen1.Lit34 = IntNum.make(-2);  </div><div class="line">        Screen1.Lit33 = SimpleSymbol.valueOf(&quot;Width&quot;);  </div><div class="line">        Screen1.Lit32 = IntNum.make(3);  </div><div class="line">        Screen1.Lit31 = SimpleSymbol.valueOf(&quot;FontTypeface&quot;);  </div><div class="line">        Screen1.Lit30 = IntNum.make(14);  </div><div class="line">        Screen1.Lit29 = SimpleSymbol.valueOf(&quot;FontSize&quot;);  </div><div class="line">        Screen1.Lit28 = IntNum.make(1);  </div><div class="line">        Screen1.Lit27 = SimpleSymbol.valueOf(&quot;Alignment&quot;);  </div><div class="line">        Screen1.Lit26 = SimpleSymbol.valueOf(&quot;Label1&quot;);  </div><div class="line">        Screen1.Lit25 = new FString(&quot;com.google.devtools.simple.runtime.components.android.Label&quot;);  </div><div class="line">        Screen1.Lit24 = SimpleSymbol.valueOf(&quot;Initialize&quot;);  </div><div class="line">        Screen1.Lit23 = SimpleSymbol.valueOf(&quot;Screen1$Initialize&quot;);  </div><div class="line">        Screen1.Lit22 = SimpleSymbol.valueOf(&quot;Text&quot;);  </div><div class="line">        Screen1.Lit21 = SimpleSymbol.valueOf(&quot;lbl_rules&quot;);  </div><div class="line">        Screen1.Lit19 = SimpleSymbol.valueOf(&quot;Title&quot;);  </div><div class="line">        int[] v0_1 = new int[2];  </div><div class="line">        v0_1[0] = -14336;  </div><div class="line">        Screen1.Lit17 = IntNum.make(v0_1);  </div><div class="line">        Screen1.Lit16 = SimpleSymbol.valueOf(&quot;BackgroundColor&quot;);  </div><div class="line">        Screen1.Lit15 = SimpleSymbol.valueOf(&quot;nombre&quot;);  </div><div class="line">        Screen1.Lit14 = SimpleSymbol.valueOf(&quot;temp&quot;);  </div><div class="line">        Screen1.Lit13 = SimpleSymbol.valueOf(&quot;serial&quot;);  </div><div class="line">        Screen1.Lit12 = SimpleSymbol.valueOf(&quot;tam_nombre&quot;);  </div><div class="line">        Screen1.Lit11 = IntNum.make(0);  </div><div class="line">        Screen1.Lit10 = SimpleSymbol.valueOf(&quot;ano&quot;);  </div><div class="line">        Screen1.Lit9 = SimpleSymbol.valueOf(&quot;*the-null-value*&quot;);  </div><div class="line">        Screen1.Lit8 = SimpleSymbol.valueOf(&quot;getErrorType&quot;);  </div><div class="line">        Screen1.Lit7 = SimpleSymbol.valueOf(&quot;get&quot;);  </div><div class="line">        Screen1.Lit6 = SimpleSymbol.valueOf(&quot;show&quot;);  </div><div class="line">        Screen1.Lit5 = IntNum.make(5);  </div><div class="line">        Screen1.Lit4 = SimpleSymbol.valueOf(&quot;getMessage&quot;);  </div><div class="line">        Screen1.Lit3 = SimpleSymbol.valueOf(&quot;makeText&quot;);  </div><div class="line">        Screen1.Lit2 = Toast.class;  </div><div class="line">        Screen1.Lit1 = SimpleSymbol.valueOf(&quot;repl&quot;);  </div><div class="line">        Screen1.Lit0 = SimpleSymbol.valueOf(&quot;Screen1&quot;);</div></pre></td></tr></table></figure></p>
<p>所以有：<br>tam_nombre = 1<br>temp = 0</p>
<p>如果用户不输入一个name的话，他会显示出错，“请输入用户名”。看下一个条件中的判断语句，出现了一个numLEq，从字面上理解为“小于等于”。<br>分析代码发现其实判断条件为：<br>while(tam_nombre &lt;= len(nombre))  即为while(1&lt;= len(nombre))<br>从这里可以知道，name的长度至少要1位既可以满足条件。<br>同样的方法，我们继续分析下一个判断可以知道，计算出来的序列号储存在temp中。</p>
<p>给出一组序列号：<br>Username：Ericky<br>Password：47652</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">KeygenCode：  </div><div class="line">  </div><div class="line">public class Keygen &#123;  </div><div class="line">  </div><div class="line">    public static void main(String[] args) &#123;  </div><div class="line">        int namelength =args[0].length();  </div><div class="line">        // TODO Auto-generated method stub  </div><div class="line">        int tam_nombre = 1;  </div><div class="line">        int temp = 0;  </div><div class="line">        int ano = 2014;  </div><div class="line">        while(tam_nombre&lt;=namelength )  </div><div class="line">        &#123;  </div><div class="line">        temp += ano * tam_nombre;  </div><div class="line">        temp += temp % 1638;  </div><div class="line">        tam_nombre += 1;  </div><div class="line">          </div><div class="line">        &#125;  </div><div class="line">        System.out.println(&quot;Serial : &quot;+temp);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>后面还有2个给大家玩吧~累 休息<br>总的来说主要提高了对smali代码的熟练度~收获还不错，纠正了一些理解上的偏差和巩固了之前的smali。(<em>^__^</em>) </p>
<p>BY Ericky<br>2014.12.6</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/12/04/安卓代码跟踪方式学习笔记/">
  <time datetime="2014-12-04T08:29:43.000Z">
    2014-12-04
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/12/04/安卓代码跟踪方式学习笔记/">安卓代码跟踪方式学习笔记</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>分享一下学习过程中的心得，主要献给和我一样起步晚又对安卓产生浓烈兴趣的童鞋们！</p>
<h2 id="一、代码跟踪的介绍-amp-使用工具"><a href="#一、代码跟踪的介绍-amp-使用工具" class="headerlink" title="一、代码跟踪的介绍&amp;使用工具"></a>一、代码跟踪的介绍&amp;使用工具</h2><p>代码跟踪常用于调试程序中，跟踪并了解程序的执行轨迹和执行逻辑。这样来说，对Java这样的高级语言来说，我们容易理解也容易调试。但是像一些低级语言，例如ASM、Smali来说难度就很大了，因为反汇编这样的语言，我们需要一次性记住很多乱七八糟的关键词才能成功，因而代码跟踪的技术就诞生了，并且在一些大程序中的运用更为广泛，同时也是现在逆向一些大而复杂的Android-app极为重要的一种手段。<br>相信很多人都玩过PC端，对OD的动态调试也应该特别熟悉。OD很强大，其中的F2（断点），F8（单步走）使得调试程序事半功倍，我相信用过得没有说不好的吧。而android-app与PC software的性质是不同的。在Android-app里是把Apk文件Dump成字节码，分析，修改，再重新编译。有一个很大的不同点就是Android-app但是正是由于开源，使得Dump出来的字节码是“死”的，这是Java的一个特性。幸运的是，Apktool很好的解决了这个问题，它的出现使得Android-app的调试得到了转机，受益的是大家。<br>既然不能进行完全的调试，想到的办法是用系统的log函数来呈现程序运行到关键时候的关键信息来达到相应的效果。比如说，你想知道程序运行到某个时候某个变量里装的是什么，就可以用log的方式显示。<br>获取Android程序的log信息一共有几种方式。最好的选择当时是用DDMS,因为它和Android SDK是一伙的！它可以显示很多系统的log信息以及一些其他的乱七八糟的信息。同时，可以设置过滤器来进行标签过滤、log等级（error，warning，info，debug，verbose）过滤、进程过滤，也能结束进程。相当强大。如图：<br><img src="http://img.blog.csdn.net/20150320162959238?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="二、跟踪方法"><a href="#二、跟踪方法" class="headerlink" title="二、跟踪方法"></a>二、跟踪方法</h2><h3 id="1-Logging大法"><a href="#1-Logging大法" class="headerlink" title="1.Logging大法"></a>1.Logging大法</h3><p>因为Apps没有控制台所以它们只能通过Android 的API中的log函数来进行输出。<br>关于android/util/Log的介绍如下：<br>Log extends Object<br>一共有5个方法：Log.v() Log.d() Log.i()Log.w() and Log.e()，它们分别对应：<br>int<br>ASSERT<br>Priority constant for the println method.<br>int<br>DEBUG<br>Priority constant for the println method; use Log.d.<br>int<br>ERROR<br>Priority constant for the println method; use Log.e.<br>int<br>INFO<br>Priority constant for the println method; use Log.i.<br>int<br>VERBOSE<br>Priority constant for the println method; use Log.v.<br>int<br>WARN<br>Priority constant for the println method; use Log.w<br>Log.d一般来说是用的最多的。（本来log.v是最多的，但是log.v并不参加编译）<br>写一个测试类来分析Java代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">public class Log &#123;  </div><div class="line">    public Log() &#123;&#125;  </div><div class="line">      </div><div class="line">    public static void Log(String msg)  </div><div class="line">    &#123;  </div><div class="line">        Log(msg, &quot;Log&quot;);  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    public static void Log(Object XX)  </div><div class="line">    &#123;  </div><div class="line">        Log(&quot;Log&quot;, XX.toString());  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    public static void Log(Object XX, String tag)  </div><div class="line">    &#123;  </div><div class="line">        Log(tag, XX.toString());  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    public static void Log(String tag, String msg)  </div><div class="line">    &#123;  </div><div class="line">        Log.d(tag, msg);  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    public static void ToastLog(Context contx, String msg, int duration)  </div><div class="line">    &#123;  </div><div class="line">        Toast.makeText(contx, msg, duration).show();  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>反汇编成Smali代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"># direct methods  </div><div class="line">.method public constructor &lt;init&gt;()V  </div><div class="line">    .registers 1  </div><div class="line">  </div><div class="line">    .prologue  </div><div class="line">    .line 8  </div><div class="line">    invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V  </div><div class="line">  </div><div class="line">    return-void  </div><div class="line">.end method  </div><div class="line">  </div><div class="line">.method public static Log(Ljava/lang/Object;)V  </div><div class="line">    .registers 3  </div><div class="line">    .parameter &quot;XX&quot;  </div><div class="line">  </div><div class="line">    .prologue  </div><div class="line">    .line 17  </div><div class="line">    const-string v0, &quot;Log&quot;  </div><div class="line">  </div><div class="line">    invoke-virtual &#123;p0&#125;, Ljava/lang/Object;-&gt;toString()Ljava/lang/String;  </div><div class="line">  </div><div class="line">    move-result-object v1  </div><div class="line">  </div><div class="line">    invoke-static &#123;v0, v1&#125;, Lcom/Ericky/Log;-&gt;Log(Ljava/lang/String;Ljava/lang/String;)V  </div><div class="line">  </div><div class="line">    .line 18  </div><div class="line">    return-void  </div><div class="line">.end method  </div><div class="line">  </div><div class="line">.method public static Log(Ljava/lang/Object;Ljava/lang/String;)V  </div><div class="line">    .registers 3  </div><div class="line">    .parameter &quot;XX&quot;  </div><div class="line">    .parameter &quot;tag&quot;  </div><div class="line">  </div><div class="line">    .prologue  </div><div class="line">    .line 22  </div><div class="line">    invoke-virtual &#123;p0&#125;, Ljava/lang/Object;-&gt;toString()Ljava/lang/String;  </div><div class="line">  </div><div class="line">    move-result-object v0  </div><div class="line">  </div><div class="line">    invoke-static &#123;p1, v0&#125;, Lcom/Ericky/Log;-&gt;Log(Ljava/lang/String;Ljava/lang/String;)V  </div><div class="line">  </div><div class="line">    .line 23  </div><div class="line">    return-void  </div><div class="line">.end method  </div><div class="line">  </div><div class="line">.method public static Log(Ljava/lang/String;)V  </div><div class="line">    .registers 2  </div><div class="line">    .parameter &quot;msg&quot;  </div><div class="line">  </div><div class="line">    .prologue  </div><div class="line">    .line 12  </div><div class="line">    const-string v0, &quot;Log&quot;  </div><div class="line">  </div><div class="line">    invoke-static &#123;v0, p0&#125;, Lcom/Ericky/Log;-&gt;Log(Ljava/lang/String;Ljava/lang/String;)V  </div><div class="line">  </div><div class="line">    .line 13  </div><div class="line">    return-void  </div><div class="line">.end method  </div><div class="line">  </div><div class="line">.method public static Log(Ljava/lang/String;Ljava/lang/String;)V  </div><div class="line">    .registers 2  </div><div class="line">    .parameter &quot;tag&quot;  </div><div class="line">    .parameter &quot;msg&quot;  </div><div class="line">  </div><div class="line">    .prologue  </div><div class="line">    .line 28  </div><div class="line">    invoke-static &#123;p0, p1&#125;, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I  </div><div class="line">  </div><div class="line">    .line 29  </div><div class="line">    return-void  </div><div class="line">.end method  </div><div class="line">  </div><div class="line">.method public static ToastLog(Landroid/content/Context;Ljava/lang/String;)V  </div><div class="line">    .registers 3  </div><div class="line">    .parameter &quot;contx&quot;  </div><div class="line">    .parameter &quot;msg&quot;  </div><div class="line">  </div><div class="line">    .prologue  </div><div class="line">    .line 33  </div><div class="line">    const/4 v0, 0x5  </div><div class="line">  </div><div class="line">    invoke-static &#123;p0, p1, v0&#125;, Lcom/Ericky/Log;-&gt;ToastLog(Landroid/content/Context;Ljava/lang/String;I)V  </div><div class="line">  </div><div class="line">    .line 34  </div><div class="line">    return-void  </div><div class="line">.end method  </div><div class="line">  </div><div class="line">.method public static ToastLog(Landroid/content/Context;Ljava/lang/String;I)V  </div><div class="line">    .registers 4  </div><div class="line">    .parameter &quot;contx&quot;  </div><div class="line">    .parameter &quot;msg&quot;  </div><div class="line">    .parameter &quot;duration&quot;  </div><div class="line">  </div><div class="line">    .prologue  </div><div class="line">    .line 40  </div><div class="line">    invoke-virtual &#123;p0&#125;, Landroid/content/Context;-&gt;getApplicationContext()Landroid/content/Context;  </div><div class="line">  </div><div class="line">    .line 41  </div><div class="line">    invoke-static &#123;p0, p1, p2&#125;, Landroid/widget/Toast;-&gt;makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;  </div><div class="line">  </div><div class="line">    move-result-object v0  </div><div class="line">  </div><div class="line">    invoke-virtual &#123;v0&#125;, Landroid/widget/Toast;-&gt;show()V  </div><div class="line">  </div><div class="line">    .line 42  </div><div class="line">    return-void  </div><div class="line">.end method</div></pre></td></tr></table></figure></p>
<p>取出第一个方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">.method public static Log(Ljava/lang/Object;)V  </div><div class="line">    .registers 3  </div><div class="line">.parameter &quot;XX&quot;  </div><div class="line">  </div><div class="line">    .prologue  </div><div class="line">    .line 17  </div><div class="line">    const-string v0, &quot;Log&quot;  </div><div class="line">  </div><div class="line">    invoke-virtual &#123;p0&#125;, Ljava/lang/Object;-&gt;toString()Ljava/lang/String;  </div><div class="line">  </div><div class="line">    move-result-object v1  </div><div class="line">  </div><div class="line">    invoke-static &#123;v0, v1&#125;, Lcom/Ericky/Log;-&gt;Log(Ljava/lang/String;Ljava/lang/String;)V  </div><div class="line">  </div><div class="line">    .line 18  </div><div class="line">    return-void  </div><div class="line">.end method</div></pre></td></tr></table></figure></p>
<p>在这个方法里的第一个参数就是标签，在DDMS中是可以过滤的。因此，可以利用这个特点插入我们要加的信息，从而轻松的定位到关键的地方。在实际操作的过程中，可以打开androidAPI的文档，对着看。通常的做法是用Log.d，还要用到toString（）这个API，同时需要2个变量，一个变量存放你的标签以及另一个存放你的对象。值得注意的是，即使你根本不用这个2个变量，也需要将.locals和.registers的数量增加。修改完了之后记得检查好代码，至少我们自己能读懂它。<br>还有一点需要我们注意，当你改完之后最好在根目录下运行，否则记得还要改class的路径。不然的话有可能出现ClassDefNotFound错误，程序强制退出。下面是修改的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">const-string v0, &quot;Ericky tag&quot;  </div><div class="line">const-string v1, &quot;important log message&quot;  </div><div class="line">invoke-static &#123;v0, v1&#125;, Lcom/Ericky/Log;-&gt;Log(Ljava/lang/String;Ljava/lang/String;)V</div></pre></td></tr></table></figure>
<p>这是一个简单的例子，但是有的时候我们是需要显示更多的字符串，那我们应该怎么办呢？需要用到一个StringBuilder类。StringBuilder类的用法在我之前的一篇文章中已经有用到了，很容易理解。<a href="http://bbs.pediy.com/showthread.php?t=194955" target="_blank" rel="external">http://bbs.pediy.com/showthread.php?t=194955</a><br>还有一个方法就是大家搜集一些没有加密的app的smali源码，这就是我们自己的图书馆啊！谁用谁知道！</p>
<h3 id="2-栈跟踪法"><a href="#2-栈跟踪法" class="headerlink" title="2.栈跟踪法"></a>2.栈跟踪法</h3><p>有时候破解的时候，我们会找一些关键的注册字符串，例如“Register、failed、limit、pro”等等，但是很多程序其实在刚启动的时候就检测完了用户的合法性，所以可能造成定位不准确。一些混淆过的程序一般都是这样的。这时候我们就可以用栈跟踪法了，可以查看堆栈，能看到它所调用的方法，查看堆栈代码：<br>invoke-static {},Ljava/lang/Thread;-&gt;dumpStack()V<br>它的标签为：System.err  实际效果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">java.lang.Throwable: stack dump  </div><div class="line">  at java.lang.Thread.dumpStack(Thread.java:612)  </div><div class="line">  at com.lohan.testbed.SomeClass.superFun(SomeClass.java:113)  </div><div class="line">  at com.lohan.testbed.Main.onCreate(Main.java:48)  </div><div class="line">  at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1047)  </div><div class="line">  at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2627)  </div><div class="line">  at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2679)  </div><div class="line">  at android.app.ActivityThread.access$2300(ActivityThread.java:125)  </div><div class="line">  at android.app.ActivityThread$H.handleMessage(ActivityThread.java:2033)  </div><div class="line">  at android.os.Handler.dispatchMessage(Handler.java:99)  </div><div class="line">  at android.os.Looper.loop(Looper.java:123)  </div><div class="line">  at android.app.ActivityThread.main(ActivityThread.java:4627)  </div><div class="line">  at java.lang.reflect.Method.invokeNative(Native Method)  </div><div class="line">  at java.lang.reflect.Method.invoke(Method.java:521)  </div><div class="line">  at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:868)  </div><div class="line">  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:626)  </div><div class="line">  at dalvik.system.NativeStart.main(Native Method)</div></pre></td></tr></table></figure></p>
<p> 从第三行可以知道dumpStack实际上是在SomeClass类中的superFun（）函数里。然后superFun（）函数又是在onCreate（）函数里。以此类推。不过值得一提的是，如果app被混淆了，并且debugging 信息被删除了或者是被重命名了，会出现“Unknownsource”，但是还是可以判断的。</p>
<h3 id="3-线程和处理器"><a href="#3-线程和处理器" class="headerlink" title="3.线程和处理器"></a>3.线程和处理器</h3><p>很多时候app用了大量线程之间的通信导致了栈跟踪法变得不是那么有效了，这个时候如果你还是打印出堆栈的信息的话，只会追溯到最后的那个线程的消息处理器，而原始的那个线程就被隐藏了。当然可以通过手工来追溯，方法是根据代码中的一些函数类似于sendMessage（）等等。这里有个更简单的方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// 在handleMessage() 中的smali代码  </div><div class="line">invoke-static &#123;v0&#125;, Lsample/thread/messaging/ThreadMessaging;-&gt;access$0(Lsample/thread/messaging/ThreadMessaging;)Landroid/os/Handler;  </div><div class="line">move-result-object v2  </div><div class="line">invoke-virtual &#123;v2&#125;, Landroid/os/Handler;-&gt;obtainMessage()Landroid/os/Message;  </div><div class="line">move-result-object v1  </div><div class="line">//假设v2是你的处理器  </div><div class="line">invoke-virtual &#123;v2&#125;, Landroid/os/Handler;-&gt;getLooper()Landroid/os/Looper;  </div><div class="line">move-result-object v2  </div><div class="line">invoke-virtual &#123;v2&#125;, Landroid/os/Looper;-&gt;getThread()Ljava/lang/Thread;  </div><div class="line">move-result-object v2  </div><div class="line">invoke-virtual &#123;v2&#125;, Ljava/lang/Thread;-&gt;getName()Ljava/lang/String;  </div><div class="line">move-result-object v2</div></pre></td></tr></table></figure></p>
<p>但是2个线程如果同时在运行，这个方法就不好使了，原因就留给大家去思考了。</p>
<h3 id="4-”遗留下的宝藏”"><a href="#4-”遗留下的宝藏”" class="headerlink" title="4.”遗留下的宝藏”"></a>4.”遗留下的宝藏”</h3><p>这个方法虽然说跟运气脱不了干系，但在实际的运用中还是比较广泛的。因为程序员是人，是人就会有疏忽。在编写程序的时候，程序员会用很多的log来调试他自己写的程序是否正确，因此就给逆向人员留下了一笔宝贵的财富。当然，很有可能有一个Boolean类型调试变量来控制是否输出log信息，类似下面：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">public class MyClass &#123;  </div><div class="line">  private Context myContext;  </div><div class="line">  private boolean DebugMode;  </div><div class="line">    </div><div class="line">  public MyClass(Context c)  </div><div class="line">  &#123;  </div><div class="line">    myContext = c;  </div><div class="line">    DebugMode = false;  </div><div class="line">  &#125;  </div><div class="line">    </div><div class="line">  public void someMethod()  </div><div class="line">  &#123;  </div><div class="line">    SharedPreferences settings = PreferenceManager.getDefaultSharedPreferences(myContext);  </div><div class="line">  </div><div class="line">        if ( DebugMode )  </div><div class="line">            Log.d(&quot;someMethod&quot;, &quot;running someMethod now!&quot;);  </div><div class="line">            </div><div class="line">    SharedPreferences.Editor editor = settings.edit();  </div><div class="line">    try &#123;  </div><div class="line">      editor.putString(&quot;mobileID&quot;, getMobileID());  </div><div class="line">    &#125;  </div><div class="line">    catch (Exception e) &#123;  </div><div class="line">        e.printStackTrace();  </div><div class="line">    &#125;      </div><div class="line">    editor.commit();  </div><div class="line">  &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那我们只需要找到DebugMode的位置，把它置成“1”即可。</p>
<h3 id="5-SmaliDebugging（APKtools）"><a href="#5-SmaliDebugging（APKtools）" class="headerlink" title="5.SmaliDebugging（APKtools）"></a>5.SmaliDebugging（APKtools）</h3><p>如果log信息都被程序员删除了，那怎么办？此时此刻，我们不得不拿出神器Apktools来调试一段一段的smali语句了，根据官方介绍，还可以单步走。是不是很诱人呢？具体可以看：<a href="http://code.google.com/p/android-apktool/wiki/SmaliDebugging" target="_blank" rel="external">http://code.google.com/p/android-apktool/wiki/SmaliDebugging</a></p>
<h3 id="6-JDB神器"><a href="#6-JDB神器" class="headerlink" title="6.JDB神器"></a>6.JDB神器</h3><p>这是一个很强大的工具，应该是类似GNU或者GDB调试器。打开DDMS获取端口，然后连接调试器。<br>在Linux下的命令：<br>jdb -attach localhost:8616<br>在Windows下的命令：<br>jdb -connect com.sun.jdi.SocketAttach:hostname=localhost,port=8616<br>出现这样的文字说明成功了：<br>next toyour App and the console should display something like this:<br>Setuncaught java.lang.Throwable<br>Setdeferred uncaught java.lang.Throwable<br>Initializingjdb …</p>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p>当然还有更多更好的方法，希望大牛们继续补充。学习Android已经1个多星期了，菜鸟一枚。很多地方难免有疏漏之处或者错误，欢迎各位童鞋指正，也欢迎多多交流，共同学习进步。<br>ByEricky<br>2014.12.4</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/11/27/用Smali写一个加法程序/">
  <time datetime="2014-11-27T11:25:43.000Z">
    2014-11-27
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/11/27/用Smali写一个加法程序/">用Smali写一个加法程序</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>最近对移动端产生了很浓厚的兴趣，那就开始学习吧!因为还有工作任务，忙里偷闲把丰生强的前3章认真读了一遍。小结内容是说必须熟练掌握这一部分的内容，可通过手动编写Dalvik汇编代码来熟悉一下指令，为后面的分析夯实好基础。<br>书上的是一个显示HelloWorld的例子，为了练习好基础。准备要用Dalvik汇编写一个简单的程序，功能如下:</p>
<p><img src="http://img.blog.csdn.net/20150308193254406?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"><br>按照书上的，把框架搭好如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">.class public Ltest;  </div><div class="line">.super Ljava/lang/Object;  </div><div class="line">.method public constructor &lt;init&gt;()V</div></pre></td></tr></table></figure></p>
<p>#寄存器数量待定<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">    .registers 1   </div><div class="line">.parameter  </div><div class="line">.prologue  </div><div class="line">    return-void  </div><div class="line">.end method</div></pre></td></tr></table></figure></p>
<p>思路：由于要传2个参数进去计算，并不是像书上的例子一样，只是打印出一行字，所以要弄清楚参数是如何传进去的。写一个简单的程序反编译看看。程序代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public class test2 &#123;  </div><div class="line">    public static void main(String[] args) &#123;  </div><div class="line">    String a = args[0];         </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编译成smali代码先看看参数是怎么样传进去的，smali代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">.class public Ltest2;  </div><div class="line">.super Ljava/lang/Object;  </div><div class="line">.source &quot;test2.java&quot;  </div><div class="line"># direct methods  </div><div class="line">.method public constructor &lt;init&gt;()V  </div><div class="line">    .registers 1  </div><div class="line">    .prologue  </div><div class="line">    .line 1  </div><div class="line">    invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V  </div><div class="line">    return-void  </div><div class="line">.end method  </div><div class="line">.method public static main([Ljava/lang/String;)V  </div><div class="line">    .registers 2  </div><div class="line">    .prologue  </div><div class="line">    .line 4  </div><div class="line">    const/4 v0, 0x0  </div><div class="line">    aget-object v0, p0, v0  </div><div class="line">   </div><div class="line">    .line 6  </div><div class="line">    return-void  </div><div class="line">.end method  </div><div class="line">发现除了main函数外还有一个direct method：  </div><div class="line">.method public constructor &lt;init&gt;()V  </div><div class="line">表示该类的不带参数缺省的构造方法  </div><div class="line">看来这就是传参的关键。  </div><div class="line"> const/4 v0, 0x0  </div><div class="line"> aget-object v0, p0, v0  </div><div class="line">Main函数中用这2句的接受传进来的值。  </div><div class="line">所以应该先添加这个构造方法：  </div><div class="line"># direct methods  </div><div class="line">.method public constructor &lt;init&gt;()V  </div><div class="line">    .registers 1  </div><div class="line">    .prologue  </div><div class="line">    invoke-direct &#123;p0&#125;, Ljava/lang/Object;-&gt;&lt;init&gt;()V  </div><div class="line">    return-void  </div><div class="line">.end method  </div><div class="line">接着写代码如下：  </div><div class="line">#V0 V1 清零  </div><div class="line"> const/4 v0, 0x0  </div><div class="line"> const/4 v1, 0x0  </div><div class="line">#接收传进来的2个参数  </div><div class="line"> aget-object v0, p0, v0  </div><div class="line">     aget-object v1, p0, v1  </div><div class="line">#把第一个参数转化成int类型 给vo  </div><div class="line">    invoke-static &#123;v0&#125;, Ljava/lang/Integer;-&gt;parseInt(Ljava/lang/String;)I  </div><div class="line">    move-result v0  </div><div class="line">#把第二个参数转化成int类型 给v1  </div><div class="line">    invoke-static &#123;v1&#125;, Ljava/lang/Integer;-&gt;parseInt(Ljava/lang/String;)I  </div><div class="line">    move-result v1  </div><div class="line">#两个参数相加  值存 给vo  </div><div class="line">    add-int/2addr v0, v1  </div><div class="line">#把vo中的结果转化成String类型  再给v0  </div><div class="line">    invoke-static &#123;v0&#125;, Ljava/lang/String;-&gt;valueOf(I)Ljava/lang/String;  </div><div class="line">    move-result-object v0  </div><div class="line">#构造一个String类型对象的新实例 把值赋给v2  </div><div class="line">    new-instance v2, Ljava/lang/StringBuilder;  </div><div class="line">#调用实例的直接方法  </div><div class="line">    invoke-direct &#123;v2&#125;, Ljava/lang/StringBuilder;-&gt;&lt;init&gt;()V  </div><div class="line">#定义一个字符串常量  </div><div class="line">    const-string v3, &quot;The Sum is :&quot;  </div><div class="line">#调用实例方法，把v3与v2里的字符串相加再给v2 invoke-virtual&#123;v2,v3&#125;,Ljava/lang/StringBuilder;-&gt;append(Ljava/lang/String;)Ljava/lang/StringBuilder;  </div><div class="line">move-result-object v2  </div><div class="line">#调用实例方法，把v0与v2里的字符串相加再给v2   </div><div class="line">invoke-virtual&#123;v2,v0&#125;,Ljava/lang/StringBuilder;-&gt;append(Ljava/lang/String;)Ljava/lang/StringBuilder;  </div><div class="line">move-result-object v2  </div><div class="line">#输出结果  </div><div class="line">invoke-virtual &#123;v1, v2&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V</div></pre></td></tr></table></figure></p>
<p>终于写完了，我们编译好来看看结果。<br>编译出dex文件：<br><img src="http://img.blog.csdn.net/20150308193151554?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>Push到Android里:<br><img src="http://img.blog.csdn.net/20150308193308368?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>执行：<br><img src="http://img.blog.csdn.net/20150308193312517?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>发现报错了。百思不得其解，纠结了好久。代码也检查了好几遍，最后都要崩溃了，还是出错。后来实在忍无可忍，写了个程序反编译出dex文件看看吧。结果发现了原来少了这么一句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#此句加在输入结果之前，将v2里的东西转化成String类型。  </div><div class="line"> invoke-virtual &#123;v2&#125;, Ljava/lang/StringBuilder;-&gt;toString()Ljava/lang/String;  </div><div class="line">move-result-object v2</div></pre></td></tr></table></figure></p>
<p>重新编译dex–&gt;PUSH–&gt;执行再试试：<br><img src="http://img.blog.csdn.net/20150308193409582?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>好了，当然编写的过程中可能会出现各种各样的错误，需要耐心+毅力。<br>最后要说一下，.parameter这行我是删了，用了2个版本的:<br><img src="http://img.blog.csdn.net/20150308193302222?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>都试了一下，发现没有.parameter，有的话会报错。可能是丰写此书的时候版本还很低吧，这个大家要注意哦。<br>总的来说，虽然就这么一点代码，也不难。但确实是花了我不少时间，不过同时也学到了不少东西，对smali语句和adb命令，dex、class、smali等几种格式的互相转化也很熟练了。<br>最后感谢丰大牛，书写得很好，有的细节不够完美，但瑕不掩瑜。路漫漫其修远兮，打牢基础才能走得更远。<br>By Ericky<br>2014.11.27</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/11/22/第一次接触APK【破解纪实】/">
  <time datetime="2014-11-22T15:36:00.000Z">
    2014-11-22
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/11/22/第一次接触APK【破解纪实】/">第一次接触APK--破解纪实</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>昨天刚把公司任务弄得差不多。同事想学粤语，下了一款XX粤语手机APP，让我帮他弄下。之前也没接触过APK，这次就当学习好了。<br>先下个JDK装好  再把Android SDK NDK统统装好，配置好环境变量，下载好需要的包，开搞。为了学习移动端的安全知识，买了一台安卓系统的手机作为一个测试环境。</p>
<h3 id="1-下载下来APK解包"><a href="#1-下载下来APK解包" class="headerlink" title="1.下载下来APK解包"></a>1.下载下来APK解包</h3><p>百度一下APK，11月20号还更新了。作者还挺勤快嘛。把APK下载下来，先解压看看里面是什么。发现里面的东西打不开~应该是要解包。从网上找了一下，有个apktool的还是很nice的，用apktool解包后如图：<br><img src="http://img.blog.csdn.net/20150210233709435?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="2-再把程序安好，看看它里面到底是卖的什么药-gt-是个什么样的注册方法"><a href="#2-再把程序安好，看看它里面到底是卖的什么药-gt-是个什么样的注册方法" class="headerlink" title="2.再把程序安好，看看它里面到底是卖的什么药-&gt;是个什么样的注册方法:"></a>2.再把程序安好，看看它里面到底是卖的什么药-&gt;是个什么样的注册方法:</h3><p><img src="http://img.blog.csdn.net/20150210233727890?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20150210233746279?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>从以上两张图，可以知道明白了。<br>1&gt;爆破。根据功能的需求一个地方一个地方的找，找到后再一一修改，但这显然不是最好的方法，繁琐而且不完美。<br>2&gt;从积分入手。<br>（1）此软件的积分可以支付宝购买<br>（2）下载它推荐的“垃圾应用程序”<br>（3）帮他宣传。微博分享等等。<br>当然可以从这3方面的任何一方面入手，我认为都可以达到需要的刷积分的效果。<br>我的第一思路就是找到这个积分变量，并修改它。如果能成功，这样的破解就会是很完美的破解了。</p>
<h3 id="3-定位"><a href="#3-定位" class="headerlink" title="3.定位"></a>3.定位</h3><p>找字符串试试，到\res\values里面的String.xml里面看了一圈。<br><img src="http://img.blog.csdn.net/20150210233859740?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>这个获取积分成功是不是很诱人呢？<br>打开Public.xml。找了对应的ID<br><img src="http://img.blog.csdn.net/20150210233927352?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>0x7f060010。<br>OK，接下来我们在smali文件夹里搜索这个的引用。<br>发现了一个文件引用它  位置在：smali\com\movesky\a\c.smali</p>
<h3 id="4-分析代码"><a href="#4-分析代码" class="headerlink" title="4.分析代码"></a>4.分析代码</h3><p>由于对smali代码接触得不多，打开之后，发现完全看不懂。怎么办？没事~本来就是需要今后的学习。~既然看不懂smali代码，那我们为什么不可以换个代码看呢？<br>那就用Java decompiler吧  Java我总能看懂吧~<br><img src="http://img.blog.csdn.net/20150210233945963?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>先看看C类里写的是什么东西。<br>一共有2个函数，成功的函数代码如下：<br>代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public final void onSuccess(long paramLong)  </div><div class="line">  &#123;  </div><div class="line">    String str = Integer.toString((int)(paramLong / 1L)); //取相应任务的分值  </div><div class="line">    Log.i(&quot;ZRD&quot;, &quot;奖励积分:&quot; + str);///刷新分值显示  </div><div class="line">    Toast.makeText(this.d, this.d.getString(2131099664) + str, 0).show();//显示获取积分成功  </div><div class="line">    K.a(this.d, new Handler(), str, &quot;dianjing&quot;, &quot;Add&quot;);//把积分数据更新下  </div><div class="line">  &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>OK.显然按照我的思路来，最后一句代码当然更吸引我。那继续追踪K类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">public final class K  </div><div class="line">&#123;  </div><div class="line">  private static List&lt;NameValuePair&gt; bb;  </div><div class="line">  </div><div class="line">  private static JSONArray a(String paramString1, String paramString2, String paramString3, String paramString4, String paramString5)  </div><div class="line">  &#123;  </div><div class="line">    JSONArray localJSONArray = new JSONArray();  </div><div class="line">    JSONObject localJSONObject = new JSONObject();  </div><div class="line">    try  </div><div class="line">    &#123;  </div><div class="line">      localJSONObject.put(&quot;Fld_Points&quot;, paramString1);  </div><div class="line">      localJSONObject.put(&quot;Fld_Action&quot;, paramString2);  </div><div class="line">      localJSONObject.put(&quot;Fld_State&quot;, paramString3);  </div><div class="line">      localJSONObject.put(&quot;Fld_Source&quot;, paramString4);  </div><div class="line">      localJSONObject.put(&quot;Fld_Note&quot;, paramString5);  </div><div class="line">      localJSONArray.put(localJSONObject);  </div><div class="line">      return localJSONArray;  </div><div class="line">    &#125;  </div><div class="line">    catch (JSONException localJSONException)  </div><div class="line">    &#123;  </div><div class="line">      while (true)  </div><div class="line">      &#123;  </div><div class="line">        localJSONException.printStackTrace();  </div><div class="line">        ZrdCommon.ZrdLog.Log(&quot;Err=&quot; + localJSONException.getMessage());  </div><div class="line">        localJSONObject = new JSONObject();  </div><div class="line">      &#125;  </div><div class="line">    &#125;  </div><div class="line">  &#125;  </div><div class="line">  </div><div class="line">  public static void a(Context paramContext, Handler paramHandler)  </div><div class="line">  &#123;  </div><div class="line">    a(paramContext, new JSONArray(), paramHandler);  </div><div class="line">  &#125;  </div><div class="line">public static void a(Context paramContext, Handler paramHandler, String paramString1, String paramString2, String paramString3)  </div><div class="line">  &#123;  </div><div class="line">    a(paramContext, a(paramString1, &quot;1&quot;, &quot;1&quot;, paramString2, paramString3), paramHandler);  </div><div class="line">  &#125;  </div><div class="line">  </div><div class="line">  public static void a(Context paramContext, Handler paramHandler, String paramString1, String paramString2, String paramString3, String paramString4, String paramString5)  </div><div class="line">  &#123;  </div><div class="line">    a(paramContext, a(paramString1, paramString2, paramString3, paramString4, paramString5), paramHandler);  </div><div class="line">  &#125;  </div><div class="line">  </div><div class="line">  private static void a(Context paramContext, JSONArray paramJSONArray, Handler paramHandler)  </div><div class="line">  &#123;  </div><div class="line">    Activity localActivity = (Activity)paramContext;  </div><div class="line">    ArrayList localArrayList = new ArrayList();  </div><div class="line">    bb = localArrayList;  </div><div class="line">    localArrayList.add(new BasicNameValuePair(&quot;_VKey&quot;, AppJNI.i()));  </div><div class="line">    bb.add(new BasicNameValuePair(&quot;_MaxID&quot;, &quot;0&quot;));  </div><div class="line">    bb.add(new BasicNameValuePair(&quot;_DevID&quot;, n.a(localActivity)));  </div><div class="line">    bb.add(new BasicNameValuePair(&quot;_BundleID&quot;, paramContext.getPackageName()));  </div><div class="line">    bb.add(newBasicNameValuePair(&quot;_BundleVersion&quot;, paramContext.getString(2131099661)));  </div><div class="line">    bb.add(new BasicNameValuePair(&quot;_ChannelID&quot;, paramContext.getString(2131099662)));  </div><div class="line">    bb.add(new BasicNameValuePair(&quot;_PointsDetail&quot;, paramJSONArray.toString()));  </div><div class="line">    ZrdCommon.ZrdLog.Log(&quot;YSpoints Updata PointsDetail=&quot; + paramJSONArray.toString());  </div><div class="line">    new L(paramContext, paramHandler).start();  </div><div class="line">  &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>找到对应的函数，一共套了几层，稍微需要一点耐心，但并没有难度。上面的几个a函数都是对传进来参数的一切处理，都是字符串游戏。对上述代码分析后可得 private static void a(Context paramContext, JSONArray paramJSONArray, Handler paramHandler)这个函数是最关键的函数。<br>分析paramJSONArray里的内容如下：<br>[“Fld_Points”:str,              //这里的str就是完成对应任务的分数.toString（）<br> “Fld_Action”:”1”,<br> “Fld_State”:”1”,<br> “Fld_Source”:”dianjing”,<br> “Fld_Note”:”Add”]          //方法为Add</p>
<p>跟到这个时候发现这个函数的作用是客户端给服务器提交参数的函数。<br>悲剧了，分析了这么多~积分却不在本地。<br>于是这个时候可能又跳出有几种思路：<br>1&gt;劫持这个变量<br>2&gt;本地化，在本地完成任务达到免费使用<br>3&gt;骗服务器<br>又去String.xml翻了翻。发现一个新的东西<br><img src="http://img.blog.csdn.net/20150210234204306?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>URLPoints,那就是服务器存放APP积分的地址了。<br>进入如下：<br><img src="http://img.blog.csdn.net/20150210234232792?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>看到SumPoints 居然是个负的。<br>那我们可不可以不让它访问服务器而把那个变量改成自己想要的值呢？我觉得这是一种可行的思路。<br>因为第一次弄，思路也是天马行空。当时想，<br>他这种访问服务器获取积分的方法，地址都是一个PHP文件。那肯定要验证机器码的，然后我把手机机器码屏蔽掉了，发现积分溢出了。贴出两张图为证：</p>
<p><img src="http://img.blog.csdn.net/20150210234309231?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p><img src="http://img.blog.csdn.net/20150210234308391?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>这样这个程序也算是完美破解了~<br>第一次接触apk破解，难免有理解得不对的地方和弯路，希望大家能多多指正，多多交流方法，希望把不足之处告诉我，共同进步。<br>                                                                                    2014.11.22<br>                                                                                    By Ericky</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/10/27/菜鸟学习HOOK/">
  <time datetime="2014-10-27T10:30:00.000Z">
    2014-10-27
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/10/27/菜鸟学习HOOK/">菜鸟学习HOOK</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>自己从高中那时对黑客比较感兴趣，那时候去过很多论坛学所谓的“黑客技术”。同时也经常在一些QQ群，论坛里混，但见效甚微。<br>因为我很喜欢玩游戏，上大学后，同学们都发疯似的玩一款游戏—三国杀，现在玩的人已经很少了，被某公司抄袭后垄断了。由于当时学业繁重，然后自己又爱面子，所以在想如何学业不落下的同时游戏等级也能比别人高，上网找到了一款三国杀的刷分软件。兴高采烈得打开准备刷分，用了一天之后就不能用了，30元一个月的收费标准，穷学生哪能舍得啊？于是想找人破解，但转念一想，谁会帮你破解呢？还是自己来吧~自己动手，丰衣足食。上网+图书馆疯狂找资料，花了一个周末，把这个软件KO了，当时是高兴死了。那种成就感和兴奋感恐怕也只有亲身试过的人才知道。很快就刷到了150级了，比整天玩游戏的同学等级还要高，在满足了我虚荣心的同时也带我走向了逆向之门，或许这就是一种缘分吧。<br>好了，背景就不多说了。今天和大家一起学习一下C++中的HOOK API技术。相信大家都知道这是逆向PJ中的一个特别重要也是实用的技术。(<em>^__^</em>) </p>
<h2 id="一、-Hook介绍"><a href="#一、-Hook介绍" class="headerlink" title="一、  Hook介绍"></a>一、  Hook介绍</h2><p>钩子(Hook)，是Windows消息处理机制的一个平台,应用程序可以在上面设置子程以监视指定窗口的某种消息，而且所监视的窗口可以是其他进程所创建的。当消息到达后，在目标窗口处理函数之前处理它。钩子机制允许应用程序截获处理window消息或特定事件。<br> 我们知道Windows系统API函数都是被封装到DLL中，在某个应用程序要调用一个API函数的时候，如果这个函数所在的DLL没有被加载到本进程中则加载它，然后保存当前环境（各个寄存器和函数调用完后的返回地址等）。接着程序会跳转到这个API函数的入口地址去执行此处的指令。由此看来，我们想在调用真正的API之前先调用我们的函数，那么可以修改这个API函数的入口处的代码，使他先跳转到我们的函数地址，然后在我们的函数最后再调用原来的API函数。<br>简单来说HOOK API 可以理解成对程序将要执行系统函数的一个拦截， 拦截后执行自己写的代码以达到完成某种特定的目的，再恢复程序继续执行，很多PJ中的Patch 机器码，盗号木马等都是用这个方法。</p>
<h2 id="二、-Hook-API实战"><a href="#二、-Hook-API实战" class="headerlink" title="二、  Hook API实战"></a>二、  Hook API实战</h2><p>OK，既然我们需要实现一个这样的一个HOOK。当然需要两样东西，一是目标程序，一是我们的代码。</p>
<ol>
<li>程序：<br>新建一个dll工程文件目录如图：<br>附件 93152<br>我们自己新建一个Add.def文件，然后添加到工程中即可，如图我是添加到Source Files里。<br>跟exe有个main或者WinMain入口函数一样，DLL也有它自己的一个入口函数，就是DllMain。<br>我们打开dllmain.cpp  代码如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// dllmain.cpp : Defines the entry point for the DLL application.  </div><div class="line">#include &quot;stdafx.h&quot;  </div><div class="line">  </div><div class="line">int WINAPI add(int a, int b)  </div><div class="line">&#123;  </div><div class="line">  return a + b;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">BOOL APIENTRY DllMain(HANDLE hModule,  </div><div class="line">  DWORD  ul_reason_for_call,  </div><div class="line">  LPVOID lpReserved  </div><div class="line">  )  </div><div class="line">&#123;  </div><div class="line">  return TRUE;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>DEF文件是模块定义文件，模块定义 (.def) 文件为链接器提供有关被链接程序的导出、属性及其他方面的信息。生成 DLL 时，.def 文件最有用。由于存在可代替模块定义语句使用的链接器选项，通常不需要 .def 文件。也可以将 <strong>declspec(dllexport) 用作指定导出函数的手段。在链接器阶段可以使用 /DEF（指定模块定义文件）链接器选项调用 .def 文件。如果生成的 .exe 文件没有导出，使用 .def 文件将使输出文件较大并降低加载速度。<br>  在VC++中，生成DLL可以不使用.def文件。只需要在VC++的函数定义前要加</strong>declspec(dllexport)修饰就可以了。但是使用<strong>declspec(dllexport)和使用.def文件是有区别的。如果DLL是提供给VC++用户使用的，你只需要把编译DLL时产生的.lib提供给用户，它可以很轻松地调用你的DLL。但是如果你的DLL是供其他程序如VB、delphi,以及.NET用户使用的，那么会产生一个小麻烦。因为VC++对于</strong>declspec(dllexport)声明的函数会进行名称转换，如下面的函数：<br><strong>declspec(dllexport) int </strong>stdcallIsWinNT()<br>会转换为IsWinNT@0，这样你在VB中必须这样声明：<br>Declare Function IsWinNT Lib “my.dll” Alias “IsWinNT@0” () As Long<br>@的后面的数由于参数类型不同而可能不同。这显然不太方便。所以如果要想避免这种转换，就要使用.def文件方式。<br>EXPORTS后面的数可以不给，系统会自动分配一个数。对于VB、PB、Delphi用户，通常使用按名称进行调用的方式，这个数关系不大，但是对于使用.lib链接的VC程序来说，不是按名称进行调用，而是按照这个数进行调用的，所以最好给出。<br>  .def 文件中的第一条 LIBRARY 语句不是必须的，但LIBRARY 语句后面的 DLL 的名称必须正确，即与生成的动态链接库的名称必须匹配。此语句将 .def 文件标识为属于 DLL。链接器将此名称放到 DLL 的导入库中。<br>EXPORTS 语句列出名称，可能的话还会列出 DLL 导出函数的序号值。通过在函数名的后面加上 @ 符和一个数字，给函数分配序号值。当指定序号值时，序号值的范围必须是从 1 到 N，其中 N 是 DLL 导出函数的个数。<br>LIBRARY BTREE<br>EXPORTS<br>Insert @1<br>Delete @2<br>Member @3<br>Min @4<br>如果使用 MFC DLL 向导创建 MFC DLL，则向导将为您创建主干 .def 文件并将其自动添加到项目中。添加要导出到此文件的函数名。对于非 MFC DLL，必须亲自创建 .def 文件并将其添加到项目中。<br>如果导出 C++ 文件中的函数，必须将修饰名放到 .def 文件中，或者通过使用外部“C”定义具有标准 C 链接的导出函数。如果需要将修饰名放到 .def 文件中，则可以通过使用 DUMPBIN 工具或 /MAP 链接器选项来获取修饰名。请注意，编译器产生的修饰名是编译器特定的。如果将 Visual C++ 编译器产生的修饰名放到 .def 文件中，则链接到 DLL 的应用程序必须也是用相同版本的 Visual C++ 生成的，这样调用应用程序中的修饰名才能与 DLL 的 .def 文件中的导出名相匹配。<br>因此def文件代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">LIBRARY  Add  </div><div class="line">DESCRIPTION &quot;ADD LA&quot;  </div><div class="line">EXPORTS  </div><div class="line">add  @1;</div></pre></td></tr></table></figure></p>
<p>在如图位置可以检验是否导入了：<br><img src="http://img.blog.csdn.net/20150211100607991?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>由此，一个简单的dll我们就完成了。<br>下面用MFC写一个程序来调用我们的dll。<br>还是新建一个工程,目录如下<br><img src="http://img.blog.csdn.net/20150211100637754?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>MFC的.Cpp中主要代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">void CMFCApplication5Dlg::OnBnClickedButton1()  </div><div class="line">&#123;  </div><div class="line">  // TODO: Add your control notification handler code here  </div><div class="line">  </div><div class="line">    HINSTANCE hAddDll = NULL;  </div><div class="line">    typedef int (WINAPI*AddProc)(int a, int b);//函数原型定义    </div><div class="line">    AddProc add;  </div><div class="line">    if (hAddDll == NULL)  </div><div class="line">    &#123;  </div><div class="line">      hAddDll = ::LoadLibrary(_T(&quot;Win32DLL.dll&quot;));//加载dll    </div><div class="line">    &#125;  </div><div class="line">    add = (AddProc)::GetProcAddress(hAddDll, &quot;add&quot;);//获取函数add地址    </div><div class="line">  </div><div class="line">    int a = 123;  </div><div class="line">    int b = 456;  </div><div class="line">    int c = add(a, b);   </div><div class="line">    CString tem;  </div><div class="line">    tem.Format(_T(&quot;%d+%d=%d&quot;), a, b, c);  </div><div class="line">    AfxMessageBox(tem);  </div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>效果如图：出现这个说明你成功了:<br><img src="http://img.blog.csdn.net/20150211100725599?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>一个调用dll中加法函数的MFC程序我们就完成了，下面就需要自己写一个dll，让程序执行我们的代码。<br>新建一个MFC的 dll工程，工程名为Hook，然后我们在Hook.cpp文件里面编写的代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div></pre></td><td class="code"><pre><div class="line">// Hook.cpp : Defines the initialization routines for the DLL.  </div><div class="line">#include &quot;stdafx.h&quot;  </div><div class="line">#include &quot;Hook.h&quot;  </div><div class="line">  </div><div class="line">#ifdef _DEBUG  </div><div class="line">#define new DEBUG_NEW  </div><div class="line">#endif  </div><div class="line">//变量定义    </div><div class="line">  </div><div class="line">#pragma data_seg(&quot;SHARED&quot;) //不同Instance共享的该变量     </div><div class="line">static HHOOK  hhk = NULL; //鼠标钩子句柄    </div><div class="line">static HINSTANCE hinst = NULL; //本dll的实例句柄 (hook.dll)    </div><div class="line">#pragma data_seg()    </div><div class="line">#pragma comment(linker, &quot;/section:SHARED,rws&quot;)    </div><div class="line">//以上的变量为共享    </div><div class="line">  </div><div class="line">CString temp; //用于显示错误的临时变量    </div><div class="line">bool bHook = false; //是否Hook了函数    </div><div class="line">bool m_bInjected = false; //是否对API进行了Hook    </div><div class="line">BYTE OldCode[5]; //原程序API入口代码    </div><div class="line">BYTE NewCode[5]; //新跳转的API代码 (jmp xxxx)    </div><div class="line">typedef int (WINAPI*AddProc)(int a, int b);//add.dll中的add函数定义    </div><div class="line">AddProc add; //add.dll中的add函数    </div><div class="line">HANDLE hProcess = NULL; //所处进程的句柄    </div><div class="line">FARPROC pfadd;  //指向add函数的远指针    </div><div class="line">DWORD dwPid;  //所处进程ID    </div><div class="line">//end of 变量定义    </div><div class="line">// CHookApp  </div><div class="line">  </div><div class="line">BEGIN_MESSAGE_MAP(CHookApp, CWinApp)  </div><div class="line">END_MESSAGE_MAP()  </div><div class="line">  </div><div class="line">//鼠标钩子过程，什么事情也不做，目的是注入dll到程序中    </div><div class="line">LRESULT CALLBACK MouseProc(int nCode, WPARAM wParam, LPARAM lParam)  </div><div class="line">&#123;  </div><div class="line">  return CallNextHookEx(hhk, nCode, wParam, lParam);  </div><div class="line">&#125;  </div><div class="line">//开启钩子的函数    </div><div class="line">void HookOn()  </div><div class="line">&#123;  </div><div class="line">  ASSERT(hProcess != NULL);  </div><div class="line">  </div><div class="line">  DWORD dwTemp = 0;  </div><div class="line">  DWORD dwOldProtect;  </div><div class="line">  </div><div class="line">  //将内存保护模式改为可写,老模式保存入dwOldProtect    </div><div class="line">  VirtualProtectEx(hProcess, pfadd, 5, PAGE_READWRITE, &amp;dwOldProtect);  </div><div class="line">  //将所属进程中add()的前5个字节改为Jmp Myadd     </div><div class="line">  WriteProcessMemory(hProcess, pfadd, NewCode, 5, 0);  </div><div class="line">  //将内存保护模式改回为dwOldProtect    </div><div class="line">  VirtualProtectEx(hProcess, pfadd, 5, dwOldProtect, &amp;dwTemp);  </div><div class="line">  </div><div class="line">  bHook = true;  </div><div class="line">&#125;  </div><div class="line">//关闭钩子的函数    </div><div class="line">void HookOff()//将所属进程中add()的入口代码恢复    </div><div class="line">&#123;  </div><div class="line">  ASSERT(hProcess != NULL);  </div><div class="line">  </div><div class="line">  DWORD dwTemp = 0;  </div><div class="line">  DWORD dwOldProtect;  </div><div class="line">  </div><div class="line">  VirtualProtectEx(hProcess, pfadd, 5, PAGE_READWRITE, &amp;dwOldProtect);  </div><div class="line">  WriteProcessMemory(hProcess, pfadd, OldCode, 5, 0);  </div><div class="line">  VirtualProtectEx(hProcess, pfadd, 5, dwOldProtect, &amp;dwTemp);  </div><div class="line">  bHook = false;  </div><div class="line">&#125;  </div><div class="line">//然后，写我们自己的Myadd()函数    </div><div class="line">int WINAPI Myadd(int a, int b)  </div><div class="line">&#123;  </div><div class="line">  //截获了对add()的调用，我们给a,b都加上一定的数  </div><div class="line">  a = a + 987;  </div><div class="line">  b = b + 654;  </div><div class="line">  </div><div class="line">  HookOff();//关掉Myadd()钩子防止死循环    </div><div class="line">  </div><div class="line">  int ret;  </div><div class="line">  ret = add(a, b);  </div><div class="line">  </div><div class="line">  HookOn();//开启Myadd()钩子    </div><div class="line">  </div><div class="line">  return ret;  </div><div class="line">&#125;  </div><div class="line">//好，最重要的HOOK函数：   </div><div class="line">void Inject()  </div><div class="line">&#123;  </div><div class="line">  </div><div class="line">  if (m_bInjected == false)  </div><div class="line">  &#123; //保证只调用1次    </div><div class="line">    m_bInjected = true;  </div><div class="line">  </div><div class="line">    //获取add.dll中的add()函数    </div><div class="line">    HMODULE hmod = ::LoadLibrary(_T(&quot;Win32DLL.dll&quot;));  </div><div class="line">    add = (AddProc)::GetProcAddress(hmod, &quot;add&quot;);  </div><div class="line">    pfadd = (FARPROC)add;  </div><div class="line">  </div><div class="line">    if (pfadd == NULL)  </div><div class="line">    &#123;  </div><div class="line">      AfxMessageBox(L&quot;cannot locate add()&quot;);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    // 将add()中的入口代码保存入OldCode[]    </div><div class="line">    _asm  </div><div class="line">    &#123;  </div><div class="line">      lea edi, OldCode  </div><div class="line">        mov esi, pfadd  </div><div class="line">        cld  </div><div class="line">        movsd  </div><div class="line">        movsb  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    NewCode[0] = 0xe9;//实际上0xe9就相当于jmp指令    </div><div class="line">    //获取Myadd()的相对地址    </div><div class="line">    _asm  </div><div class="line">    &#123;  </div><div class="line">      lea eax, Myadd  </div><div class="line">        mov ebx, pfadd  </div><div class="line">        sub eax, ebx  </div><div class="line">        sub eax, 5  </div><div class="line">        mov dword ptr[NewCode + 1], eax  </div><div class="line">    &#125;  </div><div class="line">    //填充完毕，现在NewCode[]里的指令相当于Jmp Myadd    </div><div class="line">    HookOn(); //可以开启钩子了    </div><div class="line">  &#125;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">  </div><div class="line">CHookApp::CHookApp()  </div><div class="line">&#123;  </div><div class="line">    </div><div class="line">&#125;  </div><div class="line">CHookApp theapp;  </div><div class="line">  </div><div class="line">  </div><div class="line">//鼠标钩子安装函数:    </div><div class="line">BOOL InstallHook()  </div><div class="line">&#123;  </div><div class="line">  </div><div class="line">  hhk = ::SetWindowsHookEx(WH_MOUSE, MouseProc, hinst, 0);  </div><div class="line">  </div><div class="line">  return true;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">//卸载鼠标钩子函数    </div><div class="line">void UninstallHook()  </div><div class="line">&#123;  </div><div class="line">  ::UnhookWindowsHookEx(hhk);  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">  </div><div class="line">  </div><div class="line">//在dll实例化中获得一些参数    </div><div class="line">BOOL CHookApp::InitInstance()  </div><div class="line">&#123;  </div><div class="line">  CWinApp::InitInstance();  </div><div class="line">  </div><div class="line">  //获得dll 实例，进程句柄    </div><div class="line">  hinst = ::AfxGetInstanceHandle();  </div><div class="line">  DWORD dwPid = ::GetCurrentProcessId();  </div><div class="line">  hProcess = OpenProcess(PROCESS_ALL_ACCESS, 0, dwPid);  </div><div class="line">  //调用注射函数    </div><div class="line">  Inject();  </div><div class="line">  return TRUE;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着需要配置一下DEF文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">; Hook.def : Declares the module parameters for the DLL.  </div><div class="line">LIBRARY &quot;HOOK&quot;  </div><div class="line">EXPORTS  </div><div class="line">InstallHook    </div><div class="line">UninstallHook</div></pre></td></tr></table></figure></p>
<p>最后HOOK成功的效果如图所示：<br><img src="http://img.blog.csdn.net/20150211100813681?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>值得一提的是很多人都是改API开头的5个字节，但是现在很多杀毒软件用这样的方法检查API是否被HOOK，或其他病毒木马在你之后又改了前5个字节，这样就会互相覆盖，最后一个HOOK API的操作才是有效的。挂钩的方法很多，这里只是最基础的一种。希望大家多多补充。多多指正。<br>了解好以下的问题能够更好的提升自己的HOOK水平:<br>1.CPU指令长度问题，在32位系统里，一条JMP/CALL指令的长度是5个字节，因此你只有替换API里超过5个字节长度的机器码（或者替换几条指令长度加起来是5字节的指令），否则会影响被更改的小于5个字节的机器码后面的数条指令，甚至程序流程会被打乱，产生不可预料的后果；<br>2.参数问题，为了访问原API的参数，你要通过EBP或ESP来引用参数，因此你要非常清楚你的HOOK代码里此时的EBP/ESP的值是多少；<br>3.时机的问题，有些HOOK必须在API的开头，有些必须在API的尾部，比如HOOK CreateFilaA()，如果你在API尾部HOOK API，那么此时你就不能写文件，甚至不能访问文件；HOOK RECV()，如果你在API头HOOK，此时还没有收到数据，你就去查看RECV()的接收缓冲区，里面当然没有你想要的数据，必须等RECV()正常执行后，在RECV()的尾部HOOK，此时去查看RECV()的缓冲区，里面才有想要的数据；<br>4.上下文的问题，有些HOOK代码不能执行某些操作，否则会破坏原API的上下文，原API就失效了；<br>5.同步问题，在HOOK代码里尽量不使用全局变量，而使用局部变量，这样也是模块化程序的需要；<br>6.最后要注意的是，被替换的CPU指令的原有功能一定要在HOOK代码的某个地方模拟实现。</p>
<p>若有疏漏之处，欢迎各位大侠指正！<br> 2014.10.27 6：30 pm </p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2014/03/22/大学校园网的那点事/">
  <time datetime="2014-03-22T15:01:00.000Z">
    2014-03-22
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2014/03/22/大学校园网的那点事/">大学校园网的那点事</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>  关于数字XX高校，我的几点看法<br>正如孔子所说，“逝者如斯夫，不舍昼夜！”时间如流水落花般逝去，二十二的年龄，毕业的季节。大四下，我会好好欣赏XX高校的各式风景。</p>
<hr>
<p>好了，感慨不多发了，我们进入正题。写这篇文章的主要目的是分析一下数字XX高校的不足之处，好让这个系统能够更加完美。当然，有则改之，无则加勉。<br>其实，在刚发这个校园卡上网的时候，见着6位数字的默认密码，我就曾大胆的猜测过，用穷举法不就能登录别人的帐号吗？对，就是一个一个试，当然不是靠我们人来手工操作，<br>6位数字的密码，共100万个，人工输入尝试当然是不可取的。但是写程序呢？那又会怎么样呢？</p>
<hr>
<h2 id="一、暴力密码拆解程序的实现。"><a href="#一、暴力密码拆解程序的实现。" class="headerlink" title="一、暴力密码拆解程序的实现。"></a>一、暴力密码拆解程序的实现。</h2><p><img src="http://img.blog.csdn.net/20150127230332393?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="这里写图片描述"></p>
<p>这是登录界面，校内网的同学就能看到，地址：<a href="http://61.137.86.87:8080/portalNat444/index.jsp" target="_blank" rel="external">http://61.137.86.87:8080/portalNat444/index.jsp</a></p>
<p>我们平常登录是输入帐号密码，点击登陆按钮进行登录，这就是说明我们给服务端发送了一个数据，服务端接收到我们的数据然后判断帐号密码的正确性，最后给我们正确的响应。<br>我们要用的是：<br>网页封包抓取—-&gt;即我们要知道计算机向服务端到底发送了什么样的数据包，便能依瓢画葫芦，直接实现数据包尝试登录。<br>抓包的工具很多，如果你还在用Httpwatch的话，我可以告诉你，你没有跟上潮流。Httpwatch固然老牌，但是貌似在64位系统下不兼容。这里我用的是Wireshark，一款相当nice的抓包工具，当然如果你是Firefox浏览器的话，可以直接用自带的debug。<br><img src="http://img.blog.csdn.net/20150127230401066?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="这里写图片描述"></p>
<p>具体操作可以百度Wireshark的user manual，我这里不多加阐述。</p>
<p>根据Wireshark抓包，可以知道抓到的包是POST 类型的，当然在网页的源码里也能找到<br><img src="http://img.blog.csdn.net/20150127230345578?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="这里写图片描述"></p>
<p>当然，后面的便是date.resultCode为0时，就登录成功，如果你能成功控制服务器，把resultCode设置成0，则会永远登录成功，显然这是不明智的。</p>
<p>回归正题，我们需要发送的post数据包为:<br>网址：<a href="http://61.137.86.87:8080/portalNat444/AccessServices/login" target="_blank" rel="external">http://61.137.86.87:8080/portalNat444/AccessServices/login</a><br>方式：POST<br>数据内容：<br>accountID=010103100527%40zndx.inter   //这里的%40 代表的是@<br>&amp;password=56aad664fa33bffb42b2c0be23ebc5efce17d7f82c0d75ade387941c690063382fef34369b1d7c929945fdbd4ba28bc77db7b028d022464646165acedf2b5deb2ce1fb3d4dc074c55888e299d384af306572a368f468d88fdafdaefebfa39bf84fad0530775d37f35dc79594ba62be4fc5189544397ed97054f4fc375903b6<br>&amp;brasAddress=59df7586<br>&amp;userIntranetAddress=10.96.85.80<br>我们可以看到，一共发送给了服务器4个参数：<br>第一个参数accountID：（学号加上@zndx.inter）<br>第二个参数password：顾名思义，这是密码。不过并不是我们所期待的6位数字，这是因为他经过了处理，加密了，加密算法为RSA1024bit，这个算法后面会讲到。<br>第三个参数brasAddress：我这里是59df7586，应该是本机的物理特征，多抓取了几个封包，发现这个不变，就不必管它了，不影响我们工作。<br>第四个参数userIntranetAddress：这是本机内网IP，我们可以在cmd中输入ipconfig/all或者ipconfig进行查看：<br><img src="http://img.blog.csdn.net/20150127230415875?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="这里写图片描述"></p>
<p>也可以写一个小程序遍历本机的ip地址。</p>
<p>这是我写的一个小程序：<br><img src="http://img.blog.csdn.net/20150127230523013?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="这里写图片描述"></p>
<p>也可以用C++：<br><img src="http://img.blog.csdn.net/20150127230517703?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="这里写图片描述"></p>
<p>程序C++源码如下：<br>‘’’</p>
<p>#include <stdio.h>   </stdio.h></p>
<p>#include <winsock2.h>   </winsock2.h></p>
<p>#pragma comment(lib,”ws2_32.lib”)   </p>
<p>int doit(int, char **)<br>{<br>char host_name[255];<br>//获取本地主机名称<br>if (gethostname(host_name, sizeof(host_name)) == SOCKET_ERROR) {<br>printf(“Error %d when getting local host name.\n”, WSAGetLastError());<br>return 1;<br>}<br>printf(“Host name is: %s\n”, host_name);   </p>
<p>//从主机名数据库中得到对应的“主机”<br>struct hostent *phe = gethostbyname(host_name);<br>if (phe == 0) {<br>printf(“Yow! Bad host lookup.”);<br>return 1;<br>}   </p>
<p>//循环得出本地机器所有IP地址<br>for (int i = 0; phe-&gt;h_addr_list[i] != 0; ++i) {<br>struct in_addr addr;<br>memcpy(&amp;addr, phe-&gt;h_addr_list[i], sizeof(struct in_addr));<br>printf(“IPAddress %d : %s\n” , i, inet_ntoa(addr));<br>}<br>printf(“如果有10.96的IP address，则说明此Ip为本机Ipv4地址<strong><strong><strong><strong>**</strong></strong></strong></strong>  \n” );<br>printf(“如果无10.96的IP address，则说明计算机未连通校园网<strong><strong><strong><strong>**</strong></strong></strong></strong>  \n” );<br>return 0;<br>}   </p>
<p>int main(int argc, char *argv[])<br>{<br>WSAData wsaData;<br>if (WSAStartup(MAKEWORD(1, 1), &amp;wsaData) != 0) {<br>return 255;<br>}   </p>
<p>int retval = doit(argc, argv);   </p>
<p>WSACleanup();   </p>
<p>return retval;<br>}<br>‘’’<br>好了，一共4个参数，我们解决了3个，头痛的是第二个被加密的密码是如何由6位数字转换成256位的加密后的字符串的。</p>
<p>256位的加密字符串很容易让人联想到RSA1024加密，这是一种单向加密，多用于商业用途，强度取决于对大数的因式分解。具体可以到维基百科看。<br>这种过高的加密强度使得我望而却步。<br>正要放弃，却发现了一个致命的弱点，有一个security.js的文件又再给人一线希望。将源文件下载到本地，分析后就知道了由6位数字如何魔术般成为了256位字符。<br>一共有这么几个文件：<br><img src="http://img.blog.csdn.net/20150127230724288?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="这里写图片描述"></p>
<p>我们打开security.js，可以发现，我们的猜测并没有错：<br><img src="http://img.blog.csdn.net/20150127230711968?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="这里写图片描述"></p>
<p>一共700行代码，不一一贴出</p>
<hr>
<p>无论是注解还是函数名称，都证明了是RSA1024无疑。可笑的是，这个代码是05年写的，10年经过修改。并且在调试过程中，我发现了供应商是华为，无疑。<br><img src="http://img.blog.csdn.net/20150127230815815?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="这里写图片描述"></p>
<p>既然有了源码，我们也能发现这和我们抓包所得到的数据一致，只是密码用了一个函数encodeURIComponent（）函数进行编码后再用security.js里写好的RSA加密算法进行加密。</p>
<p>搞定了POST的四个参数，用一个循环和100万个密码进行暴力破解，也就能实现用别人的一个已知的学号（默认密码）进行登录。</p>
<h2 id="二、暴力破解的效率"><a href="#二、暴力破解的效率" class="headerlink" title="二、暴力破解的效率"></a>二、暴力破解的效率</h2><p>百度网盘曾经有段时间是4位数字密码，即1万个数字，即使算最后一次才尝试成功，也在10分钟以内。我们就按这个概率算，当然，你可以计算时间的期望值如果你的概率论学得不错。就算10分钟，1000分钟也能尝试出一个密码，约16个小时。是不是很nice，按期望的话，平均9小时就差不多能得到一个帐号的密码。<br>当然官方不是吃素的，他当然会考虑到这个可能性。</p>
<h2 id="三、官方限制"><a href="#三、官方限制" class="headerlink" title="三、官方限制"></a>三、官方限制</h2><p>可能考虑到有人会尝试穷举所有密码，或是因为代码的严谨性，jQuery-timers.1.2.js这个文件里的内容就是来限制大家的次数，我大概尝试了下，1个帐号连续输错10次密码后会提示错误信息“无法获取”，大约停止3分钟。如果按照这个官方设计好的方式来算，10次密码耗时3分钟，100万次耗时30万分钟，约208天的时间，当然，就不存在穷举来窃取他人帐号，因为没有人愿意发大半年时间就破解一个密码，可能还不够交电费。那我们就放弃吗？<br>Of course not！尽管它是限制了次数，我们可以用一种巧妙的方法躲过，方法很简单：我们可以尝试010103100101的密码10次，一直到无法获取，开始尝试2号学号的10次，这样我们电脑的效率能实现最大化，概率当然不变，还是9小时左右能拿到一个号。<br>我还发现，代码里存在一个登录标志，这使得多线程无法得以实现。不过不怕，每个寝室不是你一个人在战斗，跟他们说清情况，结果可想而知，你懂的。</p>
<h2 id="四、优化"><a href="#四、优化" class="headerlink" title="四、优化"></a>四、优化</h2><p>100万次的次数太多，为了使得尝试次数减少，我向同学要了大概10个左右的密码，基本可以剔除6位数字里全相同的，5个数字相同的以及4个数字相同的密码。<br>这样的密码可以不用尝试：<br>11111；22222；11115；344445；863888；<br>用排列组合，我们可以算出，剔除了以上几种可能后，密码的尝试次数将减少到746640次，这样的话，时间又能缩短了。当然，你还可以去除一些123456；765432；这样的密码，具体可以参考双色球的一些软件的算法。这里不做赘述。</p>
<h2 id="五、其他"><a href="#五、其他" class="headerlink" title="五、其他"></a>五、其他</h2><p>除了温柔的暴力拆解密码以外，当然可以采取直接的入侵手段，那样便会方便很多，当然完成后记得删除telnet 和http等日志。</p>
<p>总的来说，数字XX高校还是设计得不够完善。<br>提出几点建议如下：<br>1.大家不要嫌麻烦，建议改下密码，6位数字并不安全。<br>2.数字XX高校应把源码藏好，不能让外面轻易得到，这点是很值得改善的。<br>3.源代码里的验证码都被注释了起来：</p>
<p><img src="http://img.blog.csdn.net/20150127230912396?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="这里写图片描述"></p>
<p>图一：jsp中的<br>Js中的validateCode 也全部不再使用，尽管提高了学生上网的方便，同时也使得帐号的安全性下降了。</p>
<h2 id="4-其他的就是网络攻防了，这就看管理员的水平了。"><a href="#4-其他的就是网络攻防了，这就看管理员的水平了。" class="headerlink" title="4.其他的就是网络攻防了，这就看管理员的水平了。"></a>4.其他的就是网络攻防了，这就看管理员的水平了。</h2><h2 id="声明：本人水平有限，若有不正确之处，还望各位大侠指正。"><a href="#声明：本人水平有限，若有不正确之处，还望各位大侠指正。" class="headerlink" title="声明：本人水平有限，若有不正确之处，还望各位大侠指正。"></a>声明：本人水平有限，若有不正确之处，还望各位大侠指正。</h2><pre><code>     Ericky
2014年03月22日
</code></pre><p>附录一：公钥定义处</p>
<p><img src="http://img.blog.csdn.net/20150127230931781?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="这里写图片描述"></p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2013/07/05/【.Net】编写的一个crackme的分析/">
  <time datetime="2013-07-05T00:38:00.000Z">
    2013-07-05
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2013/07/05/【.Net】编写的一个crackme的分析/">【.Net】编写的一个crackme的分析</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>我们用.Net Reflector  载入</p>
<p>找到关键处  按钮事件：<br>btn_ok_Click(Object, EventArgs) : Void</p>
<p>对于的关键代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Private Sub btn_ok_Click(ByVal sender As Object, ByVal e As EventArgs)  </div><div class="line">    If (Me.textBox_Pass.Text = &quot;&quot;) Then  </div><div class="line">        MessageBox.Show(&quot;请输入密码!&quot;)  </div><div class="line">    Else  </div><div class="line">        Dim array As Char() = Me.textBox_Pass.Text.Replace(&quot;.&quot;, &quot;-&quot;).Replace(&quot;7&quot;, &quot;t&quot;).Replace(&quot;4&quot;, &quot;a&quot;).Replace(&quot;1&quot;, &quot;I&quot;).Replace(&quot;0&quot;, &quot;o&quot;).Replace(&quot;O&quot;, &quot;0&quot;).ToCharArray  </div><div class="line">        Array.Reverse(array)  </div><div class="line">        Dim s As New String(array)  </div><div class="line">        s.ToUpper  </div><div class="line">        Dim chArray2 As Char() = Convert.ToBase64String(Encoding.GetEncoding(&quot;UTF-8&quot;).GetBytes(s)).ToCharArray  </div><div class="line">        Array.Reverse(chArray2)  </div><div class="line">        Dim str2 As New String(chArray2)  </div><div class="line">        Dim str3 As New String(Convert.ToBase64String(Encoding.GetEncoding(&quot;UTF-8&quot;).GetBytes(str2)).ToCharArray)  </div><div class="line">        If (str3 = &quot;PTBpVGxSM1lqTWtVaE4yU0pOM1J2Qnph&quot;) Then  </div><div class="line">            MessageBox.Show(&quot;密码正确！密码就是Key!&quot;, &quot;成功&quot;)  </div><div class="line">        Else  </div><div class="line">            MessageBox.Show(&quot;密码错误!&quot;, &quot;失败&quot;)  </div><div class="line">        End If  </div><div class="line">    End If  </div><div class="line">  </div><div class="line">End Sub</div></pre></td></tr></table></figure></p>
<p>下面我们分析一下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">If (Me.textBox_Pass.Text = &quot;&quot;) Then  </div><div class="line">       MessageBox.Show(&quot;请输入密码!&quot;)  </div><div class="line">　Else</div></pre></td></tr></table></figure></p>
<p>为空则提示错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Dim array As Char() = Me.textBox_Pass.Text.Replace(&quot;.&quot;, &quot;-&quot;).Replace(&quot;7&quot;, &quot;t&quot;).Replace(&quot;4&quot;, &quot;a&quot;).Replace(&quot;1&quot;, &quot;I&quot;).Replace(&quot;0&quot;, &quot;o&quot;).Replace(&quot;O&quot;, &quot;0&quot;).ToCharArray</div></pre></td></tr></table></figure>
<p>将输入的字符串（key）中的“.”换成“-”，“7”换成“t”，“4”换成“a”，。。。等</p>
<p>Array.Reverse(array)</p>
<p>将替换过之后的序列号用Reverse()函数将一个字符串中最后一个字符放置到另一个字符串的第一个字符位置、倒数第二个字符放置在另一个字符串的第二个字符位置，以此类推。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Dim s As New String(array)  </div><div class="line">        s.ToUpper</div></pre></td></tr></table></figure></p>
<p>将array 给定义的变量S，将字符串首位变为大写<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Dim chArray2 As Char() = Convert.ToBase64String(Encoding.GetEncoding(&quot;UTF-8&quot;).GetBytes(s)).ToCharArray  </div><div class="line">        Array.Reverse(chArray2)  </div><div class="line">        Dim str2 As New String(chArray2)  </div><div class="line">        Dim str3 As New String(Convert.ToBase64String(Encoding.GetEncoding(&quot;UTF-8&quot;).GetBytes(str2)).ToCharArray)  </div><div class="line"> If (str3 = &quot;PTBpVGxSM1lqTWtVaE4yU0pOM1J2Qnph&quot;) Then  </div><div class="line">            MessageBox.Show(&quot;密码正确！密码就是Key!&quot;, &quot;成功&quot;)  </div><div class="line">        Else  </div><div class="line">            MessageBox.Show(&quot;密码错误!&quot;, &quot;失败&quot;)  </div><div class="line">        End If  </div><div class="line">    End If  </div><div class="line">  </div><div class="line">End Sub</div></pre></td></tr></table></figure></p>
<p>将S字符串base64编码后 倒转 再经过base64编码，与固定字符串“PTBpVGxSM1lqTWtVaE4yU0pOM1J2Qnph”比较，同则注册成功。<br>分析了加密过程，我们可以逆向的来找注册码：</p>
<p>第一步：base64解码（“PTBpVGxSM1lqTWtVaE4yU0pOM1J2Qnph”）= “=0iTlR3YjMkUhN2SJN3RvBza”</p>
<p>第二步：Array.Reverse（“=0iTlR3YjMkUhN2SJN3RvBza”）=“azBvR3NJS2NhUkMjY3RlTi0=”</p>
<p>第三步：base64解码（“azBvR3NJS2NhUkMjY3RlTi0= ”）= “k0oGsIKcaRC#cteN-”</p>
<p>第四步：首字符变小写，即不变</p>
<p>第五步：Array.Reverse后替换：得到最后的注册码：<br>.Ne7c#CR4cK1sG0Ok</p>
<p>本文的三个函数附录：</p>
<p>Toupper：<br>功能：将字符转换为大写英文字母</p>
<p>Tolower：<br>功 能: 把字符转换成小写字母,非字母字符不做出处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Array.Reverse  </div><div class="line">  </div><div class="line">public static string  ReverseByArray(this string  original)  </div><div class="line">&#123;  </div><div class="line">    char[] c = original.ToCharArray();  </div><div class="line">    Array.Reverse(c);  </div><div class="line">    return new string(c);  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2013/06/26/对一游戏外挂浅浅的分析/">
  <time datetime="2013-06-25T19:05:00.000Z">
    2013-06-26
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2013/06/26/对一游戏外挂浅浅的分析/">对一游戏外挂浅浅的分析</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>夜阑静，已是凌晨2：11分，明天还要实习，但这几天在研究一个网页游戏的辅助，也分享下自己的一些笔记和心得，虽然我是个大菜鸟。</p>
<p>真的是很遗憾，今天花了6，7个小时分析，基本上每一行都写了注释，后来分析了另外一个程序，注释和断点都清除了。下次一定要保存好！大家凑合着看吧T T</p>
<h2 id="1-查壳"><a href="#1-查壳" class="headerlink" title="1.查壳"></a>1.查壳</h2><p>PEID—-&gt;ASPack 2.12 -&gt; Alexey Solodovnikov<br>手脱<br>脚本脱<br>脱壳机脱<br>都行<br>记得用LordPE 和ImportREC 修复一下就好了。</p>
<h2 id="2-来到代码入口点："><a href="#2-来到代码入口点：" class="headerlink" title="2.来到代码入口点："></a>2.来到代码入口点：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">004F568D &gt;  55              push ebp  </div><div class="line">004F568E    8BEC            mov ebp,esp  </div><div class="line">004F5690    6A FF           push -0x1  </div><div class="line">004F5692    68 084B5500     push Dumped_.00554B08  </div><div class="line">004F5697    68 44804F00     push Dumped_.004F8044  </div><div class="line">004F569C    64:A1 00000000  mov eax,dword ptr fs:[0]  </div><div class="line">004F56A2    50              push eax  </div><div class="line">004F56A3    64:8925 0000000&gt;mov dword ptr fs:[0],esp  </div><div class="line">004F56AA    83EC 58         sub esp,0x58  </div><div class="line">004F56AD    53              push ebx  </div><div class="line">004F56AE    56              push esi  </div><div class="line">004F56AF    57              push edi</div></pre></td></tr></table></figure>
<p>明显的C++头。<br>我在MessageBoxA 下断点：<br>注册按钮之后<br>断下来了来到:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">77D507EA &gt;  8BFF            mov edi,edi  </div><div class="line">77D507EC    55              push ebp  </div><div class="line">77D507ED    8BEC            mov ebp,esp  </div><div class="line">77D507EF    833D BC14D777 0&gt;cmp dword ptr ds:[0x77D714BC],0x0  </div><div class="line">77D507F6    74 24           je short user32.77D5081C  </div><div class="line">77D507F8    64:A1 18000000  mov eax,dword ptr fs:[0x18]  </div><div class="line">77D507FE    6A 00           push 0x0  </div><div class="line">77D50800    FF70 24         push dword ptr ds:[eax+0x24]  </div><div class="line">77D50803    68 241BD777     push user32.77D71B24  </div><div class="line">77D50808    FF15 C412D177   call dword ptr ds:[&lt;&amp;KERNEL32.Interlocke&gt;; kernel32.InterlockedCompareExchange  </div><div class="line">77D5080E    85C0            test eax,eax  </div><div class="line">77D50810    75 0A           jnz short user32.77D5081C  </div><div class="line">77D50812    C705 201BD777 0&gt;mov dword ptr ds:[0x77D71B20],0x1  </div><div class="line">77D5081C    6A 00           push 0x0  </div><div class="line">77D5081E    FF75 14         push dword ptr ss:[ebp+0x14]  </div><div class="line">77D50821    FF75 10         push dword ptr ss:[ebp+0x10]  </div><div class="line">77D50824    FF75 0C         push dword ptr ss:[ebp+0xC]  </div><div class="line">77D50827    FF75 08         push dword ptr ss:[ebp+0x8]  </div><div class="line">77D5082A    E8 2D000000     call user32.MessageBoxExA  </div><div class="line">77D5082F    5D              pop ebp  </div><div class="line">77D50830    C2 1000         retn 0x10</div></pre></td></tr></table></figure></p>
<p>因为没发现关键跳，因此我Ctrl+F9 F8 几层之后，来到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">0048ED10   .  83EC 64       sub esp,64  </div><div class="line">0048ED13   .  56            push esi                                 ;  Dumped_.004613AC  </div><div class="line">0048ED14   .  8B7424 74     mov esi,dword ptr ss:[esp+74]            ;  Dumped_.00580070  </div><div class="line">0048ED18   .  57            push edi  </div><div class="line">0048ED19   .  8B7E 08       mov edi,dword ptr ds:[esi+8]  </div><div class="line">0048ED1C   .  57            push edi  </div><div class="line">0048ED1D   .  E8 0E410100   call Dumped_.004A2E30  </div><div class="line">0048ED22   .  83C4 04       add esp,4  </div><div class="line">0048ED25   .  85C0          test eax,eax  </div><div class="line">0048ED27   .  74 10         je short Dumped_.0048ED39  </div><div class="line">0048ED29   .  8D4424 08     lea eax,dword ptr ss:[esp+8]  </div><div class="line">0048ED2D   .  50            push eax  </div><div class="line">0048ED2E   .  56            push esi                                 ;  Dumped_.004613AC  </div><div class="line">0048ED2F   .  E8 FCE2FFFF   call Dumped_.0048D030  </div><div class="line">0048ED34   .  83C4 08       add esp,8  </div><div class="line">0048ED37   .  EB 42         jmp short Dumped_.0048ED7B  </div><div class="line">0048ED39   &gt;  81FF 04000080 cmp edi,80000004                         ;  Switch (cases 80000002..80000004)  </div><div class="line">0048ED3F      75 04         jnz short Dumped_.0048ED45  </div><div class="line">0048ED41   .  8B0E          mov ecx,dword ptr ds:[esi]               ;  Case 80000004 (SINGLE STEP) of switch 0048ED39  </div><div class="line">0048ED43   .  EB 3A         jmp short Dumped_.0048ED7F  </div><div class="line">0048ED45   &gt;  81FF 02000080 cmp edi,80000002  </div><div class="line">0048ED4B      75 12         jnz short Dumped_.0048ED5F  </div><div class="line">0048ED4D   .  8B16          mov edx,dword ptr ds:[esi]               ;  Case 80000002 (DATATYPE MISALIGNMENT) of switch 0048ED39  </div><div class="line">0048ED4F   .  8D4C24 08     lea ecx,dword ptr ss:[esp+8]  </div><div class="line">0048ED53   .  51            push ecx  </div><div class="line">0048ED54   .  52            push edx</div></pre></td></tr></table></figure>
<p>这里有一个跳是可以跳过messagebox的，可是我试了之后，发现程序跑飞，因此不得不再次找上一级的CALL。。。。<br>根据远CALLF7  近CALL F8的原则  时时刻刻观察OD的几个窗口，真的叫一个目不转睛！<br>跟踪+跟踪+再跟踪！坚持+坚持+再坚持！<br>看到一行疑似注册码的字母，相当兴奋，仔细一分析，原来是磁盘序列号，，接着是各种序列号，MAC，机器注册码，总之走了很久。<br>name和serial终于出现！本来要放弃的我又兴奋起来了，可惜仔细分析之后，并没有明码比较，而是和<a href="http://www.etigou.com/jqm/index.php/index/zhuce/cardid/有关，于是我想" target="_blank" rel="external">http://www.etigou.com/jqm/index.php/index/zhuce/cardid/有关，于是我想</a> 可能是网络验证。<br>fosom师傅之前虽然指点过 要修改几个跳转<br>但是接下来还是让我发现了一个关键跳，只要修改一个 可以实现注册界面上的爆破：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">0040B9F2    33C9            xor ecx,ecx       此时；ecx=0  </div><div class="line">0040B9F4    41              inc ecx  </div><div class="line">0040B9F5    51              push ecx  </div><div class="line">0040B9F6    50              push eax  </div><div class="line">0040B9F7    3BC8            cmp ecx,eax       ；此时ecx=1 eax=0  </div><div class="line">0040B9F9    0F8F 8F020000   jg Dumped_.0040BC8E                      ; 关键跳，跳则死，不跳成功    （但是这个程序跳了之后再次运行到这里的时候必须不跳）</div></pre></td></tr></table></figure></p>
<p>ecx 此处是计注册次数用的<br>爆破1.<br>我先将jg 改成je 发现可以注册成功，但是注册成功的窗口i一直弹出，关了继续弹出。<br>面对这样，我写了个内存注册机，点击注册之前先将jg改成je，弹出框后再将je改成jg，于是就成功提示“注册成功”了。<br>爆破2.<br>我在想，如果可以将eax改成1的话，那么也能实现第一次不跳，之后跳转恢复，实现爆破，可惜字节不够，fosom师傅说用SMC技术，可是我找了一下，CC也很少。。<br>最后我往上找，<br>把0040B9F2    33C9            xor ecx,ecx<br>改成not ecx  让ecx=FFFFFFFF<br>成功实现了爆破<br>爆破3.<br>我继续往上找：<br>想办法让一个寄存器的值=1，我是让EDX=1了<br>然后在0040B9F7    3BC8            cmp ecx,eax<br>这一句上，将eax改成edx 也能实现爆破。</p>
<p>其实我觉得 还有很多方法的，比如说，既然关键跳是0040B9F9    0F8F 8F020000   jg Dumped_.0040BC8E<br>而JG的测试条件是SF=OF且ZF=0，我们是否能找到影响标志位的语句来影响这个跳转呢？</p>
<p><img src="http://img.blog.csdn.net/20150128135059625?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>如图所示：<br>1，在需要改的jne，修改成jmp。<br>2，在所在模块，找9个空字节（连续的CC很多，容易找）。<br>  这样就实现了，运行一次就自动恢复原有代码。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我觉得很不错，今天虽然累了 明天还要实习。但是收获颇多，我会继续努力的！</p>
<p>当然还有点问题，虽然只改了和少部分代码，但是还是有功能失效了，我觉得可以用对比分析来找出失效的原因，再加以改正就能成功。</p>
<p>努力早就实力！态度决定高度！<br>加油~！<br>                                                       2013.6.26.凌晨3点5分 </p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  

  <nav id="pagination">
  
    <a href="/page/2/" class="prev">Prev</a>
  
  
  <div class="clearfix"></div>
</nav>

</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2017 <a href="/">The darkness is no darkness with thee.</a>
  
</div>
<div class="theme-copyright">

</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>

</body>
</html>